(function(N,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue"),require("@vueuse/core"),require("konva"),require("@vue/runtime-core"),require("@fortawesome/vue-fontawesome"),require("@fortawesome/free-solid-svg-icons"),require("@tiptap/vue-3"),require("@tiptap/starter-kit")):typeof define=="function"&&define.amd?define(["exports","vue","@vueuse/core","konva","@vue/runtime-core","@fortawesome/vue-fontawesome","@fortawesome/free-solid-svg-icons","@tiptap/vue-3","@tiptap/starter-kit"],e):(N=typeof globalThis<"u"?globalThis:N||self,e(N.patron={},N.Vue,N.core,N.Konva,N.runtimeCore,N.vueFontawesome,N.freeSolidSvgIcons,N.vue3,N.StarterKit))})(this,function(N,e,z,J,X,as,j,Me,cs){"use strict";var ml=Object.defineProperty;var fl=(N,e,z)=>e in N?ml(N,e,{enumerable:!0,configurable:!0,writable:!0,value:z}):N[e]=z;var b=(N,e,z)=>fl(N,typeof e!="symbol"?e+"":e,z);class ls{constructor(t){t.value(this)}give(t){return document.title=t,this}introduction(){return"patron"}}class je{constructor(t){this.guestReceiver=t}value(t){return this.guestReceiver(t),t}}function Z(i,t,s){typeof t=="function"?t(i,s):t.give(i,s)}class ee{constructor(t){this.receiver=t}give(t,s){return this.receiver(t,s),this}}class ne{constructor(t,s){this.sourceGuest=t,this.targetGuest=s}introduction(){return typeof this.sourceGuest=="function"||!this.sourceGuest.introduction?"guest":this.sourceGuest.introduction()}give(t,s){return Z(t,this.targetGuest,s),this}disposed(t){const s=this.sourceGuest;return s.disposed?s.disposed(t):!1}}var ds=Object.defineProperty,hs=(i,t,s)=>t in i?ds(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,et=(i,t,s)=>hs(i,typeof t!="symbol"?t+"":t,s);const tt=new Map,st=i=>{tt.forEach(t=>{t.delete(i)})};class Ae{constructor(t){this.initiator=t,et(this,"patrons"),et(this,"give"),this.patrons=new Set,tt.set(this,this.patrons);let s=null;const r=(n,o)=>{this.patrons.forEach(a=>{this.sendValueToGuest(n,a,o)})};this.give=(n,o)=>{const a=()=>{a===s&&r(n,o)};return s=a,queueMicrotask(a),this}}size(){return this.patrons.size}add(t){if(!t)throw new Error("PatronPool add method received nothing!");return typeof t!="function"&&t.introduction&&t.introduction()==="patron"&&this.patrons.add(t),this}remove(t){return this.patrons.delete(t),this}distribute(t,s){return this.add(s),this.sendValueToGuest(t,s,{}),this}sendValueToGuest(t,s,r){this.guestDisposed(t,s)||Z(t,s,{...r,data:{...(r==null?void 0:r.data)??{},initiator:this.initiator,pool:this}})}guestDisposed(t,s){var r;return(r=s.disposed)!=null&&r.call(s,t)?(this.remove(s),!0):!1}}var ps=Object.defineProperty,ms=(i,t,s)=>t in i?ps(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,fs=(i,t,s)=>ms(i,t+"",s);class le{constructor(t){this.sourceDocument=t,fs(this,"thePool",new Ae(this))}pool(){return this.thePool}give(t){return this.sourceDocument=t,this.thePool.give(this.sourceDocument),this}value(t){return typeof t=="function"?this.thePool.distribute(this.sourceDocument,new ee(t)):this.thePool.distribute(this.sourceDocument,t),this}}class ye{constructor(t){this.baseGuest=t}give(t,s){let r=this.baseGuest;return typeof r=="function"&&(r=new ee(r)),r.give(t,s),this}introduction(){return typeof this.baseGuest=="function"||!this.baseGuest.introduction?"guest":this.baseGuest.introduction()}disposed(t){const s=this.baseGuest;return s.disposed?s.disposed(t):!1}}var us=Object.defineProperty,gs=(i,t,s)=>t in i?us(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,rt=(i,t,s)=>gs(i,typeof t!="symbol"?t+"":t,s);class As{constructor(t){rt(this,"guests",new Set),rt(this,"patronPool"),this.patronPool=new Ae(t)}give(t,s){return this.deliverToGuests(t,s),this.patronPool.give(t,s),this}add(t){return(typeof t=="function"||!t.introduction||t.introduction()==="guest")&&this.guests.add(t),this.patronPool.add(t),this}remove(t){return this.guests.delete(t),this.patronPool.remove(t),this}distribute(t,s){return this.add(s),this.give(t),this}size(){return this.patronPool.size()+this.guests.size}deliverToGuests(t,s){this.guests.forEach(r=>{Z(t,r,s)}),this.guests.clear()}}var ys=Object.defineProperty,bs=(i,t,s)=>t in i?ys(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,be=(i,t,s)=>bs(i,typeof t!="symbol"?t+"":t,s);class ws{constructor(){be(this,"theChain"),be(this,"keysKnown",new Set),be(this,"keysFilled",new Set),be(this,"filledChainPool",new As(this)),this.theChain=new le({})}resultArray(t){const s=new ye(t);return this.filledChainPool.add(new ne(s,r=>{s.give(Object.values(r))})),this.isChainFilled()&&this.theChain.value(new ee(r=>{this.filledChainPool.give(Object.values(r))})),this}result(t){const s=new ye(t);return this.isChainFilled()?(this.filledChainPool.add(s),this.theChain.value(new ee(r=>{this.filledChainPool.give(r)}))):this.filledChainPool.add(s),this}receiveKey(t){return this.keysKnown.add(t),new ee(s=>{queueMicrotask(()=>{this.theChain.value(new ee(r=>{this.keysFilled.add(t);const n={...r,[t]:s};this.theChain.give(n),this.isChainFilled()&&this.filledChainPool.give(n)}))})})}isChainFilled(){return this.keysFilled.size>0&&this.keysFilled.size===this.keysKnown.size}}class Cs{constructor(t){this.theValue=t}give(t){return this.theValue=t,this}value(){return this.theValue}}class ks{constructor(t){this.willBePatron=t}introduction(){return"patron"}give(t,s){return Z(t,this.willBePatron,s),this}disposed(t){var r;const s=this.willBePatron;return((r=s==null?void 0:s.disposed)==null?void 0:r.call(s,t))||!1}}var xs=Object.defineProperty,_s=(i,t,s)=>t in i?xs(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,Bs=(i,t,s)=>_s(i,t+"",s);class Vs{constructor(t){this.baseGuest=t,Bs(this,"received",!1)}introduction(){return"patron"}give(t,s){this.received||Z(t,this.baseGuest,s);const r=s==null?void 0:s.data;return r!=null&&r.pool&&r.pool.remove(this),this}disposed(t){const s=this.baseGuest;return s.disposed?s.disposed(t):!1}}var Ns=Object.defineProperty,$s=(i,t,s)=>t in i?Ns(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s,Fs=(i,t,s)=>$s(i,t+"",s);class ie{constructor(){Fs(this,"baseSource",new le(null))}value(t){return this.baseSource.value(new ne(t,s=>{s!==null&&Z(s,t)})),this}give(t){return this.baseSource.give(t),this}pool(){return this.baseSource.pool()}}class E{constructor(t,s={}){this.constructorFn=t,this.factories=s}create(...t){return new this.constructorFn(...t,this.factories)}}class de extends Error{constructor(t,s){super(t,s)}}class Es{constructor(t){this.fileHandler=t}content(t){return this.fileHandler.getFile().then(async s=>await new Response(s).text()).then(s=>{t.give(s)}).catch(s=>{throw new de("Problem when reading file in SystemFileFromHandler",{cause:s})}),this}}class Ts{constructor(t){this.fileHandler=t}save(t){return this.fileHandler.createWritable().then(s=>(s.write(t).catch(r=>{throw new de("Cant save file in browser",{cause:r})}),s)).then(s=>{s.close().catch(r=>{throw new de("Cant close written file in browser",{cause:r})})}),this}}class Ss{constructor(t){this.content=t}result(){return JSON.parse(this.content)}}class Ms{constructor(t){this.content=t}result(){return JSON.stringify(this.content)}}class js{constructor(t,s=100,r=100){this.svgContent=t,this.width=s,this.height=r}markup(){return this.svgContent.replaceAll("${width}",String(this.width)).replaceAll("${height}",String(this.height))}}class Os{constructor(t,s){this.type=t,this.factories=s}markup(){return this.factories.svgImage.create(this.type.svg,this.type.width,this.type.height).markup()}}class Ds{constructor(t,s,r){this.chunksCount=t,this.baseNumber=s,this.factories=r}chunks(t){return this.baseNumber.value(this.factories.guestInTheMiddle.create(t,s=>{const r=Math.round(s/this.chunksCount),n=[];for(let o=1;o<=this.chunksCount;o+=1)n.push(o*r);t.give(n)})),t}}class Is{constructor(t,s){this.mapUrl=t,this.factories=s}name(t){this.mapUrl.value(this.factories.guestInTheMiddle.create(t,s=>{let r=s.replace("/","").replaceAll("/","_");r.match("_")&&(r=`_${r}`),t.give(r)}))}}class Ps{constructor(t,s){this.text=t,this.factories=s}noHtml(t){return this.text.value(this.factories.guestInTheMiddle.create(t,s=>{const r=document.createElement("DIV");r.innerHTML=s;const n=r.textContent||r.innerText||"";t.give(n)})),t}}class Rs{constructor(t,s,r,n){b(this,"loadingCache");this.callbackName=t,this.url=s,this.emptyValue=r,this.factories=n,this.loadingCache=n.sourceEmpty.create()}content(t){this.loadingCache.give(!0);const s=setTimeout(()=>{this.loadingCache.give(!1),t.give(this.emptyValue)},1e4);return z.useScriptTag(this.url,()=>{var n;clearInterval(s);const r=((n=window[this.callbackName])==null?void 0:n.call(window))||this.emptyValue;t.give(r),this.loadingCache.give(!1)}),t}loading(t){return this.loadingCache.value(t),t}}class zs{constructor(t){this.text=t}asString(t){return t.give(this.text),t}}class Ls{constructor(t,s){this.baseText=t,this.factories=s}asString(t){return this.baseText.asString(this.factories.guestInTheMiddle.create(t,s=>{t.give((s??"").replace(/<\/?[^>]+>/gi," "))})),t}}var we=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Oe(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var De={exports:{}},Ie,nt;function Hs(){if(nt)return Ie;nt=1;var i=1e3,t=i*60,s=t*60,r=s*24,n=r*7,o=r*365.25;Ie=function(h,l){l=l||{};var p=typeof h;if(p==="string"&&h.length>0)return a(h);if(p==="number"&&isFinite(h))return l.long?d(h):c(h);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(h))};function a(h){if(h=String(h),!(h.length>100)){var l=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(h);if(l){var p=parseFloat(l[1]),g=(l[2]||"ms").toLowerCase();switch(g){case"years":case"year":case"yrs":case"yr":case"y":return p*o;case"weeks":case"week":case"w":return p*n;case"days":case"day":case"d":return p*r;case"hours":case"hour":case"hrs":case"hr":case"h":return p*s;case"minutes":case"minute":case"mins":case"min":case"m":return p*t;case"seconds":case"second":case"secs":case"sec":case"s":return p*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function c(h){var l=Math.abs(h);return l>=r?Math.round(h/r)+"d":l>=s?Math.round(h/s)+"h":l>=t?Math.round(h/t)+"m":l>=i?Math.round(h/i)+"s":h+"ms"}function d(h){var l=Math.abs(h);return l>=r?m(h,l,r,"day"):l>=s?m(h,l,s,"hour"):l>=t?m(h,l,t,"minute"):l>=i?m(h,l,i,"second"):h+" ms"}function m(h,l,p,g){var f=l>=p*1.5;return Math.round(h/p)+" "+g+(f?"s":"")}return Ie}function Us(i){s.debug=s,s.default=s,s.coerce=d,s.disable=o,s.enable=n,s.enabled=a,s.humanize=Hs(),s.destroy=m,Object.keys(i).forEach(h=>{s[h]=i[h]}),s.names=[],s.skips=[],s.formatters={};function t(h){let l=0;for(let p=0;p<h.length;p++)l=(l<<5)-l+h.charCodeAt(p),l|=0;return s.colors[Math.abs(l)%s.colors.length]}s.selectColor=t;function s(h){let l,p=null,g,f;function y(...u){if(!y.enabled)return;const C=y,V=Number(new Date),R=V-(l||V);C.diff=R,C.prev=l,C.curr=V,l=V,u[0]=s.coerce(u[0]),typeof u[0]!="string"&&u.unshift("%O");let O=0;u[0]=u[0].replace(/%([a-zA-Z%])/g,(F,B)=>{if(F==="%%")return"%";O++;const w=s.formatters[B];if(typeof w=="function"){const k=u[O];F=w.call(C,k),u.splice(O,1),O--}return F}),s.formatArgs.call(C,u),(C.log||s.log).apply(C,u)}return y.namespace=h,y.useColors=s.useColors(),y.color=s.selectColor(h),y.extend=r,y.destroy=s.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(g!==s.namespaces&&(g=s.namespaces,f=s.enabled(h)),f),set:u=>{p=u}}),typeof s.init=="function"&&s.init(y),y}function r(h,l){const p=s(this.namespace+(typeof l>"u"?":":l)+h);return p.log=this.log,p}function n(h){s.save(h),s.namespaces=h,s.names=[],s.skips=[];let l;const p=(typeof h=="string"?h:"").split(/[\s,]+/),g=p.length;for(l=0;l<g;l++)p[l]&&(h=p[l].replace(/\*/g,".*?"),h[0]==="-"?s.skips.push(new RegExp("^"+h.slice(1)+"$")):s.names.push(new RegExp("^"+h+"$")))}function o(){const h=[...s.names.map(c),...s.skips.map(c).map(l=>"-"+l)].join(",");return s.enable(""),h}function a(h){if(h[h.length-1]==="*")return!0;let l,p;for(l=0,p=s.skips.length;l<p;l++)if(s.skips[l].test(h))return!1;for(l=0,p=s.names.length;l<p;l++)if(s.names[l].test(h))return!0;return!1}function c(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function d(h){return h instanceof Error?h.stack||h.message:h}function m(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}var Qs=Us;(function(i,t){t.formatArgs=r,t.save=n,t.load=o,t.useColors=s,t.storage=a(),t.destroy=(()=>{let d=!1;return()=>{d||(d=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let d;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(d=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(d[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function r(d){if(d[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+d[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),!this.useColors)return;const m="color: "+this.color;d.splice(1,0,m,"color: inherit");let h=0,l=0;d[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(h++,p==="%c"&&(l=h))}),d.splice(l,0,m)}t.log=console.debug||console.log||(()=>{});function n(d){try{d?t.storage.setItem("debug",d):t.storage.removeItem("debug")}catch{}}function o(){let d;try{d=t.storage.getItem("debug")}catch{}return!d&&typeof process<"u"&&"env"in process&&(d=process.env.DEBUG),d}function a(){try{return localStorage}catch{}}i.exports=Qs(t);const{formatters:c}=i.exports;c.j=function(d){try{return JSON.stringify(d)}catch(m){return"[UnexpectedJSONParseError]: "+m.message}}})(De,De.exports);var x=De.exports;const it=Oe(x),Ks=x.debug("TextNlAsBr");class Gs{constructor(t,s){this.baseText=t,this.factories=s}asString(t){return this.baseText.asString(this.factories.guestInTheMiddle.create(t,s=>{if(typeof s>"u"||s===null)return"";const r="<br />";return Ks(s),t.give((s??"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,`$1${r}$2`)),!0})),t}}const Ws=new E(le),vs=new E(le),qs=new E(ie),Js=new E(ee),Zs=new E(ne),Ys=new E(je),Xs=new E(Ae),er=new E(ks),tr=new E(Vs),sr=new E(ne),rr=new E(ws),nr=new E(Cs),Y={cache:Ws,chain:rr,guest:Js,guestCast:Zs,guestAware:Ys,guestInTheMiddle:sr,guestSync:nr,patron:er,patronOnce:tr,pool:Xs,source:vs,sourceEmpty:qs},ir=new E(Es),or=new E(Ts),ar=new E(Ms),cr=new E(Ss),ot=new E(js),lr=new E(Os,{...Y,svgImage:ot}),dr=new E(Ds,Y),hr=new E(Is,Y),pr=new E(Ps,Y),mr=new E(Rs,Y),fr=new E(zs),ur=new E(Ls,Y),gr=new E(Gs,Y),Ar={...Y,fileHandlerContent:ir,browserFileSaved:or,transformToString:ar,transformToObject:cr,svgImage:ot,svgMapTypeImage:lr,numberChunks:dr,mapNameFromUrl:hr,textNoHtml:pr,jsonp:mr,textOf:fr,textNlAsBr:gr,textWithoutHTML:ur},D=()=>Ar;class Pe{constructor(t,s,r){this.notification=t,this.check=s,this.factories=r}breakOnFail(t,s){return this.check.check(t,this.factories.guest.create(r=>{r===!0?s.give(!0):this.notification.give({type:"error",text:r})})),this}continueOnFail(t,s){return this.check.check(t,this.factories.guest.create(r=>{s.give(r),r!==!0&&this.notification.give({type:"error",text:r})})),this}}const Re=x.debug("MapCurrent");class at{constructor(t,s,r){b(this,"objectsCache");b(this,"settingsCache");b(this,"typesCache");this.mapFile=t,this.mapId=s,this.factories=r,this.objectsCache=r.sourceEmpty.create(),this.settingsCache=r.sourceEmpty.create(),this.typesCache=r.sourceEmpty.create(),t.currentMap(r.patron.create(r.guest.create(n=>{Re("current map changed",n),this.settingsCache.give(n.settings),this.objectsCache.give(Object.values(n.objects)),this.typesCache.give(Object.entries(n.types).map(([o,a])=>({...a,id:o})))})))}settings(t){return this.settingsCache.value(t),t}objects(t){return Re("notify about new objects"),this.objectsCache.value(t),t}types(t){return this.typesCache.value(t),t}give(t){return Re("save map document",t),this.mapId.id(this.factories.guest.create(s=>{this.mapFile.mapFile(this.factories.guest.create(r=>{this.mapFile.give({...r,[s]:t})}))})),this}}class yr{constructor(t){b(this,"idCache");this.idCache=t.cache.create("current")}id(t){return this.idCache.value(t),t}give(t){return this.idCache.give(t),this}}class br{constructor(t){this.mapFile=t}value(t){return this.mapFile.currentMap(new ne(t,s=>{t.give(s.settings.title)})),this}}const Ce=x.debug("MapHistory"),ct=i=>{const t=JSON.parse(JSON.stringify(i));return Object.values(t.objects).forEach(s=>{s.width=0,s.height=0}),JSON.stringify(t)};class wr{constructor(t,s,r,n){b(this,"mapsHistory");b(this,"historyIndex");this.mapFile=t,this.map=s,this.mapId=r,this.factories=n,this.mapsHistory=n.cache.create([]),this.historyIndex=n.cache.create(0),this.mapFile.currentMap(n.patron.create(this)),this.mapId.id(n.patron.create(n.guest.create(()=>{this.mapsHistory.give([]),this.historyIndex.give(0)})))}give(t){return requestIdleCallback(()=>{this.historyIndex.value(this.factories.guest.create(s=>{this.mapsHistory.value(this.factories.guest.create(r=>{Ce("add map to history",r,t);const n=r.some(o=>ct(o)===ct(t));if(Ce("isMapFromHistory",n),!n){const o=r[s]?[r[s]]:[];this.historyIndex.give(0),this.mapsHistory.give([t,...o,...r.slice(0,9)])}}))}))}),this}isPrevPossible(t){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(t,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(t,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(t,({historyIndex:r,mapsHistory:n})=>{const o=r<n.length-1;Ce("recalculate is prev possible",o),t.give(o)})),t}prev(){this.historyIndex.value(this.factories.guest.create(t=>{const s=t+1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(r=>{const n=r[s];this.map.give(n)}))}))}isNextPossible(t){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(t,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(t,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(t,({historyIndex:r,mapsHistory:n})=>{const o=r>0&&r<=n.length-1;Ce("recalculate is next possible",o),t.give(o)})),t}next(){this.historyIndex.value(this.factories.guest.create(t=>{const s=t-1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(r=>{const n=r[s];this.map.give(n)}))}))}}class Cr{constructor(t,s,r){this.mapFile=t,this.mapId=s,this.factories=r}give(t){const{guest:s}=this.factories;return this.mapFile.mapFile(s.create(r=>{delete r[t],this.mapFile.give(r),this.mapId.give("current")})),this}}const ke=x.debug("MapFileOfContent");class kr{constructor(t,s,r){b(this,"currentMapPatrons");b(this,"mapFileCache");this.mapFileContent=t,this.mapId=s,this.factories=r,this.currentMapPatrons=r.pool.create(this),this.mapFileCache=r.cache.create(!1),t.value(r.patron.create(n=>{if(!n)return;const o=this.factories.transformToObject.create(n).result();ke("get map file",o),this.mapFileCache.give(o)}))}currentMap(t){const s=this.factories.chain.create();return this.mapId.id(this.factories.guestCast.create(t,s.receiveKey("mapId"))),this.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({mapId:r,mapFile:n})=>{if(ke("get current map",r,n,typeof n),!n[r])this.createEmptyMapByName(r,t);else{const o=n[r];this.currentMapPatrons.distribute(o!=null&&o.structure?o.structure:o,t)}})),t}give(t){return ke("save map file document",t),this.mapFileContent.give(this.factories.transformToString.create(t).result()),this}mapFile(t){return this.mapFileCache.value(t),t}createEmptyMapByName(t,s){ke("creating empty map by name",t);const r=this.factories.transformToObject.create(this.generateEmptyMapFile()).result();this.mapFile(this.factories.guest.create(n=>{this.give({...n,[t]:r.current}),s.give(r.current)}))}generateEmptyMapFile(){return'{"current":{"progress":0,"settings":{"colored":false,"title":"current"},"objects":{},"types":{},"url":"/current","parent":""}}'}}const xr=x.debug("MapFileForRendering");class _r{constructor(t,s,r){b(this,"mapCache");this.mapId=s,this.factories=r,this.mapCache=r.cache.create({objects:{},types:{},settings:{}}),t.currentMap(r.patron.create(this.mapCache))}currentMap(t){return this.mapCache.value(t),t}mapFile(t){return this.mapCache.value(this.factories.guestInTheMiddle.create(t,s=>{this.mapId.id(this.factories.guest.create(r=>{t.give({[r]:s})}))})),t}give(t){return this.mapId.id(this.factories.guest.create(s=>{xr("received map file, objects = ",t[s].objects),this.mapCache.give(t[s])})),this}}class lt{constructor(t,s,r){this.map=t,this.mapFile=s,this.factories=r}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,objects:{...s.objects,[t.id]:{...t,createTimestamp:t.createTimestamp??Date.now(),changeTimestamp:Date.now()}}})})),this}}const dt=it("app:MapObjectCurrent");class Br{constructor(t,s){b(this,"idCache");b(this,"silenceActivator");this.drawer=t,this.factories=s,this.idCache=s.sourceEmpty.create(),this.silenceActivator=s.source.create(!1),this.idCache.value(s.patron.create(s.guest.create(r=>{r&&t.give("object")})))}silenceOn(t){return this.silenceActivator.give(t),this}silenceOff(){return this.silenceActivator.give(!1),this}objectId(t){return this.idCache.value(t),t}give(t){return dt("new value current object",t),this.silenceActivator.value(this.factories.guest.create(s=>{dt("silence activator",s),s?s.give(t):this.idCache.give(t)})),this}}class Vr{constructor(t,s){this.mapFile=t,this.factories=s}check(t,s){return this.mapFile.currentMap(this.factories.guest.create(r=>{let n=!1;Object.values(r.objects).forEach(o=>{n=n||o.arrows.some(a=>a.id===t.id)}),s.give(!n||"У объекта есть входящие связи!")})),this}}const ze=x.debug("MapObjectNew");class Nr{constructor(t,s,r,n,o){this.map=t,this.mapObject=s,this.canvas=r,this.stagePosition=n,this.factories=o}byTypeName(t,s){return ze("start to add new type",t,s),this.stagePosition.position(this.factories.guest.create(r=>{this.map.types(this.factories.guest.create(n=>{this.canvas.canvas(this.factories.guest.create(o=>{const a=o.getBoundingClientRect(),c=n.find(h=>h.id===t);ze("is type found",c);const d=s.x-a.left,m=s.y-a.top;c&&(ze("add new type"),this.mapObject.give({additionalName:"",arrows:[],description:"",inMenu:!1,lastClick:Date.now(),linked:!1,menuOrder:0,name:"",outlink:"",targetBlank:!1,type:t,width:c.width,height:c.height,zindex:0,id:new Date().getTime().toString(),createTimestamp:Date.now(),changeTimestamp:Date.now(),position:[d>0?d+r.x:0,m>0?m+r.y:0]}))}))}))})),this}}class $r{constructor(t,s){this.mapId=t,this.factories=s}names(t){return this.mapId.id(this.factories.guestInTheMiddle.create(t,s=>{const r=s.split("_").filter(a=>!!a);let n="";const o=r.map(a=>{const c=`${n}${a}`;return n||(n="_"),n+=`${a}_`,c});n="",t.give(o)})),t}}class Fr{constructor(t){this.mapObject=t}give(t){const{arrows:s}=t.object;return s.splice(t.index,1),this.mapObject.give({...t.object,arrows:s}),this}}class Er{constructor(t,s,r,n){this.map=t,this.mapFile=s,this.checks=r,this.factories=n}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((r,n)=>{r.breakOnFail(t,s.receiveKey(String(n)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(r=>{delete r.objects[t.id],this.map.give(r)}))})),this}}const Tr=x.debug("MapObjectsLink");class Sr{constructor(t,s,r,n,o){b(this,"objectIdsCache");this.mapObjectCurrent=t,this.map=s,this.mapObject=r,this.newArrow=n,this.factories=o,this.objectIdsCache=o.cache.create([])}objectIds(t){return this.objectIdsCache.value(t),t}startLink(){this.mapObjectCurrent.give(""),this.objectIdsCache.value(this.factories.guest.create(t=>{if(t.length){this.mapObjectCurrent.silenceOff(),this.objectIdsCache.give([]);return}const s=["first"];this.objectIdsCache.give(s),this.mapObjectCurrent.silenceOn(this.factories.guest.create(r=>{s.push(r),this.objectIdsCache.give([...s]),Tr("object ids",s),s.length===2&&this.map.objects(this.factories.guest.create(n=>{const[,o]=s,a=n.find(c=>c.id===o);a&&this.newArrow.forObject(a)})),s.length===3&&(this.newArrow.dispose(),this.mapObjectCurrent.silenceOff(),this.map.objects(this.factories.guest.create(n=>{const[,o,a]=s,c=n.find(d=>d.id===o);c&&a&&(this.objectIdsCache.give([]),this.mapObject.give({...c,arrows:[...c.arrows,{id:a,label:""}]}))})))}))}))}}function Mr(i){var t=typeof i;return i!=null&&(t=="object"||t=="function")}var Le=Mr,jr=typeof we=="object"&&we&&we.Object===Object&&we,Or=jr,Dr=Or,Ir=typeof self=="object"&&self&&self.Object===Object&&self,Pr=Dr||Ir||Function("return this")(),ht=Pr,Rr=ht,zr=function(){return Rr.Date.now()},Lr=zr,Hr=/\s/;function Ur(i){for(var t=i.length;t--&&Hr.test(i.charAt(t)););return t}var Qr=Ur,Kr=Qr,Gr=/^\s+/;function Wr(i){return i&&i.slice(0,Kr(i)+1).replace(Gr,"")}var vr=Wr,qr=ht,Jr=qr.Symbol,pt=Jr,mt=pt,ft=Object.prototype,Zr=ft.hasOwnProperty,Yr=ft.toString,he=mt?mt.toStringTag:void 0;function Xr(i){var t=Zr.call(i,he),s=i[he];try{i[he]=void 0;var r=!0}catch{}var n=Yr.call(i);return r&&(t?i[he]=s:delete i[he]),n}var en=Xr,tn=Object.prototype,sn=tn.toString;function rn(i){return sn.call(i)}var nn=rn,ut=pt,on=en,an=nn,cn="[object Null]",ln="[object Undefined]",gt=ut?ut.toStringTag:void 0;function dn(i){return i==null?i===void 0?ln:cn:gt&&gt in Object(i)?on(i):an(i)}var hn=dn;function pn(i){return i!=null&&typeof i=="object"}var mn=pn,fn=hn,un=mn,gn="[object Symbol]";function An(i){return typeof i=="symbol"||un(i)&&fn(i)==gn}var yn=An,bn=vr,At=Le,wn=yn,yt=NaN,Cn=/^[-+]0x[0-9a-f]+$/i,kn=/^0b[01]+$/i,xn=/^0o[0-7]+$/i,_n=parseInt;function Bn(i){if(typeof i=="number")return i;if(wn(i))return yt;if(At(i)){var t=typeof i.valueOf=="function"?i.valueOf():i;i=At(t)?t+"":t}if(typeof i!="string")return i===0?i:+i;i=bn(i);var s=kn.test(i);return s||xn.test(i)?_n(i.slice(2),s?2:8):Cn.test(i)?yt:+i}var Vn=Bn,Nn=Le,He=Lr,bt=Vn,$n="Expected a function",Fn=Math.max,En=Math.min;function Tn(i,t,s){var r,n,o,a,c,d,m=0,h=!1,l=!1,p=!0;if(typeof i!="function")throw new TypeError($n);t=bt(t)||0,Nn(s)&&(h=!!s.leading,l="maxWait"in s,o=l?Fn(bt(s.maxWait)||0,t):o,p="trailing"in s?!!s.trailing:p);function g(F){var B=r,w=n;return r=n=void 0,m=F,a=i.apply(w,B),a}function f(F){return m=F,c=setTimeout(C,t),h?g(F):a}function y(F){var B=F-d,w=F-m,k=t-B;return l?En(k,o-w):k}function u(F){var B=F-d,w=F-m;return d===void 0||B>=t||B<0||l&&w>=o}function C(){var F=He();if(u(F))return V(F);c=setTimeout(C,y(F))}function V(F){return c=void 0,p&&r?g(F):(r=n=void 0,a)}function R(){c!==void 0&&clearTimeout(c),m=0,r=d=n=c=void 0}function O(){return c===void 0?a:V(He())}function G(){var F=He(),B=u(F);if(r=arguments,n=this,d=F,B){if(c===void 0)return f(d);if(l)return clearTimeout(c),c=setTimeout(C,t),g(d)}return c===void 0&&(c=setTimeout(C,t)),a}return G.cancel=R,G.flush=O,G}var wt=Tn;const oe=Oe(wt),Sn=i=>{if(i[i.length-1]==="/"){const t=i.split("");return t.splice(t.length-1,1),t.join("")}return i},Mn=oe(i=>{window==null||window.open(i)},200),Ue=x.debug("MapObjectUrl");class jn{constructor(t,s){this.mapId=t,this.factories=s}open(t,s){if(t!=null&&t.linked){const r=t.outlink;t.targetBlank?Mn(r):(Ue("open new map",r),this.factories.mapNameFromUrl.create(this.factories.source.create(r)).name(this.factories.guest.create(o=>{Ue("open map name",r,o),s.give(o)})))}return this}url(t,s){return t.value(this.factories.guestInTheMiddle.create(s,r=>{this.mapId.id(this.factories.guest.create(n=>{const o=n[0]==="_"?n.replaceAll("_","/"):"/current",a=r.name?r.name:r.additionalName?r.additionalName:"";this.factories.textNoHtml.create(this.factories.source.create(a)).noHtml(this.factories.guest.create(c=>{let d=r.outlink?r.outlink:`${o}/${On(c)}`;Ue("link is",d),d=Sn(d),s.give(d)}))}))})),s}}function On(i){return i.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}const Dn=x.debug("ObjectPositionBounds");class In{constructor(t,s){this.stageSize=t,this.factories=s}position(t,s,r){return this.stageSize.value(this.factories.guestInTheMiddle.create(r,n=>{let{x:o,y:a}=s;o<30&&(o=30),a<30&&(a=30);const c=n.width-t.width;o>c&&(o=c);const d=n.height-t.height;a>d&&(a=d),Dn("position",o,a),r.give({x:o,y:a})})),r}}const xe=15;class Pn{constructor(t,s){this.baseRestriction=t,this.factories=s}position(t,s,r){return this.baseRestriction.position(t,s,this.factories.guestInTheMiddle.create(r,n=>{r.give({x:Math.round(n.x/xe)*xe,y:Math.round(n.y/xe)*xe})})),r}}const Ct={x:"width",y:"height"},Qe={x:0,y:1},Rn={positive:1,negative:-1},kt=x.debug("ObjectsOutsideScreen");class zn{constructor(t,s,r,n){this.map=t,this.stageSize=s,this.layer=r,this.factories=n}count(t,s){const r=t.direction==="positive",n=this.factories.chain.create();return this.map.objects(this.factories.guestCast.create(s,n.receiveKey("objects"))),this.layer.layer(this.factories.guestCast.create(s,n.receiveKey("layer"))),this.layer.position(this.factories.guestCast.create(s,n.receiveKey("position"))),n.result(this.factories.guestInTheMiddle.create(s,({objects:o,layer:a,position:c})=>{var l;const d=Rn[t.direction],h=o.sort((p,g)=>p.position[Qe[t.axis]]*d-g.position[Qe[t.axis]]*d).filter(p=>{const g=p.position[Qe[t.axis]]+(r?0:p[Ct[t.axis]]),f=c[t.axis]*-1+(r?a[Ct[t.axis]]():0);return kt("mb nearest points",t.direction,"objectP=",g,"screenP=",f),r?g>f:g<f});kt("nearest",h),s.give({count:h.length,nearestObjectId:((l=h.at(r?-1:0))==null?void 0:l.id)??""})})),s}}class Ln{constructor(t,s,r){this.mapFile=t,this.map=s,this.factories=r}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,settings:t})})),this}}class Hn{constructor(t){b(this,"idCache");this.idCache=t.sourceEmpty.create()}typeId(t){return this.idCache.value(t),t}give(t){return this.idCache.give(t),this}}class Un{constructor(t){this.mapType=t}byName(){const t=String(new Date().getTime());this.mapType.give({name:t,type:{id:t,name:"Новый тип",svg:'<div style="background: lightyellow;border: 1px solid #ccc;">type</div>',width:100,height:40}})}}class Qn{constructor(t,s,r,n){this.map=t,this.mapFile=s,this.checks=r,this.factories=n}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((r,n)=>{r.breakOnFail({name:t.id,type:t},s.receiveKey(String(n)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(r=>{delete r.types[t.id],this.map.give(r)}))})),this}}class Kn{constructor(t,s,r,n){this.map=t,this.mapFile=s,this.checks=r,this.factories=n}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((r,n)=>{r.breakOnFail(t,s.receiveKey(String(n)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(r=>{delete r.types[t.name],this.map.give({...r,types:{...r.types,[t.type.name]:t.type}})}))})),this}}const Gn=x.debug("MapTypeUsed");class Wn{constructor(t,s){this.mapFile=t,this.factories=s}check(t,s){return this.mapFile.currentMap(this.factories.guest.create(r=>{const n=Object.values(r.objects).some(o=>o.type===t.name);Gn("is type used",n),s.give(!n||"Тип карты использован")})),this}}class vn{constructor(t,s){this.mapTypeUsedCheck=t,this.factories=s}check(t,s){return this.mapTypeUsedCheck.check(t,this.factories.guest.create(r=>{r!==!0&&t.name!==t.type.name?s.give("Нельзя изменять имя типа, который использован!"):s.give(!0)})),this}}const xt=x.debug("ParentTypes");class qn{constructor(t,s,r){this.parentNames=t,this.mapFile=s,this.factories=r}types(t){xt("parent types requested");const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(t,s.receiveKey("parentNames"))),this.mapFile.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({parentNames:r,mapFile:n})=>{const o=r.slice(0,-1);xt("parent names",o);const a={};o.map(d=>n[d]).forEach(d=>{Object.values(d.types).forEach(m=>{a[m.name]=m})}),t.give(Object.values(a))})),t}}const _t=x.debug("ObjectsMatchedToQuery");class Jn{constructor(t,s){this.map=t,this.factories=s}objects(t,s){return t.value(this.factories.guestInTheMiddle.create(s,oe(n=>{n=n.toLowerCase(),this.map.objects(this.factories.guest.create(o=>{if(!n){_t("reset results"),s.give([]);return}const a=o.filter(c=>{var d;return c.name.toLowerCase().includes(n)||((d=c.additionalName)==null?void 0:d.toLowerCase().includes(n))||Object.values(c.additionalFields??{}).join(" ").toLowerCase().includes(n)});_t("objects in searching",a,n),s.give(a)}))},500))),s}}const Zn={height:3e3,width:3e3};class Yn{value(t){return t.give(Zn),t}}const Bt=x.debug("StageMoveRestriction");class Xn{constructor(t,s,r){this.canvasDep=t,this.stageSize=s,this.factories=r}position(t,s){return this.canvasDep.canvas(this.factories.guest.create(r=>{this.stageSize.value(this.factories.guest.create(n=>{Bt("income position",t);const o=n.width-r.clientWidth,a=n.height-r.clientHeight,c=t.x*-1,d=t.y*-1;if(a<0||o<0)return{x:0,y:0};Bt("boundings",a,o,d,c),s.give({x:t.x>0?0:c>o?o*-1:t.x,y:t.y>0?0:d>a?a*-1:t.y})}))})),s}}const pe=x.debug("app:MapObjectsVisible");class ei{constructor(t,s,r,n){b(this,"visibleObjectsCache",new ie);pe("constructor initialized");const o=n.chain.create();s.size(n.patron.create(o.receiveKey("size"))),t.position(n.patron.create(o.receiveKey("position"))),r.currentMap(n.patron.create(o.receiveKey("map"))),o.result(n.patron.create(n.guest.create(({position:a,size:c,map:d})=>{const m=Object.values(d.objects);pe("objects come to result",m);const h=m.filter(l=>{const p=d.types[l.type]??{},g={width:l.width||p.width,height:l.height||p.height};return this.isInBounding(a,c,l.position,g)});pe("visible objects calculated",h),this.visibleObjectsCache.give(h)})))}objects(t){return this.visibleObjectsCache.value(t),this}isInBounding(t,s,r,n){const o=t.x,a=t.x-s.width,c=t.y,d=t.y-s.height,[m,h]=r;return pe("bounding vars",o,a,c,d),pe("object position",r),o>-m-n.width&&-m>a&&c>-h-n.height&&-h>d}}const ti=(i,t)=>{const s=i.matchAll(t);return Array.from(s).map(r=>r[1])},si=(i,t)=>i.reduce((s,r)=>(s[r]=t[r]||r,s),{});class ri{constructor(t,s,r,n){this.mapFile=s,this.mapObject=r,this.factories=n,t.objectId(this)}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{const r=s.objects[t];if(!r)return;const n=s.types[r.type],o=/\$\{([a-zA-Z1-9]+)\}/g,c=ti(n.svg,o).filter(d=>d!=="width"&&d!=="height");r.additionalFields=si(c,r.additionalFields??{}),this.mapObject.give(r)})),this}introduction(){return"patron"}}class ni{constructor(){b(this,"filledPoints",new Map)}clear(){this.filledPoints.clear()}breakPoints(t,s,r){const n=this.arrowPointPosition(t.shapeGeometry,t.shapePosition,t.lookToGeometry,t.lookToPosition),o=this.arrowPointPosition(s.shapeGeometry,s.shapePosition,s.lookToGeometry,s.lookToPosition);return r.give([+n.point.x+n.shift.x,+n.point.y+n.shift.y,+n.breakPoint.x+n.shift.x,+n.breakPoint.y+n.shift.y,+o.breakPoint.x+o.shift.x,+o.breakPoint.y+o.shift.y,+o.point.x+o.shift.x,+o.point.y+o.shift.y]),this}arrowPointPosition(t,s,r,n){const o={x:+n.x+Math.round(r.width/2),y:+n.y+Math.round(r.height/2)},a={x:+s.x+Math.round(t.width/2),y:+s.y+Math.round(t.height/2)},c=a.x-o.x,d=a.y-o.y,m=Math.abs(d)>Math.abs(c);let h=+s.x,l=+s.y;const p=m&&d>=0,g=!m&&c>=0,f=m&&d<0,y=!m&&c<0,u={x:0,y:0};let C=0,V=0;p?(h+=Math.round(t.width/2),u.x=h,u.y=(s.y+n.y+r.height)/2,C=n.x>s.x?1:-1):y?(l+=Math.round(t.height/2),h+=+t.width,u.x=(s.x+t.width+n.x)/2,u.y=l,V=n.y>s.y?1:-1):f?(h+=Math.round(t.width/2),l+=+t.height,u.x=h,u.y=(s.y+t.height+n.y)/2,C=n.x>s.x?1:-1):g&&(l+=Math.round(t.height/2),u.x=(s.x+n.x+r.width)/2,u.y=l,V=n.y>s.y?1:-1);const R=[h,l].join("-"),O=this.filledPoints.get(R)||0;return this.filledPoints.set(R,O+1),{point:{x:h,y:l},breakPoint:u,shift:{x:C*O*10,y:V*O*10}}}}var ii=wt,oi=Le,ai="Expected a function";function ci(i,t,s){var r=!0,n=!0;if(typeof i!="function")throw new TypeError(ai);return oi(s)&&(r="leading"in s?!!s.leading:r,n="trailing"in s?!!s.trailing:n),ii(i,t,{leading:r,maxWait:t,trailing:n})}var li=ci;const di=Oe(li),{Arrow:hi}=J,_e=x.debug("MapObjectsArrows");class pi{constructor(t,s,r,n,o){b(this,"previouslyRenderedArrows",new Map);this.konvaLayer=t,this.mapFile=s,this.mapDep=r,this.arrowPath=n,this.factories=o,_e("draw arrows on canvas");const a=this.factories.chain.create();this.konvaLayer.layer(this.factories.patron.create(a.receiveKey("layer"))),this.mapFile.currentMap(this.factories.patron.create(a.receiveKey("map"))),this.mapDep.objects(this.factories.patron.create(a.receiveKey("objects"))),a.result(this.factories.patron.create(this.factories.guest.create(di(({layer:c,map:d,objects:m})=>{const h=(l,p)=>{const g=d.types[p.type];this.arrowPath.breakPoints({shapeGeometry:{width:l.width,height:l.height},shapePosition:{x:l.position[0],y:l.position[1]},lookToGeometry:{width:p.width,height:p.height},lookToPosition:{x:p.position[0],y:p.position[1]}},{shapeGeometry:{width:p.width||g.width,height:p.height||g.height},shapePosition:{x:p.position[0],y:p.position[1]},lookToGeometry:{width:l.width,height:l.height},lookToPosition:{x:l.position[0],y:l.position[1]}},this.factories.guest.create(f=>{const y=f.join("-"),u=[l.id,p.id].join("-");if(_e("points",f),_e(l,p),this.previouslyRenderedArrows.has(u)){const V=this.previouslyRenderedArrows.get(u);V.arrow.show(),V.arrow.points(f);return}const C=new hi({x:0,y:0,points:f,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2});this.previouslyRenderedArrows.set(u,{arrow:C,arrowKey:y}),c.add(C)}))};this.arrowPath.clear(),this.previouslyRenderedArrows.forEach(l=>l.arrow.hide()),m.forEach(l=>{l.arrows&&(_e("visible objects",m.length),l.arrows.forEach(p=>{const g=m.find(f=>f.id===p.id)||d.objects[p.id];g&&h(l,g)}))})},50))))}introduction(){return"patron"}}const{Arrow:mi}=J,Ke=x.debug("NewArrow"),Vt={width:10,height:10};class fi{constructor(t,s,r,n){b(this,"cursorGuest");b(this,"arrowCache");this.konvaLayer=t,this.cursorPosition=s,this.arrowPath=r,this.factories=n,this.cursorGuest=this.factories.sourceEmpty.create(),this.arrowCache=this.factories.sourceEmpty.create()}forObject(t){Ke("start watch cursor"),this.cursorGuest.value(this.factories.guest.create(n=>{st(n)}));let s=null;const r=this.factories.patron.create(this.factories.guest.create(n=>{Ke("cursor moves"),this.konvaLayer.layer(this.factories.guest.create(o=>{Ke("cursor moves in layer"),this.arrowPath.breakPoints({shapeGeometry:{width:t.width,height:t.height},shapePosition:{x:t.position[0],y:t.position[1]},lookToGeometry:Vt,lookToPosition:n},{lookToGeometry:{width:t.width,height:t.height},lookToPosition:{x:t.position[0],y:t.position[1]},shapeGeometry:Vt,shapePosition:n},this.factories.guest.create(a=>{if(s){s.points(a);return}s=new mi({x:0,y:0,points:a,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2}),o.add(s),this.arrowCache.give(s)}))})),this.arrowPath.clear()}));this.cursorPosition.value(r),this.cursorGuest.give(r)}dispose(){this.cursorGuest.value(this.factories.guest.create(t=>{st(t)})),this.arrowCache.value(this.factories.guest.create(t=>{t.remove()}))}}const me=x.debug("MapObjectBackground"),ui="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD//gATQ3JlYXRlZCB3aXRoIEdJTVD/4gKwSUNDX1BST0ZJTEUAAQEAAAKgbGNtcwQwAABtbnRyUkdCIFhZWiAH6AAMAAQADQAqAAthY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1kZXNjAAABIAAAAEBjcHJ0AAABYAAAADZ3dHB0AAABmAAAABRjaGFkAAABrAAAACxyWFlaAAAB2AAAABRiWFlaAAAB7AAAABRnWFlaAAACAAAAABRyVFJDAAACFAAAACBnVFJDAAACFAAAACBiVFJDAAACFAAAACBjaHJtAAACNAAAACRkbW5kAAACWAAAACRkbWRkAAACfAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACQAAAAcAEcASQBNAFAAIABiAHUAaQBsAHQALQBpAG4AIABzAFIARwBCbWx1YwAAAAAAAAABAAAADGVuVVMAAAAaAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA9tYAAQAAAADTLXNmMzIAAAAAAAEMQgAABd7///MlAAAHkwAA/ZD///uh///9ogAAA9wAAMBuWFlaIAAAAAAAAG+gAAA49QAAA5BYWVogAAAAAAAAJJ8AAA+EAAC2xFhZWiAAAAAAAABilwAAt4cAABjZcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPXAABUfAAATM0AAJmaAAAmZwAAD1xtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFBtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEL/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wgARCAAeAB4DAREAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAwUEAAj/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAH1SCMTDaCMTiuCMTDgxDGf/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAMBAgQFExUyMxL/2gAIAQEAAQUCG9TUPHdga2PndgzrxZQ3qah48gsvnUtHILMrKq5f/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAwEBPwEH/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAgEBPwEH/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAECMXIQQUKSsVH/2gAIAQEABj8CFkvdFkVLqzla4v6VLqxXe60WS90WRUipWipCSTvc/8QAIxAAAgADCAMAAAAAAAAAAAAAAAEQUfAhMUGhscHR8RFhcf/aAAgBAQABPyErMkMi0ZW2wylmzHorbYSSX3Vg5wrMkMi0Z0a5FVK8Llg05nRrkRmteVg//9oADAMBAAIAAwAAABCCQQSCSST/xAAUEQEAAAAAAAAAAAAAAAAAAABA/9oACAEDAQE/EAf/xAAUEQEAAAAAAAAAAAAAAAAAAABA/9oACAECAQE/EAf/xAAeEAEAAQQCAwAAAAAAAAAAAAABIRARIDEAQVFxkf/aAAgBAQABPxDEMgTA4U0lpO6EwKiFh/YAyDIEAZSTdCnwUQAma0AtZOl88//Z";class gi{constructor(t,s,r,n){b(this,"mapNameCache");this.konvaLayer=t,this.mapFile=s,this.zIndex=r,this.factories=n,this.mapNameCache=n.cache.create(""),this.mapFile.currentMap(n.patron.create(this))}give(t){return this.konvaLayer.layer(this.factories.patronOnce.create(s=>{me("map received in background",t),this.mapNameCache.value(this.factories.guest.create(r=>{if(r===t.url)return;me("background cache is not equals",r),this.mapNameCache.give(t.url);const n=new Image,o=document.querySelector(".grid-example");me("grid example",o),n.src=ui,n.onload=()=>{me("canvas pattern loaded"),me("konva layer loaded");const a=new J.Rect({width:3e3,height:3e3,x:0,y:0,fillPatternImage:n,zIndex:1});this.zIndex.give(()=>{a.zIndex(0)}),s.add(a)}}))})),this}}const Ai=x.debug("Breadcrumbs");class yi{constructor(t,s,r){this.parentNames=t,this.mapFile=s,this.factories=r}list(t){const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(t,s.receiveKey("names"))),this.mapFile.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({names:r,mapFile:n})=>{Ai("map id",r,n),t.give(r.map(o=>{var a,c;return{title:((c=(a=n[o])==null?void 0:a.settings)==null?void 0:c.title)||"unknown",name:o}}))})),t}}const Nt=x.debug("CursorWithObjects");class bi{constructor(t,s,r){this.objectsVisible=t,this.cursor=s,this.factories=r}value(t){const s=this.factories.chain.create();return this.cursor.value(this.factories.guestCast.create(t,s.receiveKey("cursor"))),this.objectsVisible.objects(this.factories.guestCast.create(t,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(t,({cursor:r,objects:n})=>{const o=n.find(a=>{const c=a.position[0],d=a.position[0]+a.width||100,m=a.position[1],h=a.position[1]+a.height||100;return r.x>=c&&r.x<=d&&r.y>=m&&r.y<=h});o?(Nt("crossed with",o),t.give({x:o.position[0]+o.width/2,y:o.position[1]+o.height/2})):(Nt("cursor pos",r),t.give(r))})),this}}const $t=x.debug("Drawer");class wi{constructor(t,s){b(this,"drawerNameCache");this.keyboard=t,this.factories=s,this.drawerNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(r=>{$t("new key in drawer",r),r==="Escape"&&this.give("")})))}isOpenedByName(t,s){return this.drawerNameCache.value(this.factories.guestInTheMiddle.create(s,r=>{$t("new drawer name",r),s.give(r===t)})),s}openedByName(t){return this.factories.guestAware.create(s=>{this.isOpenedByName(t,s)})}give(t){return this.drawerNameCache.give(t),this}}class Ci{value(t){typeof performance>"u"&&t.give(0);const s=10;let r=performance.now(),n=0;const o=()=>requestAnimationFrame(()=>{if(n+=1,n>=s){const a=performance.now(),c=a-r;t.give(Math.round(1e3/(c/n))),r=a,n=0}o()});return o(),t}}class ki{constructor(t,s){this.mapFile=t,this.factories=s}menuObjects(t){return this.mapFile.currentMap(this.factories.guestInTheMiddle.create(t,s=>{const r=Object.values(s.objects).filter(n=>n.inMenu);t.give(r)})),t}}const Ft=x.debug("app:MiniMap"),Et=130;class xi{constructor(t,s,r,n){b(this,"theSize");b(this,"thePoints");b(this,"viewportSizeCache");this.map=t,this.layer=s,this.stageSize=r,this.factories=n,this.theSize=n.sourceEmpty.create(),this.thePoints=n.sourceEmpty.create(),this.viewportSizeCache=n.sourceEmpty.create();const o=n.chain.create();t.objects(n.patron.create(o.receiveKey("objects"))),s.layer(n.patron.create(o.receiveKey("layer"))),r.value(n.patron.create(o.receiveKey("size"))),o.result(n.patron.create(n.guest.create(({layer:a,size:c,objects:d})=>{const m=Et/c.width,h={width:Math.round(a.width()*m),height:Math.round(a.height()*m)};this.viewportSizeCache.give(h);const l={width:Math.round(c.width*m),height:Math.round(c.height*m)};this.theSize.give(l);const p=d.map(g=>({id:g.id,x:Math.round(g.position[0]*m),y:Math.round(g.position[1]*m),width:Math.round(g.width*m),height:Math.round(g.height*m)}));Ft("minimap points",p),this.thePoints.give(p)})))}viewportPosition(t){const s=this.factories.chain.create();return this.stageSize.value(this.factories.guestCast.create(t,s.receiveKey("size"))),this.layer.position(this.factories.guestCast.create(t,s.receiveKey("position"))),s.result(this.factories.guestInTheMiddle.create(t,({size:r,position:n})=>{const o=Et/r.width,a={x:n.x*o*-1,y:n.y*o*-1};Ft("scaled position is",a),t.give(a)})),t}viewportSize(t){return this.viewportSizeCache.value(t),t}size(t){return this.theSize.value(t),t}points(t){return this.thePoints.value(t),t}}const Tt=x.debug("Modal");class _i{constructor(t,s){b(this,"modalNameCache");this.keyboard=t,this.factories=s,Tt("modal created"),this.modalNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(r=>{Tt("new key in modal",r),r==="Escape"&&this.give("")})))}isOpenedByName(t,s){return this.modalNameCache.value(this.factories.guestInTheMiddle.create(s,r=>{s.give(r===t)})),s}openedByName(t){return this.factories.guestAware.create(s=>{this.isOpenedByName(t,s)})}give(t){return this.modalNameCache.give(t),this}}class Bi{constructor(t){b(this,"messageCache");b(this,"notificationLifetimeDelay",3500);b(this,"lastTimerHead",null);this.messageCache=t.sourceEmpty.create()}message(t){return this.messageCache.value(t),t}give(t){return this.messageCache.give(t),this.lastTimerHead&&clearTimeout(this.lastTimerHead),this.lastTimerHead=setTimeout(()=>{this.messageCache.give({type:"success",text:"hide"})},this.notificationLifetimeDelay),this}}const fe=x.debug("ObjectGeometryFix");class Vi{constructor(t,s,r,n){b(this,"innerReceive");this.mapFile=s,this.map=r,this.factories=n,t.objects(n.patron.create(this)),this.innerReceive=oe(o=>{this.mapFile.currentMap(this.factories.guest.create(a=>{fe("objects to fix",o);const c=document.querySelectorAll(".objects-container .rendered-object"),d=a.objects;let m=!1;c.forEach(h=>{const l=h.getAttribute("data-object-id");if(fe("i see id",l),!l)return;const p=d[l];if(p&&(fe("dom object geometry",h.clientWidth,h.clientHeight),fe("saved object geometry",p.width,p.height),(p.width!==h.clientWidth||p.height!==h.clientHeight)&&(m=!0,fe("update object geometry"),p.width=h.clientWidth,p.height=h.clientHeight),!p.width||!p.height)){const g=a.types[p.type];p.width=g.width,p.height=g.height}}),m&&this.map.give({...a,objects:d})}))},500)}give(t){return this.innerReceive(t),this}}const ue=x.debug("MapObjectsRectsPatron");class Ni{constructor(t,s,r,n,o,a,c,d,m){b(this,"previouslyRenderedRects",new Map);this.konvaLayer=t,this.mapFile=s,this.mapObject=r,this.mapObjectCurrent=o,this.mapObjectForRendering=a,this.objectPosition=c,this.settings=d,this.factories=m,n.objects(this)}give(t){return this.konvaLayer.layer(this.factories.patronOnce.create(this.factories.guest.create(s=>{const r=this.factories.chain.create();this.mapFile.currentMap(r.receiveKey("map")),this.settings.value(r.receiveKey("settings")),r.result(this.factories.guest.create(n=>{const{map:o,settings:a}=n;ue("rerender object rects"),this.previouslyRenderedRects.forEach(c=>{c.hide()}),t.forEach(c=>{const d=o.types[c.type],m=+c.width||+d.width||100,h=+c.height||+d.height||100;if(this.previouslyRenderedRects.has(c)){const p=this.previouslyRenderedRects.get(c);p.width(m),p.height(h),p.x(+c.position[0]),p.y(+c.position[1]),p.show();return}ue("rect object",c,d);const l=new J.Rect({x:+c.position[0],y:+c.position[1],width:m,height:h,name:c.id,draggable:!a.readonly,objectId:c.id,zIndex:3});this.previouslyRenderedRects.set(c,l),s.add(l),l.on("mouseenter",()=>{s.getStage().container().style.cursor="pointer"}),l.on("mouseleave",()=>{s.getStage().container().style.cursor="default"}),l.on("dragend",()=>{ue("drag ended"),this.objectPosition.position(c,{x:l.x(),y:l.y()},this.factories.guest.create(p=>{this.mapObject.give({...c,position:[p.x,p.y]})}))}),l.on("dragmove",()=>{ue("dragmove works",l.x(),l.y()),s.getStage().container().style.cursor="move",this.objectPosition.position(c,{x:l.x(),y:l.y()},this.factories.guest.create(p=>{this.mapObjectForRendering.give({...c,position:[p.x,p.y]})}))}),l.on("click",()=>{ue("object clicked with id",c.id),this.mapObjectCurrent.give(c.id)})})}))}))),this}introduction(){return"patron"}}class $i{constructor(t,s,r,n){this.canvas=s,this.konvaLayer=r,this.factories=n,t.currentMap(this)}give(){const t=new ResizeObserver(r=>{requestAnimationFrame(()=>{const[n]=r;this.canvas.canvas(this.factories.guest.create(o=>{const a=o.getBoundingClientRect();this.konvaLayer.layer(this.factories.guest.create(c=>{c.getStage().width(n.contentRect.width-a.left),c.getStage().height(n.contentRect.height-a.top),this.canvas.give(o),this.konvaLayer.give(c)}))}))})}),s=document.querySelector("body");return s&&t.observe(s),this}}const Fi=x.debug("StagePosition");class Ei{constructor(t){this.stageMove=t}give(t){return Fi("received position",t),this.stageMove.move(t),this}}class Ti{constructor(t,s){this.stageMove=t,this.factories=s}move(t,s){return t.value(this.factories.guest.create(r=>{this.stageMove.move(r.objects[s])})),this}}const St=x.debug("Zindex");class Si{constructor(t){b(this,"fnsCache");this.factories=t,this.fnsCache=t.cache.create([]),this.fnsCache.value(t.patron.create(t.guest.create(oe(s=>{St("zindex fns run"),s.forEach(r=>r())},50))))}give(t){return St("zindex received value"),this.fnsCache.value(this.factories.guest.create(s=>{this.fnsCache.give(s.concat(t))})),this}}const Mt=x.debug("app:BrowserCanvas");class Mi{constructor(t){b(this,"canvasCache");this.factories=t,this.canvasCache=t.sourceEmpty.create()}canvas(t){return this.canvasCache.value(t),this}size(t){return this.canvasCache.value(this.factories.guestInTheMiddle.create(t,s=>{const r=s.width||s.clientWidth,n=s.height||s.clientHeight;Mt("canvas size",r,n),t.give({height:n,width:r})})),this}give(t){return Mt("receive new canvas",t),this.canvasCache.give(t),this}}const ji=x.debug("Cursor");class Oi{constructor(t,s){b(this,"cursorPool");this.cursorPool=s.pool.create(this);const r={x:0,y:0};window==null||window.addEventListener("mousemove",n=>{const o={x:n.offsetX+-r.x,y:n.offsetY+-r.y};ji("move cursor fired",o),this.cursorPool.give(o)}),t.position(s.patron.create(s.guest.create(n=>{r.x=n.x,r.y=n.y})))}value(t){return this.cursorPool.add(t),this}}class Di{constructor(t){this.el=t,t.value(this)}give(t){return t.addEventListener("dragstart",s=>{const r=s.target;if(!r)return;const n=r.cloneNode(!0);n.style.transform="translate(0,0)",n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.zIndex="999",s.dataTransfer&&s.dataTransfer.setDragImage(n,0,0),document.body.append(n);const o=a=>{n.style.transform=`translate(${a.clientX}px, ${a.clientY}px)`};r.addEventListener("drag",o,{passive:!0}),r.addEventListener("dragend",()=>{n.removeEventListener("drag",o),n.remove()})}),this}introduction(){return"patron"}}const Be=x.debug("ControlCombo");class Ii{constructor(t,s){this.keyboard=t,this.factories=s}happened(t,s){this.keyboard.event(this.factories.guestInTheMiddle.create(s,r=>{Be("combo happened look for key",t,"received",r.code),r.ctrlKey&&r.code===t&&r.type==="keydown"&&(r.preventDefault(),s.give(r))}))}happenedConditional(t,s,r){Be("combo control happened registration"),this.keyboard.event(this.factories.guestInTheMiddle.create(r,n=>{Be("keyboard event come"),s.value(this.factories.guest.create(o=>{Be("combo happened look for key",t,"received",n.code),o&&n.ctrlKey&&n.code===t&&n.type==="keydown"&&(n.preventDefault(),r.give(n))}))}))}}const ge=x.debug("Keyboard");class Pi{constructor(t){b(this,"pressedPool");b(this,"combinationsPool");ge("keyboard created"),this.pressedPool=t.pool.create(this),this.combinationsPool=t.pool.create(this),window==null||window.addEventListener("keyup",s=>{ge("keyboard pressed",s.key),this.pressedPool.give(s.key)}),z.useMagicKeys({passive:!1,onEventFired:s=>{ge("magic combination happens 11",s.ctrlKey,s.key),this.combinationsPool.give(s)}})}pressed(t){return ge("keyboard receive pressed subscriber"),this.pressedPool.add(t),this}event(t){return ge("keyboard receive combination subscriber"),this.combinationsPool.add(t),this}}const jt=x.debug("app:konva:KonvaLayer");class Ri{constructor(t,s,r,n){b(this,"guestChain");b(this,"positionCache");b(this,"layerCache");this.canvasDep=t,this.stageMoveRestriction=r,this.factories=n,this.positionCache=n.cache.create({x:0,y:0}),this.guestChain=n.chain.create(),this.layerCache=n.sourceEmpty.create(),this.canvasDep.canvas(n.patron.create(this.guestChain.receiveKey("canvas"))),s.value(this.guestChain.receiveKey("stageSize")),this.guestChain.result(n.guest.create(({canvas:o})=>{jt("create new konva stage");const a=new J.Stage({width:o.clientWidth,height:o.clientHeight,container:o,fill:"#ffeeee",draggable:!0}),c=new J.Layer;a.add(c),c.draw(),this.layerCache.give(c),a.on("dragend",m=>{if(!(m.target instanceof J.Stage))return;const h={x:a.x(),y:a.y()};jt("new position",h),this.positionCache.give(h)}),a.on("dragmove",m=>{if(!(m.target instanceof J.Stage))return;const h={x:a.x(),y:a.y()};this.positionCache.give(h)});const d=this.factories.guestSync.create({x:0,y:0});a.dragBoundFunc(m=>(r.position(m,d),d.value()))}))}layer(t){return this.layerCache.value(t),t}position(t){return this.positionCache.value(t),t}give(t){this.layerCache.give(t);const s=t.getStage();return this.positionCache.give({x:s.x(),y:s.y()}),this}}class zi{constructor(t,s){this.konvaLayer=t,this.factories=s}position(t){return this.konvaLayer.position(this.factories.guestInTheMiddle.create(t,s=>{t.give({x:s.x*-1,y:s.y*-1})})),t}}const Li=x.debug("position");class Hi{constructor(t,s,r,n,o){this.layer=t,this.canvas=s,this.stageSize=r,this.stageMoveRestriction=n,this.factories=o}move(t){Li("move stage to new point",t.position),this.stageSize.value(this.factories.guest.create(()=>{this.canvas.size(this.factories.guest.create(s=>{this.layer.layer(this.factories.guest.create(r=>{const[n,o]=t.position,a={x:-n-Math.round(t.width/2)+Math.round(s.width/2),y:-o-Math.round(t.height/2)+Math.round(s.height/2)};this.stageMoveRestriction.position(a,this.factories.guest.create(c=>{r.getStage().position(c),setTimeout(()=>{this.layer.give(r)})}))}))}))}))}}const A=D(),Ve=new Pi(A),Ot=new le({readonly:!1,presets:{}}),Ui=new _i(Ve,A),Dt=new wi(Ve,A),Ne=new Bi(A),v=new yr(A),It=A.sourceEmpty.create(),T=new kr(It,v,A),Qi=new br(T),Ki=new ls(Qi),Ge=new _r(T,v,A),We=new at(Ge,v,A),Gi=new lt(We,Ge,A),L=new at(T,v,A),Wi=new je(i=>{T.currentMap(new ye(i))}),$e=new Br(Dt,A),vi=new Hn(A),qi=new Ln(T,L,A),te=new Mi(A),se=new Yn,Pt=new Xn(te,se,A),H=new Ri(te,se,Pt,A),Ji=new Si(A),Zi=new gi(H,T,Ji,A),ae=new lt(L,T,A),Yi=new Er(L,T,[new Pe(Ne,new Vr(T,A),A)],A),Xi=new zi(H,A),eo=new Nr(L,ae,te,Xi,A),Rt=new Wn(T,A),zt=new Kn(L,T,[new Pe(Ne,new vn(Rt,A),A)],A),to=new Qn(L,T,[new Pe(Ne,Rt,A)],A),so=new Un(zt),Fe=new ei(H,te,Ge,A),ro=new Vi(Fe,T,L,A),no=new Ni(H,T,ae,Fe,$e,Gi,new Pn(new In(se,A),A),Ot,A),io=new Oi(H,A),oo=new bi(Fe,io,A),Lt=new ni,Ht=new fi(H,oo,Lt,A),ao=new pi(H,T,We,Lt,A),co=new xi(We,H,se,A),lo=new Sr($e,L,ae,Ht,A),ho=new $i(T,te,H,A),po=new ri($e,T,ae,A),mo=new Cr(T,v,A),fo=new Fr(ae),uo=new Ci,ve=new $r(v,A),go=new yi(ve,T,A),Ao=new jn(v,A),yo=new qn(ve,T,A),bo=new Ii(Ve,A),wo=new ki(T,A),Ut=new Hi(H,te,se,Pt,A),Co=new Ei(Ut),ko=new Ti(Ut,A),xo=new Jn(L,A),_o=new wr(T,L,v,A),Bo=new zn(L,se,H,A),Qt=new ie;new Di(Qt);const Vo={mapCurrentID:v,mapFile:T,mapCurrent:L,mapCurrentSource:Wi,mapRemoved:mo,mapSettings:qi,mapObject:ae,mapObjectRemoved:Yi,mapType:zt,mapTypeRemoved:to,mapTypeNew:so,mapObjectsVisible:Fe,mapObjectCurrent:$e,mapObjectNew:eo,mapObjectsLink:lo,mapTypeCurrent:vi,mapRects:no,mapBackground:Zi,mapObjectArrows:ao,mapObjectsGeometryFix:ro,canvas:te,miniMap:co,notification:Ne,modal:Ui,drawer:Dt,konvaLayer:H,resizing:ho,objectAdditionalFieldsFix:po,mapObjectRelationRemoved:fo,fps:uo,breadcrumbs:go,mapObjectUrl:Ao,keyboard:Ve,parentNames:ve,parentTypes:yo,controlCombo:bo,menu:wo,stagePosition:Co,stagePositionByObjectId:ko,objectsMatchedToQuery:xo,stageSize:se,mapHistory:_o,fileContent:It,newArrow:Ht,objectsOutsideScreen:Bo,settings:Ot,documentTitle:Ki,sidebarDraggable:Qt},M=()=>Vo;class _{constructor(t=void 0){b(this,"innerRef");this.innerRef=e.ref(t)}get value(){return this.innerRef.value}ref(){return this.innerRef}give(t){return this.innerRef.value=t,this}introduction(){return"patron"}}const No={key:0},$o={class:"flex-grow overflow-y-auto"},Fo={key:1,class:"flex gap-1"},qe=e.defineComponent({__name:"BaseDrawer",props:{name:{type:String,required:!0},direction:{type:String,default:"ltr",validator:i=>["ltr","rtl","ttb","btt"].includes(i)}},emits:["close"],setup(i,{emit:t}){const s=i,r=t,n=X.computed(()=>["e2e-drawer-back absolute z-10 top-0 left-0 w-full h-full bg-black/50"]),o={ltr:"top-0 left-0 w-[50%] max-w-[900px] ",rtl:"top-0 right-0 w-[50%] max-w-[900px] ",ttb:"top-0 right-0 left-0",btt:"top-auto h-[900px] max-h-[50%] bottom-0 right-0 left-0"},{drawer:a}=M(),c=()=>{a.give(""),r("close")},d=a.isOpenedByName(s.name,new _).ref();return(m,h)=>(e.openBlock(),e.createBlock(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.unref(d)?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(e.unref(n)),onClick:c},[e.createElementVNode("div",{class:e.normalizeClass(["absolute bg-white h-full p-3 flex flex-col overflow-hidden",o[i.direction]]),onClick:h[0]||(h[0]=e.withModifiers(()=>{},["stop"]))},[m.$slots.header?(e.openBlock(),e.createElementBlock("div",No,[e.renderSlot(m.$slots,"header",{class:"BaseDrawer-Header"})])):e.createCommentVNode("",!0),e.createElementVNode("div",$o,[e.renderSlot(m.$slots,"default")]),m.$slots.footer?(e.openBlock(),e.createElementBlock("div",Fo,[e.renderSlot(m.$slots,"footer")])):e.createCommentVNode("",!0)],2)],2)):e.createCommentVNode("",!0)]),_:3}))}}),I=e.defineComponent({__name:"BaseIcon",props:{icon:{type:String}},setup(i){const t={"fa-bars":j.faBars,"fa-text-width":j.faTextWidth,"fa-search":j.faSearch,"fa-history":j.faHistory,"fa-plus-square":j.faPlusSquare,"fa-cog":j.faCog,"fa-file-text":j.faFileText,"fa-rotate-left":j.faRotateLeft,"fa-rotate-right":j.faRotateRight,"fa-map":j.faMap,"fa-close":j.faClose,"fa-arrow-left":j.faArrowLeft,"fa-arrow-right":j.faArrowRight,"fa-arrow-down":j.faArrowDown,"fa-arrow-up":j.faArrowUp};return(s,r)=>(e.openBlock(),e.createBlock(e.unref(as.FontAwesomeIcon),{icon:t[i.icon]},null,8,["icon"]))}}),Eo=e.createElementVNode("h2",{class:"text-lg font-bold"}," Карты в файле ",-1),To=["onClick"],So=e.defineComponent({__name:"AppFileMaps",setup(i){const{mapFile:t,mapCurrentID:s,drawer:r,mapRemoved:n}=M(),o=t.mapFile(new _).ref(),a=s.id(new _).ref(),c=d=>{confirm("Вы уверены?")&&n.give(d)};return(d,m)=>(e.openBlock(),e.createBlock(qe,{direction:"rtl",name:"fileMaps"},{header:e.withCtx(()=>[Eo]),default:e.withCtx(()=>[e.createElementVNode("div",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(o),(h,l)=>(e.openBlock(),e.createElementBlock("div",{key:l,class:"flex items-center gap-2"},[e.createElementVNode("a",{href:"#",class:e.normalizeClass({"font-bold":e.unref(a)===l}),onClick:e.withModifiers(p=>{e.unref(s).give(l),e.unref(r).give("")},["prevent"])},e.toDisplayString(h.settings.title),11,To),e.createVNode(I,{onClick:p=>c(l),class:"text-danger-second cursor-pointer",title:"Удалить карту",icon:"fa-close"},null,8,["onClick"])]))),128))])]),_:1}))}}),Mo={class:"AppMenuObject"},jo={key:0,class:"AppMenuObject-Empty"},Oo={key:1,class:"flex flex-col gap-1"},Do=["onClick"],Io=["innerHTML"],Po=e.defineComponent({__name:"AppMenuObject",setup(i){const{controlCombo:t,drawer:s,menu:r,stagePosition:n}=M(),{guest:o,patron:a}=D(),c=r.menuObjects(new _).ref();return t.happened("KeyM",a.create(o.create(()=>{s.give("menu")}))),(d,m)=>(e.openBlock(),e.createBlock(qe,{direction:"rtl",name:"menu"},{default:e.withCtx(()=>[e.createElementVNode("div",Mo,[e.unref(c).length?(e.openBlock(),e.createElementBlock("div",Oo,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(c),h=>(e.openBlock(),e.createElementBlock("a",{key:h.id,class:"AppMenuObject-Item",href:"#",onClick:e.withModifiers(l=>{e.unref(n).give(h),e.unref(s).give("")},["prevent"])},[e.createElementVNode("span",{innerHTML:h.additionalName?h.additionalName:h.name},null,8,Io)],8,Do))),128))])):(e.openBlock(),e.createElementBlock("div",jo,e.toDisplayString(d.$t("appMenuObject.noItems")),1))])]),_:1}))}}),$=e.defineComponent({__name:"BaseButton",props:{size:{type:String,default:"md",validator:i=>["sm","md","lg"].includes(i)},type:{type:String,default:"standard"}},setup(i){const t=i,s=["rounded-main",`text-${t.size}`,`p-${t.size}`,`bg-${t.type} hover:bg-${t.type}-second`];return s.push(""),(r,n)=>(e.openBlock(),e.createElementBlock("button",{type:"button",class:e.normalizeClass(s)},[e.renderSlot(r.$slots,"default")]))}}),Ro={key:0,title:"Назад",class:"absolute text-white left-0 top-0 -ml-5 flex justify-center items-center bg-primary/70 hover:bg-primary-second/70 cursor-pointer w-5"},zo={key:1,class:"BaseModal-Header"},Lo={class:"overflow-y-auto flex-grow"},Ho={key:2,class:"BaseModal-Footer"},re=e.defineComponent({__name:"BaseModal",props:{name:{type:String,required:!0}},setup(i){const{modal:t}=M(),s=i,r=t.isOpenedByName(s.name,new _).ref(),n=[],o=()=>{t.give("")};return(a,c)=>(e.openBlock(),e.createBlock(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.unref(r)?(e.openBlock(),e.createElementBlock("div",{key:0,class:"absolute rounded-main overflow-y-auto flex justify-center items-center top-0 left-0 bg-black/10 z-20 h-full w-full",onClick:o},[e.createElementVNode("div",{class:"w-full relative flex flex-col max-w-[800px] max-h-[90%] bg-white p-3",onClick:c[0]||(c[0]=e.withModifiers(()=>{},["stop"]))},[n.length>1?(e.openBlock(),e.createElementBlock("div",Ro," < ")):e.createCommentVNode("",!0),e.createElementVNode("div",{title:"Закрыть",class:"e2e-modal-close absolute text-white right-0 top-0 -mr-5 flex justify-center items-center bg-danger/70 hover:bg-danger-second/70 cursor-pointer w-5",onClick:o}," × "),a.$slots.header?(e.openBlock(),e.createElementBlock("div",zo,[e.renderSlot(a.$slots,"header")])):e.createCommentVNode("",!0),e.createElementVNode("div",Lo,[e.renderSlot(a.$slots,"default")]),a.$slots.footer?(e.openBlock(),e.createElementBlock("div",Ho,[e.renderSlot(a.$slots,"footer")])):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0)]),_:3}))}}),Uo={class:"AppPresets"},Qo=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Общие",-1),Ko={class:"flex flex-col gap-2"},Go={class:"text-md font-bold mb-1"},Wo={class:"flex gap-2 flex-wrap items-end"},vo={class:"AppTypesParent-ItemTitle"},qo=["innerHTML"],Jo=e.defineComponent({__name:"AppPresets",setup(i){const{svgMapTypeImage:t}=D(),{mapType:s,settings:r}=M(),n=new _;r.value(n);const o=X.computed(()=>Object.fromEntries(Object.entries(n.value.presets).map(([a,c])=>[a,c.map(d=>({preset:d,image:t.create(d).markup()}))])));return(a,c)=>(e.openBlock(),e.createBlock(re,{name:"presets"},{default:e.withCtx(()=>[e.createElementVNode("div",Uo,[Qo,e.createElementVNode("div",Ko,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(o),(d,m)=>(e.openBlock(),e.createElementBlock("div",{key:m},[e.createElementVNode("h3",Go,e.toDisplayString(m),1),e.createElementVNode("div",Wo,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(d,h=>(e.openBlock(),e.createElementBlock("div",{key:h.preset.name,class:"flex flex-col gap-2"},[e.createElementVNode("div",vo,e.toDisplayString(h.preset.name),1),e.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:h.image,style:e.normalizeStyle(`width:${h.preset.width}px;height:${h.preset.height}px`)},null,12,qo),e.createVNode($,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:l=>e.unref(s).give({name:h.preset.name,type:h.preset})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])]))),128))])])]),_:1}))}}),K=e.defineComponent({__name:"BaseInput",props:{modelValue:{type:[String,Number],default:""},autofocus:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,n=e.ref(null);e.watch(n,oe(()=>{s.autofocus&&n.value.focus()},500));const o=z.useVModel(s,"modelValue",r);return(a,c)=>e.withDirectives((e.openBlock(),e.createElementBlock("input",{ref_key:"input",ref:n,"onUpdate:modelValue":c[0]||(c[0]=d=>e.isRef(o)?o.value=d:null),class:"block rounded-main w-full p-2 border border-solid border-body-dark",type:"text"},null,512)),[[e.vModelText,e.unref(o)]])}});class Je{constructor(t){b(this,"pool",new Ae(this));this.refSource=t,X.watch(t,s=>{s!==void 0&&this.pool.give(s)},{deep:!0})}value(t){return this.refSource.value&&t.give(this.refSource.value),this.pool.add(t),this}}const Zo={class:"AppSearch"},Yo={key:0,class:"AppSearch-Items"},Xo=["onClick"],ea=["innerHTML"],ta=["innerHTML"],sa=["innerHTML"],ra={key:1},na={key:2},ia=e.defineComponent({__name:"AppSearch",setup(i){const{objectsMatchedToQuery:t,controlCombo:s,modal:r,stagePosition:n}=M(),{guest:o,patron:a}=D(),c=X.ref(),d=x.debug("app:AppSearch");r.isOpenedByName("search",a.create(o.create(l=>{setTimeout(()=>{l&&c.value&&(d("search is opened",l),c.value.$el.focus())},500)})));const m=X.ref(""),h=t.objects(new Je(m),new _([])).ref();return s.happened("KeyF",a.create(o.create(()=>{r.give("search")}))),(l,p)=>(e.openBlock(),e.createBlock(re,{name:"search"},{default:e.withCtx(()=>[e.createElementVNode("div",Zo,[e.createVNode(K,{ref_key:"inputRef",ref:c,modelValue:e.unref(m),"onUpdate:modelValue":p[0]||(p[0]=g=>e.isRef(m)?m.value=g:null),class:"mb-2 e2e-query-input",placeholder:l.$t("general.specifyQuery")},null,8,["modelValue","placeholder"]),e.unref(h).length?(e.openBlock(),e.createElementBlock("div",Yo,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(h),g=>(e.openBlock(),e.createElementBlock("div",{key:g.name,class:"cursor-pointer",onClick:e.withModifiers(f=>{e.unref(n).give(g),e.unref(r).give("")},["prevent"])},[e.createElementVNode("b",{class:"AppSearch-ItemName",innerHTML:g.name},null,8,ea),g.additionalName?(e.openBlock(),e.createElementBlock("b",{key:0,class:"AppSearch-ItemName",innerHTML:g.additionalName},null,8,ta)):e.createCommentVNode("",!0),g.additionalFields?(e.openBlock(),e.createElementBlock("div",{key:1,innerHTML:Object.values(g.additionalFields).join(" ")},null,8,sa)):e.createCommentVNode("",!0)],8,Xo))),128))])):e.unref(m)?(e.openBlock(),e.createElementBlock("div",ra,e.toDisplayString(l.$t("general.noResults")),1)):(e.openBlock(),e.createElementBlock("div",na,e.toDisplayString(l.$t("general.resultsWillBeHere")),1))])]),_:1}))}}),oa={class:"AppTypes"},aa=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Родительские типы",-1),ca={class:"flex gap-2 items-end"},la={class:"AppTypesParent-ItemTitle"},da=["innerHTML"],ha=e.defineComponent({__name:"AppTypesParent",setup(i){const{parentTypes:t,mapType:s}=M(),{svgMapTypeImage:r}=D(),n=t.types(new _).ref(),o=X.computed(()=>{var a;return(a=n.value)==null?void 0:a.map(c=>({type:c,image:r.create(c).markup()})).sort((c,d)=>+(c.type.name>=d.type.name))});return(a,c)=>(e.openBlock(),e.createBlock(re,{name:"parentTypes"},{default:e.withCtx(()=>[e.createElementVNode("div",oa,[aa,e.createElementVNode("div",ca,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(o),d=>(e.openBlock(),e.createElementBlock("div",{key:d.type.name,class:"flex flex-col gap-2"},[e.createElementVNode("div",la,e.toDisplayString(d.type.name),1),e.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:d.image,style:e.normalizeStyle(`width:${d.type.width}px;height:${d.type.height}px`)},null,12,da),e.createVNode($,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:m=>e.unref(s).give({name:d.type.name,type:d.type})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])])]),_:1}))}});class Kt{constructor(t,s=void 0){b(this,"innerRef");this.executor=t,this.innerRef=e.ref(s)}ref(){return this.executor(this.innerRef),this.innerRef}}const pa={class:"flex gap-2"},Ze=e.defineComponent({__name:"BaseCheckbox",props:{modelValue:{type:Boolean},label:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,n=z.useVModel(s,"modelValue",r);return(o,a)=>(e.openBlock(),e.createElementBlock("label",pa,[e.withDirectives(e.createElementVNode("input",{"onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(n)?n.value=c:null),type:"checkbox"},null,512),[[e.vModelCheckbox,e.unref(n)]]),o.$slots.default?e.renderSlot(o.$slots,"default",{key:0}):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createTextVNode(e.toDisplayString(i.label),1)],64))]))}}),Ee=(i,t)=>{const s=i.__vccOpts||i;for(const[r,n]of t)s[r]=n;return s},ma={},fa={class:"text-sm font-bold"};function ua(i,t){return e.openBlock(),e.createElementBlock("div",fa,[e.renderSlot(i.$slots,"default")])}const P=Ee(ma,[["render",ua]]),ga={},Aa={class:"mb-2"};function ya(i,t){return e.openBlock(),e.createElementBlock("div",Aa,[e.renderSlot(i.$slots,"default")])}const U=Ee(ga,[["render",ya]]),ba={class:"rounded-main p-2 border border-solid border-body-dark"},wa={class:"flex gap-2 p-2 bg-white border border-solid border-body-dark rounded-main"},Te=e.defineComponent({__name:"BaseEditor",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,n=Me.useEditor({content:s.modelValue,extensions:[cs],onUpdate:()=>{n.value&&r("update:modelValue",n.value.getHTML())}});return e.onBeforeUnmount(()=>{var o;(o=n.value)==null||o.destroy()}),e.watch(()=>s.modelValue,o=>{!n.value||n.value.getHTML()===o||n.value.commands.setContent(o,!1)}),(o,a)=>(e.openBlock(),e.createElementBlock("div",ba,[e.createVNode(e.unref(Me.EditorContent),{editor:e.unref(n)},null,8,["editor"]),e.unref(n)?(e.openBlock(),e.createBlock(e.unref(Me.BubbleMenu),{key:0,editor:e.unref(n),"tippy-options":{duration:100}},{default:e.withCtx(()=>[e.createElementVNode("div",wa,[e.createElementVNode("button",{onClick:a[0]||(a[0]=c=>e.unref(n).chain().focus().toggleBold().run()),class:e.normalizeClass({"font-bold":e.unref(n).isActive("bold")})}," bold ",2),e.createElementVNode("button",{onClick:a[1]||(a[1]=c=>e.unref(n).chain().focus().toggleItalic().run()),class:e.normalizeClass({"font-bold":e.unref(n).isActive("italic")})}," italic ",2),e.createElementVNode("button",{onClick:a[2]||(a[2]=c=>e.unref(n).chain().focus().toggleStrike().run()),class:e.normalizeClass({"font-bold":e.unref(n).isActive("strike")})}," strike ",2)])]),_:1},8,["editor"])):e.createCommentVNode("",!0)]))}}),Ca=["value"],ka=e.defineComponent({__name:"BaseSelect",props:{modelValue:{type:[String,Number],default:""},items:{type:Array,required:!0},optionId:{type:String,required:!0},optionLabel:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,n=z.useVModel(s,"modelValue",r);return(o,a)=>e.withDirectives((e.openBlock(),e.createElementBlock("select",{label:"select","onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(n)?n.value=c:null),class:"block bg-white rounded-main w-full p-2 border border-solid border-body-dark"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.items,c=>(e.openBlock(),e.createElementBlock("option",{key:c[s.optionId],value:c[s.optionId]},e.toDisplayString(c[s.optionLabel]),9,Ca))),128))],512)),[[e.vModelSelect,e.unref(n)]])}}),xa={class:"text-lg font-bold"},_a={key:0,class:"flex gap-2 items-center"},Ba={key:1,class:"flex gap-2 mt-2"},Va={key:0},Na={key:1},$a={key:0,class:"flex flex-col gap-2"},Fa={class:"FormObject-Inner"},Ea={class:"FormObject-Row"},Ta={class:"FormObject-Row"},Sa={class:"FormObject-Row"},Ma={class:"my-2"},ja={class:"FormObject-Title"},Oa={class:"FormObject-Row"},Da={class:"FormObject-Title"},Ia={class:"FormObject-Row"},Pa={key:0,class:"FormObject-ArrowName"},Ra={class:"py-3 flex gap-1"},za=e.defineComponent({__name:"FormObject",setup(i){const t=it("FormObject"),{mapObjectCurrent:s,mapFile:r,mapObject:n,mapCurrent:o,drawer:a,mapObjectRemoved:c,mapObjectRelationRemoved:d,mapObjectUrl:m,controlCombo:h}=M(),{patron:l,chain:p,guest:g}=D(),f=new Kt(()=>{const B=p.create();s.objectId(l.create(B.receiveKey("objectId"))),s.objectId(l.create(w=>{t("sep obj",w)})),r.currentMap(l.create(B.receiveKey("map"))),r.currentMap(l.create(w=>{t("sep map",w)})),B.result(l.create(g.create(({map:w,objectId:k})=>{t("object opened",k),f.value=w.objects[k]})))}).ref(),y=o.types(new _).ref(),u=r.currentMap(new _).ref(),C=new Je(f),V=m.url(C,new _).ref(),R=()=>{s.give(""),a.give("")},O=()=>{c.give(f.value),R()},G=()=>{n.give({...f.value,outlink:f.value.outlink||V.value}),R()},F=B=>{d.give({index:B,object:f.value})};return h.happenedConditional("KeyS",a.openedByName("object"),l.create(g.create(G))),(B,w)=>(e.openBlock(),e.createBlock(qe,{name:"object",onClose:R},{header:e.withCtx(()=>[e.createElementVNode("h2",xa,e.toDisplayString(B.$t("general.mapObject")),1),e.unref(f)?(e.openBlock(),e.createElementBlock("small",_a,[e.createElementVNode("span",null," ID #"+e.toDisplayString(e.unref(f).id),1)])):e.createCommentVNode("",!0),e.unref(f)?(e.openBlock(),e.createElementBlock("div",Ba,[e.unref(f).createTimestamp?(e.openBlock(),e.createElementBlock("div",Va," Создан: "+e.toDisplayString(new Date(e.unref(f).createTimestamp).toLocaleString()),1)):e.createCommentVNode("",!0),e.unref(f).changeTimestamp?(e.openBlock(),e.createElementBlock("div",Na," Изменен: "+e.toDisplayString(new Date(e.unref(f).changeTimestamp).toLocaleString()),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)]),footer:e.withCtx(()=>[e.createElementVNode("div",Ra,[e.createVNode($,{type:"success",onClick:G},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.save")),1)]),_:1}),e.createVNode($,{type:"danger",onClick:O},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.delete")),1)]),_:1}),e.createVNode($,{onClick:R},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.cancel")),1)]),_:1})])]),default:e.withCtx(()=>[e.unref(f)?(e.openBlock(),e.createElementBlock("div",$a,[e.createElementVNode("div",Fa,[e.createElementVNode("div",Ea,[e.createVNode(Ze,{modelValue:e.unref(f).linked,"onUpdate:modelValue":w[0]||(w[0]=k=>e.unref(f).linked=k),label:B.$t("general.nameAsLink")},null,8,["modelValue","label"])]),e.unref(f).linked?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.outerLink")),1)]),_:1}),e.createElementVNode("div",Ta,[e.createVNode(K,{"model-value":e.unref(f).outlink||e.unref(V),"onUpdate:modelValue":w[1]||(w[1]=k=>e.unref(f).outlink=k)},null,8,["model-value"])]),e.createElementVNode("div",Sa,[e.createVNode(Ze,{modelValue:e.unref(f).targetBlank,"onUpdate:modelValue":w[2]||(w[2]=k=>e.unref(f).targetBlank=k),label:B.$t("general.inNewTab")},null,8,["modelValue","label"])])],64)):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(f).additionalFields,(k,Q)=>(e.openBlock(),e.createBlock(U,{class:"mb-2",key:Q},{default:e.withCtx(()=>[e.createVNode(P,{class:"mb-1"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(Q),1)]),_:2},1024),e.createVNode(Te,{modelValue:e.unref(f).additionalFields[Q],"onUpdate:modelValue":q=>e.unref(f).additionalFields[Q]=q},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128)),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.topName")),1)]),_:1}),e.createVNode(Te,{modelValue:e.unref(f).additionalName,"onUpdate:modelValue":w[3]||(w[3]=k=>e.unref(f).additionalName=k)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.bottomName")),1)]),_:1}),e.createVNode(Te,{modelValue:e.unref(f).name,"onUpdate:modelValue":w[4]||(w[4]=k=>e.unref(f).name=k)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.description")),1)]),_:1}),e.createVNode(Te,{modelValue:e.unref(f).description,"onUpdate:modelValue":w[5]||(w[5]=k=>e.unref(f).description=k)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Z-Index ")]),_:1}),e.createVNode(K,{modelValue:e.unref(f).zindex,"onUpdate:modelValue":w[6]||(w[6]=k=>e.unref(f).zindex=k),type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Width ")]),_:1}),e.createVNode(K,{modelValue:e.unref(f).width,"onUpdate:modelValue":w[7]||(w[7]=k=>e.unref(f).width=k),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Height ")]),_:1}),e.createVNode(K,{modelValue:e.unref(f).height,"onUpdate:modelValue":w[8]||(w[8]=k=>e.unref(f).height=k),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.objectType")),1)]),_:1}),e.createVNode(ka,{modelValue:e.unref(f).type,"onUpdate:modelValue":w[9]||(w[9]=k=>e.unref(f).type=k),items:e.unref(y),"option-id":"id","option-label":"name"},null,8,["modelValue","items"])]),_:1}),e.createElementVNode("div",Ma,[e.createVNode(Ze,{modelValue:e.unref(f).inMenu,"onUpdate:modelValue":w[10]||(w[10]=k=>e.unref(f).inMenu=k),label:B.$t("general.useInMenu")},null,8,["modelValue","label"])]),e.unref(f).inMenu?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("div",ja,e.toDisplayString(B.$t("general.menuOrder")),1),e.createElementVNode("div",Oa,[e.createVNode(K,{modelValue:e.unref(f).menuOrder,"onUpdate:modelValue":w[11]||(w[11]=k=>e.unref(f).menuOrder=k),type:"number"},null,8,["modelValue"])])],64)):e.createCommentVNode("",!0),e.unref(f).arrows&&e.unref(f).arrows.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createElementVNode("div",Da,e.toDisplayString(B.$t("general.relations")),1),e.createElementVNode("div",Ia,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(f).arrows,(k,Q)=>{var q;return e.openBlock(),e.createElementBlock("div",{key:k.id,class:"FormObject-Arrow"},[(q=e.unref(u))!=null&&q.objects[k.id]?(e.openBlock(),e.createElementBlock("span",Pa," #"+e.toDisplayString(Q+1)+" "+e.toDisplayString(e.unref(u).objects[k.id].name),1)):e.createCommentVNode("",!0),e.createVNode($,{class:"FormObject-ArrowButton",type:"danger",size:"sm",onClick:ce=>F(Q)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(B.$t("general.delete")),1)]),_:2},1032,["onClick"])])}),128))])],64)):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0)]),_:1}))}}),La={class:"BaseTextarea"},Ha=["v-bind"],Gt=e.defineComponent({inheritAttrs:!1,__name:"BaseTextarea",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,n=z.useVModel(s,"modelValue",r);return(o,a)=>(e.openBlock(),e.createElementBlock("div",La,[e.withDirectives(e.createElementVNode("textarea",{ref:"textarea","v-bind":o.$attrs,"onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(n)?n.value=c:null),class:"rounded-main block w-full p-2 border min-h-[200px] border-solid border-body-dark"},null,8,Ha),[[e.vModelText,e.unref(n)]])]))}}),Ua={class:"text-lg font-bold"},Qa={key:0,class:"flex flex-col"},Ka={class:"flex justify-end pt-4 gap-2"},Ga=e.defineComponent({__name:"FormType",setup(i){const{mapTypeCurrent:t,mapFile:s,mapType:r,modal:n,controlCombo:o}=M(),{patron:a,chain:c,guest:d}=D();t.typeId(a.create(d.create(f=>{f&&n.give("type")})));const m=e.ref(""),h=c.create(),l=new Kt(()=>{t.typeId(a.create(h.receiveKey("typeId"))),s.currentMap(a.create(h.receiveKey("map"))),h.result(a.create(d.create(({map:f,typeId:y})=>{var u;l.value=f.types[y],m.value=(u=l.value)==null?void 0:u.name})))}).ref(),p=()=>{t.give(""),n.give(""),h.receiveKey("typeId").give("")},g=()=>{r.give({name:m.value,type:l.value}),p()};return o.happenedConditional("KeyS",n.openedByName("type"),a.create(d.create(g))),(f,y)=>(e.openBlock(),e.createBlock(re,{name:"type"},{header:e.withCtx(()=>[e.createElementVNode("h2",Ua,e.toDisplayString(f.$t("general.mapType")),1)]),footer:e.withCtx(()=>[e.createElementVNode("div",Ka,[e.createVNode($,{type:"success",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.save")),1)]),_:1}),e.createVNode($,{onClick:p},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.cancel")),1)]),_:1})])]),default:e.withCtx(()=>[e.unref(l)?(e.openBlock(),e.createElementBlock("div",Qa,[e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Название типа ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).name,"onUpdate:modelValue":y[0]||(y[0]=u=>e.unref(l).name=u)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" SVG ")]),_:1}),e.createVNode(Gt,{modelValue:e.unref(l).svg,"onUpdate:modelValue":y[1]||(y[1]=u=>e.unref(l).svg=u)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Ширина ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).width,"onUpdate:modelValue":y[2]||(y[2]=u=>e.unref(l).width=u)},null,8,["modelValue"])]),_:1}),e.createVNode(U,null,{default:e.withCtx(()=>[e.createVNode(P,null,{default:e.withCtx(()=>[e.createTextVNode(" Высота ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).height,"onUpdate:modelValue":y[3]||(y[3]=u=>e.unref(l).height=u)},null,8,["modelValue"])]),_:1})])):e.createCommentVNode("",!0)]),_:1}))}}),Ye=x.debug("MapObjectsWithTemplates");class Wa{constructor(t,s,r){this.mapObjects=t,this.map=s,this.factories=r}objects(t){const s=this.factories.chain.create();return this.map.types(this.factories.guestCast.create(t,s.receiveKey("types"))),this.mapObjects.objects(this.factories.guestCast.create(t,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(t,({types:r,objects:n})=>{Ye("visible objects",n);const o=n.map(a=>{const c=r.find(m=>String(m.id)===String(a.type));if(Ye("check type existed",c),!c)return{obj:a,template:""};let{svg:d}=c;return Ye("type svg",d),a.additionalFields&&Object.entries(a.additionalFields).forEach(([m,h])=>{d=d.replaceAll(`\${${m}}`,h)}),["width","height"].forEach(m=>{d=d.replaceAll(`\${${m}}`,a[m])}),{obj:a,template:d}});t.give(o)})),t}}const va=e.defineComponent({__name:"BaseNotify",setup(i){const{notification:t}=M(),s=t.message(new _).ref();return(r,n)=>e.unref(s)&&e.unref(s).text!=="hide"?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(["inline font-bold",`text-${e.unref(s).type}-second`])},e.toDisplayString(e.unref(s).text),3)):e.createCommentVNode("",!0)}}),qa={class:"relative"},Ja={class:"absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-1"},Za={class:"text-sm z-10 p-2 absolute bottom-0 left-5"},Ya=e.createStaticVNode('<div class="absolute bottom-3 shadow-standard-second shadow-md drop-shadow right-3 z-10"><div class="grid-example grid grid-rows-2 grid-cols-2 bg-standard-second border border-standard-second gap-[1px] border-t-0 border-l-0"><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div></div></div><div class="absolute z-30 top-0 left-0 h-[18px] w-[22px] bg-white"></div>',2),Xa=["title"],ec={class:"font-bold"},tc=["title"],sc={class:"font-bold"},rc=["title"],nc={class:"font-bold"},ic=["title"],oc={class:"font-bold"},ac=["data-object-id"],cc={class:"absolute bottom-[100%] left-[50%] translate-x-[-50%] text-center pb-2 pointer-events-auto text-sm w-[300px]"},lc=["innerHTML","onClick"],dc=["innerHTML"],hc=["data-object-id","innerHTML"],pc=e.defineComponent({__name:"TheEditor",setup(i){const{canvas:t,mapObjectsVisible:s,mapCurrent:r,konvaLayer:n,fps:o,mapCurrentID:a,mapObjectUrl:c,stageSize:d,objectsOutsideScreen:m,stagePositionByObjectId:h,mapCurrentSource:l}=M(),p=D(),g=o.value(new _).ref(),y=new Wa(s,r,p).objects(new _([])).ref(),u=d.value(new _).ref(),C=n.position(new _).ref(),V=e.computed(()=>{var ce;return(ce=u.value)==null?void 0:ce.width}),R=new Je(V),O=p.numberChunks.create(10,R).chunks(new _).ref(),G=e.ref();e.onMounted(()=>{t.give(G.value)});const F=ce=>{c.open(ce,p.guest.create(W=>{a.give(W)}))},B=m.count({axis:"x",direction:"negative"},new _).ref(),w=m.count({axis:"x",direction:"positive"},new _).ref(),k=m.count({axis:"y",direction:"negative"},new _).ref(),Q=m.count({axis:"y",direction:"positive"},new _).ref(),q=h.move.bind(h,l);return(ce,W)=>{var qt,Jt,Zt,Yt,Xt,es,ts,ss,rs,ns,is,os;return e.openBlock(),e.createElementBlock("div",qa,[e.createElementVNode("div",Ja,[e.createElementVNode("div",Za,[e.createTextVNode(" Видимых объектов: "+e.toDisplayString(e.unref(y).length)+", FPS: "+e.toDisplayString(e.unref(g))+", ",1),e.createVNode(va)]),Ya,((qt=e.unref(B))==null?void 0:qt.count)>0?(e.openBlock(),e.createElementBlock("div",{key:0,class:"pointer-events-auto absolute z-30 top-0 left-4 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(Jt=e.unref(B))==null?void 0:Jt.count} шт. объектов левее`,onClick:W[0]||(W[0]=S=>e.unref(q)(e.unref(B).nearestObjectId))},[e.createVNode(I,{icon:"fa-arrow-left"}),e.createElementVNode("span",ec,e.toDisplayString((Zt=e.unref(B))==null?void 0:Zt.count),1)],8,Xa)):e.createCommentVNode("",!0),((Yt=e.unref(w))==null?void 0:Yt.count)>0?(e.openBlock(),e.createElementBlock("div",{key:1,class:"pointer-events-auto absolute z-30 p-1 top-0 right-0 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(Xt=e.unref(w))==null?void 0:Xt.count} шт. объектов правее`,onClick:W[1]||(W[1]=S=>e.unref(q)(e.unref(w).nearestObjectId))},[e.createElementVNode("span",sc,e.toDisplayString((es=e.unref(w))==null?void 0:es.count),1),e.createVNode(I,{icon:"fa-arrow-right"})],8,tc)):e.createCommentVNode("",!0),((ts=e.unref(k))==null?void 0:ts.count)>0?(e.openBlock(),e.createElementBlock("div",{key:2,class:"pointer-events-auto absolute z-30 top-[18px] left-0 w-[18px] bg-white flex flex-col leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ss=e.unref(k))==null?void 0:ss.count} шт. объектов выше`,onClick:W[2]||(W[2]=S=>e.unref(q)(e.unref(k).nearestObjectId))},[e.createVNode(I,{icon:"fa-arrow-up"}),e.createElementVNode("span",nc,e.toDisplayString((rs=e.unref(k))==null?void 0:rs.count),1)],8,rc)):e.createCommentVNode("",!0),((ns=e.unref(Q))==null?void 0:ns.count)>0?(e.openBlock(),e.createElementBlock("div",{key:3,class:"pointer-events-auto absolute z-30 p-1 bottom-0 left-0 w-[18px] bg-white flex flex-col-reverse leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(is=e.unref(Q))==null?void 0:is.count} шт. объектов ниже`,onClick:W[3]||(W[3]=S=>e.unref(q)(e.unref(Q).nearestObjectId))},[e.createVNode(I,{icon:"fa-arrow-down"}),e.createElementVNode("span",oc,e.toDisplayString((os=e.unref(Q))==null?void 0:os.count),1)],8,ic)):e.createCommentVNode("",!0),e.createElementVNode("div",{class:e.normalizeClass({"objects-container absolute top-0 left-0":!0}),style:e.normalizeStyle({width:`${e.unref(u).width}px`,height:`${e.unref(u).height}px`,transform:`translate(${e.unref(C).x}px, ${e.unref(C).y}px)`})},[e.createElementVNode("div",{class:"absolute flex top-0 left-0 w-full z-20 h-[20px] bg-default border-b-2 border-border text-right text-sm px-2",style:e.normalizeStyle({transform:`translate(0, ${-e.unref(C).y}px)`})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(O),S=>(e.openBlock(),e.createElementBlock("span",{class:"flex-1 text-body-dark",key:`horiz_${S}`},e.toDisplayString(S)+"px",1))),128))],4),e.createElementVNode("div",{class:"absolute flex [writing-mode:vertical-lr] top-0 left-0 h-full z-20 w-[20px] bg-default border-r-2 border-border text-left text-sm py-2",style:e.normalizeStyle({transform:`translate(${-e.unref(C).x}px, 0)`})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(O),S=>(e.openBlock(),e.createElementBlock("span",{class:"flex-1 rotate-180 text-body-dark",key:`vert_${S}`},e.toDisplayString(S)+"px",1))),128))],4),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(y),S=>(e.openBlock(),e.createElementBlock("div",{key:S.obj.id,class:"absolute z-10","data-object-id":S.obj.id,style:e.normalizeStyle(`width:${S.obj.width}px;height: ${S.obj.height}px;top: ${S.obj.position[1]}px;left:${S.obj.position[0]}px;z-index:${S.obj.zindex}`)},[e.createElementVNode("div",cc,[e.createElementVNode("span",{innerHTML:S.obj.additionalName,class:e.normalizeClass([S.obj.linked&&"cursor-pointer underline"]),onClick:ul=>F(S.obj)},null,10,lc)]),e.createElementVNode("div",{class:"absolute top-[100%] left-[50%] translate-x-[-50%] text-center pt-2 text-sm w-[300px]",innerHTML:S.obj.name},null,8,dc),e.createElementVNode("div",{"data-object-id":S.obj.id,class:"rendered-object",innerHTML:S.template},null,8,hc)],12,ac))),128))],4)]),e.createElementVNode("div",{class:"h-full",ref_key:"canvasWrapper",ref:G},null,512)])}}}),mc={class:"flex flex-wrap gap-2"},fc={key:0},uc={key:1},gc=["onClick"],Ac=e.defineComponent({__name:"BaseBreadcrumbs",setup(i){const{breadcrumbs:t,mapCurrentID:s}=M(),r=t.list(new _).ref();return(n,o)=>(e.openBlock(),e.createElementBlock("div",mc,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(r),(a,c)=>(e.openBlock(),e.createElementBlock("span",{class:"flex gap-2",key:a.name},[c!==0?(e.openBlock(),e.createElementBlock("span",fc,"/")):e.createCommentVNode("",!0),c===e.unref(r).length-1?(e.openBlock(),e.createElementBlock("b",uc,"Открыто: "+e.toDisplayString(a.title),1)):(e.openBlock(),e.createElementBlock("a",{key:2,href:"#",onClick:e.withModifiers(d=>e.unref(s).give(a.name),["prevent"])},e.toDisplayString(a.title),9,gc))]))),128))]))}}),yc={class:"flex items-center p-3 gap-3"},bc={class:"ml-auto gap-1 flex"},wc=e.defineComponent({__name:"TheHeader",setup(i){const{drawer:t,modal:s,mapHistory:r,controlCombo:n,settings:o}=M(),{patron:a,guest:c}=D(),d=r.isNextPossible(new _).ref(),m=r.isPrevPossible(new _).ref();n.happened("KeyZ",a.create(c.create(()=>{m.value&&r.prev()}))),n.happened("KeyP",a.create(c.create(()=>{d.value&&r.next()})));const h=new _;return o.value(h),(l,p)=>(e.openBlock(),e.createElementBlock("div",yc,[e.createVNode(Ac,{class:"TheHeader-Breadcrumbs"}),e.createElementVNode("div",bc,[e.unref(d)&&!e.unref(h).value.readonly?(e.openBlock(),e.createBlock($,{key:0,size:"sm",title:"Отменить последнее действие",class:"w-7 block",onClick:p[0]||(p[0]=g=>e.unref(r).next())},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-rotate-left"})]),_:1})):e.createCommentVNode("",!0),e.unref(m)&&!e.unref(h).value.readonly?(e.openBlock(),e.createBlock($,{key:1,size:"sm",title:"Вернуть отмененное действие",class:"w-7 block",onClick:p[1]||(p[1]=g=>e.unref(r).prev())},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-rotate-right"})]),_:1})):e.createCommentVNode("",!0),e.createVNode($,{type:"success",size:"sm",class:"w-7 block e2e-open-menu",title:l.$t("general.menu"),onClick:p[2]||(p[2]=g=>e.unref(t).give("menu"))},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-bars"})]),_:1},8,["title"]),e.createVNode($,{title:l.$t("general.byText"),type:"primary",size:"sm",class:"w-7 block",onClick:p[3]||(p[3]=g=>e.unref(s).give("mapAsText"))},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-text-width"})]),_:1},8,["title"]),e.createVNode($,{class:"w-7 block e2e-search",size:"sm",onClick:p[4]||(p[4]=g=>e.unref(s).give("search"))},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-search"})]),_:1}),e.createVNode($,{size:"sm",title:"Все карты файла",class:"w-7 block",onClick:p[5]||(p[5]=g=>e.unref(t).give("fileMaps"))},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-map"})]),_:1})])]))}}),Cc={},kc={class:"text-lg font-bold"};function xc(i,t){return e.openBlock(),e.createElementBlock("span",kc,[e.renderSlot(i.$slots,"default")])}const _c=Ee(Cc,[["render",xc]]),Bc={class:"flex gap-1"},Vc={key:0,class:"TheMapAsText select-auto"},Nc=["innerHTML"],$c=e.defineComponent({__name:"TheMapAsText",setup(i){const{mapFile:t,mapCurrent:s}=M(),{guest:r,patron:n,textOf:o,textNlAsBr:a,textWithoutHTML:c}=D(),d=t.currentMap(new _).ref(),m=e.ref(""),h=e.ref([]);s.objects(n.create(r.create(oe(u=>{h.value=u,a.create(o.create(u.map(C=>`<div class="TheMapAsText-Item">
                <h3>${C.name}</h3><p>${C.additionalName||""}</p><p>${C.description||""}</p><p>${C.additionalFields&&Object.values(C.additionalFields).join("</p><p>")}</p></div>`).join(""))).asString(r.create(C=>{m.value=C}))},500))));const{share:l,isSupported:p}=z.useShare(),g=()=>{p.value||alert("Sharing is not supported"),c.create(o.create(m.value)).asString(r.create(u=>{l({text:u})}))},f=e.ref(),y=()=>{var u,C;if(d.value){const V=new Range;V.setStart(f.value,0),V.setEnd(f.value,Object.values(h.value).length),(u=document.getSelection())==null||u.removeAllRanges(),(C=document.getSelection())==null||C.addRange(V)}};return(u,C)=>(e.openBlock(),e.createBlock(re,{name:"mapAsText"},{header:e.withCtx(()=>[e.createVNode(_c,{class:"block mb-3"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(u.$t("general.mapAsText"))+" ",1),e.createElementVNode("div",Bc,[e.createVNode($,{size:"sm",type:"success",class:"font-normal",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(u.$t("general.share")),1)]),_:1}),e.createVNode($,{size:"sm",type:"primary",class:"font-normal",onClick:y},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(u.$t("general.selectAll")),1)]),_:1})])]),_:1})]),default:e.withCtx(()=>[e.unref(d)?(e.openBlock(),e.createElementBlock("article",Vc,[e.createElementVNode("div",{ref_key:"textRef",ref:f,innerHTML:m.value},null,8,Nc)])):e.createCommentVNode("",!0)]),_:1}))}}),Fc={key:1},Ec=e.defineComponent({__name:"TheMiniMap",setup(i){const{miniMap:t}=M(),s=t.points(new _).ref(),r=t.size(new _).ref(),n=t.viewportSize(new _).ref(),o=t.viewportPosition(new _).ref();return(a,c)=>e.unref(r)?(e.openBlock(),e.createElementBlock("div",{key:0,style:e.normalizeStyle({width:`${e.unref(r).width}px`,height:`${e.unref(r).height}px`}),class:"absolute pointer-events-none block bg-white bottom-[10px] mt-3 right-3 z-1 border border-solid border-body-dark"},[e.unref(o)?(e.openBlock(),e.createElementBlock("div",{key:0,style:e.normalizeStyle({width:`${e.unref(n).width}px`,height:`${e.unref(n).height}px`,top:`${e.unref(o).y}px`,left:`${e.unref(o).x}px`}),class:"absolute bg-primary/50"},null,4)):e.createCommentVNode("",!0),e.unref(s)?(e.openBlock(),e.createElementBlock("div",Fc,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(s),d=>(e.openBlock(),e.createElementBlock("div",{key:d.id,class:"absolute w-1 h-1 block bg-danger",style:e.normalizeStyle({top:`${d.y}px`,left:`${d.x}px`,width:`${d.width}px`,height:`${d.height}px`})},null,4))),128))])):e.createCommentVNode("",!0)],4)):e.createCommentVNode("",!0)}}),Tc={class:"text-lg font-bold"},Sc={key:0,class:"TheSettings"},Mc={class:"mb-2"},jc={class:"TheSettings-Row"},Oc={class:"flex gap-2 mb-2"},Dc={class:"mb-2"},Ic={class:"mb-2"},Pc={href:"https://github.com/kosukhin/mind-map-creator",target:"_blank"},Rc={class:"flex gap-2"},zc=e.defineComponent({__name:"FormSettings",setup(i){const{modal:t,mapFile:s,mapRemoved:r,mapSettings:n,controlCombo:o,parentNames:a,mapCurrentID:c}=M(),{patron:d,guest:m}=D(),h=a.names(new _).ref(),l=s.currentMap(new _).ref(),p=c.id(new _).ref(),g=()=>{t.give("")},f=()=>{n.give(l.value.settings),g()};return o.happenedConditional("KeyS",t.openedByName("settings"),d.create(m.create(f))),(y,u)=>(e.openBlock(),e.createBlock(re,{name:"settings"},{header:e.withCtx(()=>[e.createElementVNode("h2",Tc,e.toDisplayString(y.$t("general.mapSettings")),1)]),default:e.withCtx(()=>{var C;return[(C=e.unref(l))!=null&&C.settings?(e.openBlock(),e.createElementBlock("div",Sc,[e.createElementVNode("div",Mc,[e.createElementVNode("div",jc,[e.createElementVNode("div",Oc,[e.unref(h).length>1?(e.openBlock(),e.createBlock($,{key:0,type:"primary",class:"text-white",onClick:u[0]||(u[0]=V=>e.unref(t).give("parentTypes"))},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.parentTypes")),1)]),_:1})):e.createCommentVNode("",!0),e.createVNode($,{type:"primary",class:"text-white",onClick:u[1]||(u[1]=V=>e.unref(t).give("export"))},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.exportOrImport")),1)]),_:1}),e.createVNode($,{type:"primary",class:"text-white e2e-open-presets",onClick:u[2]||(u[2]=V=>e.unref(t).give("presets"))},{default:e.withCtx(()=>[e.createTextVNode(" Пресеты ")]),_:1})])]),e.createElementVNode("div",Dc,[e.createElementVNode("label",null,[e.createElementVNode("b",null,e.toDisplayString(y.$t("general.mapName")),1),e.createVNode(K,{modelValue:e.unref(l).settings.title,"onUpdate:modelValue":u[3]||(u[3]=V=>e.unref(l).settings.title=V)},null,8,["modelValue"])])]),e.createElementVNode("div",Ic,[e.createElementVNode("a",Pc,e.toDisplayString(y.$t("general.githubRepo")),1)])]),e.createElementVNode("div",Rc,[e.createVNode($,{class:"TheSettings-Button",type:"success",onClick:u[4]||(u[4]=V=>f())},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.save")),1)]),_:1}),e.createVNode($,{class:"TheSettings-Button",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.cancel")),1)]),_:1}),e.createVNode($,{class:"TheSettings-Button",type:"danger",onClick:u[5]||(u[5]=V=>{e.unref(r).give(e.unref(p)),g()})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.removeMap")),1)]),_:1})])])):e.createCommentVNode("",!0)]}),_:1}))}}),Lc={},Hc={class:"BaseGroup"};function Uc(i,t){return e.openBlock(),e.createElementBlock("div",Hc,[e.renderSlot(i.$slots,"default")])}const Qc=Ee(Lc,[["render",Uc]]),Kc="default",Gc=e.defineComponent({__name:"TheLinker",setup(i){const{mapObjectsLink:t}=M(),s=t.objectIds(new _([])).ref();return(r,n)=>(e.openBlock(),e.createBlock($,{type:Kc,onClick:n[0]||(n[0]=o=>e.unref(t).startLink())},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(e.unref(s).length===1?"Выбиретие объект":e.unref(s).length===2?"Второй объект":"Связать объекты"),1)]),_:1}))}}),Wc={class:"flex e2e-sidebar flex-col items-center gap-3 max-h-[100%] overflow-hidden"},vc={class:"TheSideBar-ItemName"},qc=["innerHTML","draggable","title","onDragend"],Jc={key:0,class:"flex gap-1"},Zc={key:0,class:"mt-auto w-full p-3 pt-0"},Yc=e.defineComponent({__name:"TheSideBar",setup(i){const{mapObjectNew:t,mapCurrent:s,mapTypeCurrent:r,mapTypeRemoved:n,mapTypeNew:o,modal:a,settings:c,sidebarDraggable:d}=M(),m=s.types(new _).ref(),h=e.ref();e.onMounted(()=>{d.give(h.value)});const{svgMapTypeImage:l}=D(),p=e.computed(()=>{var f;return(f=m.value)==null?void 0:f.map(y=>({type:y,image:l.create(y).markup()})).sort((y,u)=>+(y.type.name>=u.type.name))}),g=new _;return c.value(g),(f,y)=>(e.openBlock(),e.createElementBlock("div",Wc,[e.createElementVNode("div",{ref_key:"dragWrapperRef",ref:h,class:"flex flex-col gap-3 flex-grow w-full overflow-y-auto"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(p.value,(u,C)=>(e.openBlock(),e.createElementBlock("div",{key:C,class:"flex flex-col items-center justify-center gap-2"},[e.createElementVNode("div",vc,e.toDisplayString(u.type.name),1),e.createElementVNode("div",{innerHTML:u.image,class:"TheSideBar-ItemImage",draggable:e.unref(g).value.readonly?"false":"true",style:e.normalizeStyle(`width:${u.type.width}px;height:${u.type.height}px`),title:f.$t("general.notifications.dragToCanvasToAdd"),onDragend:V=>e.unref(t).byTypeName(u.type.id,V)},null,44,qc),e.unref(g).value.readonly?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",Jc,[e.createVNode($,{class:"text-white",size:"sm",type:"primary",onClick:V=>e.unref(r).give(u.type.id)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.change")),1)]),_:2},1032,["onClick"]),e.createVNode($,{class:"text-white",size:"sm",type:"danger",onClick:V=>e.unref(n).give(u.type)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.delete")),1)]),_:2},1032,["onClick"])]))]))),128))],512),e.unref(g).value.readonly?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",Zc,[e.createVNode(Qc,{class:"mb-1 grid gap-1 grid-cols-2"},{default:e.withCtx(()=>[e.createVNode($,{title:f.$t("general.addType"),type:"success",onClick:y[0]||(y[0]=u=>e.unref(o).byName())},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-plus-square"})]),_:1},8,["title"]),e.createVNode($,{class:"e2e-show-settings",title:f.$t("general.settings"),type:"primary",onClick:y[1]||(y[1]=u=>e.unref(a).give("settings"))},{default:e.withCtx(()=>[e.createVNode(I,{icon:"fa-cog"})]),_:1},8,["title"])]),_:1}),e.createVNode(Gc,{class:"w-[100%] block mb-1"})]))]))}});class Xc{constructor(t,s,r=!1){this.basePatron=t,this.guest=s,this.refWatcherCreated=r}ref(){return this.basePatron.ref()}get value(){return this.basePatron.value}introduction(){return this.basePatron.introduction()}give(t){return this.basePatron.give(t),this.refWatcherCreated||(this.refWatcherCreated=!0,X.watch(this.basePatron.ref(),s=>{s&&this.guest.give(s)},{deep:!0})),this}}class el{constructor(t){this.baseSource=t}value(t){return this.baseSource.value(new ne(t,s=>{Z(JSON.stringify(s),t)})),this}give(t){return this.value(s=>{t!==s&&this.baseSource.give(JSON.parse(t))}),this}pool(){return this.baseSource.pool()}}class tl{constructor(t,s){this.baseGuest=t,this.baseGuestAware=s}value(t){return this.baseGuestAware.value(t),this}give(t){return Z(t,this.baseGuest),this}pool(){throw Error("No pool in SourceDynamic")}}const sl={class:"AppPresets"},rl=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Экспорт\\Импорт текущей карты",-1),nl={class:"flex flex-col gap-2"},il=e.defineComponent({__name:"AppExport",setup(i){const{mapFile:t,mapCurrent:s}=M(),r=new tl(s,new je(c=>{t.currentMap(new ye(c))})),n=new el(r),o=new Xc(new _,n);n.value(o);const a=o.ref();return(c,d)=>(e.openBlock(),e.createBlock(re,{name:"export"},{default:e.withCtx(()=>[e.createElementVNode("div",sl,[rl,e.createElementVNode("div",nl,[e.createVNode(Gt,{modelValue:e.unref(a),"onUpdate:modelValue":d[0]||(d[0]=m=>e.isRef(a)?a.value=m:null)},null,8,["modelValue"])])])]),_:1}))}}),ol={class:"bg-body absolute top-0 left-0 w-full h-full"},al={class:"grid grid-cols-[200px_1fr] grid-rows-[50px_1fr] h-dvh relative"},cl=e.defineComponent({__name:"PatronSchemeEditor",props:{modelValue:{type:String,required:!0},readonly:{type:Boolean,default:!1},presets:{type:Object,default:()=>({})}},emits:["update:modelValue"],setup(i,{emit:t}){const s=i,r=t,{fileContent:n,settings:o}=M(),{guest:a,patron:c}=D();return o.value(d=>{o.give({...d,readonly:s.readonly,presets:s.presets})}),e.watch(()=>s.modelValue,d=>{n.value(a.create(m=>{d!==m&&n.give(d)}))},{immediate:!0}),n.value(c.create(d=>{r("update:modelValue",d)})),(d,m)=>(e.openBlock(),e.createElementBlock("div",ol,[e.createElementVNode("div",al,[e.createVNode(wc,{class:"col-span-2"}),e.createVNode(Yc),e.createVNode(pc,{class:"w-auto col-auto h-full"}),e.createVNode(Ec)]),e.createVNode(za),e.createVNode(Ga),e.createVNode(zc),e.createVNode(Jo),e.createVNode(ha),e.createVNode(il),e.createVNode(Po),e.createVNode($c),e.createVNode(ia),e.createVNode(So)]))}}),Wt=x.debug("FileSystemContent");class ll{constructor(t,s,r){b(this,"contentPatrons");b(this,"fileHandler",null);b(this,"contentSource");this.launchQueue=t,this.notification=s,this.factories=r,this.contentPatrons=r.pool.create(this),this.contentSource=r.sourceEmpty.create()}content(t){const s=this.factories.guest.create(r=>{this.fileHandler=r,this.factories.fileHandlerContent.create(r).content(this.factories.guest.create(n=>{this.contentPatrons.distribute(n,t),this.contentSource.give(n)}))});return this.fileHandler||this.launchQueue.fileHandler(s),this.contentSource.value(t),this}give(t){if(Wt("save file as content string",t),!this.fileHandler)throw new de("Cant save file because no fileHandler");try{return this.contentSource.give(t),this.factories.browserFileSaved.create(this.fileHandler).save(t),this.contentPatrons.give(t),this}catch(s){throw new de("Cant handle receive for map file FS",{cause:s})}finally{this.notification.give({type:"success",text:"Успешно сохранен файл карты!"})}}canBeUsed(t){const s="launchQueue"in window;Wt("can be used",s);const r=window&&window.matchMedia("(display-mode: standalone)");return t.give(s&&r.matches),t}}const Se=x.debug("FirstPossibleFileContent");class dl{constructor(t,s){b(this,"firstPossibleFileContent",null);b(this,"contentSource",new ie);b(this,"canBeUsedSource",new ie);Se("length",t.length),t.forEach(r=>{r.canBeUsed(s.patronOnce.create(s.guest.create(n=>{Se("canbeused result",r,n),n&&!this.firstPossibleFileContent&&(this.firstPossibleFileContent=r,r.canBeUsed(s.patron.create(this.canBeUsedSource)),r.content(s.patron.create(this.contentSource)),this.contentSource.value(s.patron.create(o=>{r.content(s.guest.create(a=>{o!==a&&r.give(o)}))})))})))})}canBeUsed(t){return Se("can be used to",this.firstPossibleFileContent),this.canBeUsedSource.value(t),t}content(t){return Se("content to",this.firstPossibleFileContent),this.contentSource.value(t),this}give(t){return this.contentSource.give(t),this}}const Xe=x.debug("UrlContent");class hl{constructor(t,s){b(this,"contentCache");this.notification=t,this.factories=s,this.contentCache=s.sourceEmpty.create()}canBeUsed(t){if(!window)return t.give(!1),this;const s=window.location.search.indexOf("?view=")>-1;if(Xe("can be used",s),t.give(window.location.search.indexOf("?view=")>-1),s){const r=window.location.search.split("=")[1]??"";fetch(r,{redirect:"follow"}).then(n=>n.text()).then(n=>{Xe("received text",n),this.contentCache.give(n)})}return t}content(t){if(!window)return this;const s=window.location.search.split("=")[1]??"";return Xe("visit url",s),this.contentCache.value(this.factories.patronOnce.create(t)),this}give(){return this.notification.give({type:"error",text:"Невозможно сохранить карту, открытую по ссылке!"}),this}}const vt=new ie;class pl{constructor(t=window.launchQueue,s="launchQueue"in window){b(this,"isCalculated",!1);this.launchQueue=t,this.isLaunchQueueSupported=s}fileHandler(t){return this.isLaunchQueueSupported&&!this.isCalculated&&(this.isCalculated=!0,this.launchQueue.setConsumer(s=>{if(console.log("require file handler"),s.files&&s.files.length){const[r]=s.files;vt.give(r)}})),vt.value(t),this}}N.BrowserLaunchQueue=pl,N.FileSystemContent=ll,N.FirstPossibleFileContent=dl,N.PatronSchemeEditor=cl,N.UrlContent=hl,N.VueRefPatron=_,N.useApplication=M,N.useFactories=D,Object.defineProperty(N,Symbol.toStringTag,{value:"Module"})});

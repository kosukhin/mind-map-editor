(function(B,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue"),require("konva/lib/shapes/Arrow"),require("konva/lib/shapes/Rect"),require("konva"),require("konva/lib/Stage"),require("@fortawesome/vue-fontawesome"),require("@fortawesome/free-solid-svg-icons"),require("@tiptap/vue-3"),require("@tiptap/starter-kit")):typeof define=="function"&&define.amd?define(["exports","vue","konva/lib/shapes/Arrow","konva/lib/shapes/Rect","konva","konva/lib/Stage","@fortawesome/vue-fontawesome","@fortawesome/free-solid-svg-icons","@tiptap/vue-3","@tiptap/starter-kit"],e):(B=typeof globalThis<"u"?globalThis:B||self,e(B.patron={},B.Vue,B.Arrow,B.Rect,B.Konva,B.Stage,B.vueFontawesome,B.freeSolidSvgIcons,B.vue3,B.StarterKit))})(this,function(B,e,X,_s,nt,rt,Ns,D,je,$s){"use strict";var Ql=Object.defineProperty;var Jl=(B,e,X)=>e in B?Ql(B,e,{enumerable:!0,configurable:!0,writable:!0,value:X}):B[e]=X;var _=(B,e,X)=>Jl(B,typeof e!="symbol"?e+"":e,X);class Vs{constructor(t){t.value(this)}give(t){return document.title=t,this}introduction(){return"patron"}}class Pe{constructor(t){this.guestReceiver=t}value(t){return this.guestReceiver(t),t}}function Q(o,t,s){typeof t=="function"?t(o,s):t.give(o,s)}class Y{constructor(t){this.receiver=t}give(t,s){return this.receiver(t,s),this}}class ne{constructor(t,s){this.sourceGuest=t,this.targetGuest=s}introduction(){return typeof this.sourceGuest=="function"||!this.sourceGuest.introduction?"guest":this.sourceGuest.introduction()}give(t,s){return Q(t,this.targetGuest,s),this}disposed(t){const s=this.sourceGuest;return s.disposed?s.disposed(t):!1}}var Ss=Object.defineProperty,Ts=(o,t,s)=>t in o?Ss(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,ot=(o,t,s)=>Ts(o,typeof t!="symbol"?t+"":t,s);const it=new Map,at=o=>{it.forEach(t=>{t.delete(o)})};class me{constructor(t){this.initiator=t,ot(this,"patrons"),ot(this,"give"),this.patrons=new Set,it.set(this,this.patrons);let s=null;const n=(r,i)=>{this.patrons.forEach(a=>{this.sendValueToGuest(r,a,i)})};this.give=(r,i)=>{const a=()=>{a===s&&n(r,i)};return s=a,queueMicrotask(a),this}}size(){return this.patrons.size}add(t){if(!t)throw new Error("PatronPool add method received nothing!");return typeof t!="function"&&t.introduction&&t.introduction()==="patron"&&this.patrons.add(t),this}remove(t){return this.patrons.delete(t),this}distribute(t,s){return this.add(s),this.sendValueToGuest(t,s,{}),this}sendValueToGuest(t,s,n){this.guestDisposed(t,s)||Q(t,s,{...n,data:{...(n==null?void 0:n.data)??{},initiator:this.initiator,pool:this}})}guestDisposed(t,s){var n;return(n=s.disposed)!=null&&n.call(s,t)?(this.remove(s),!0):!1}}var Bs=Object.defineProperty,Es=(o,t,s)=>t in o?Bs(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,Fs=(o,t,s)=>Es(o,t+"",s);class ce{constructor(t){this.sourceDocument=t,Fs(this,"thePool",new me(this))}pool(){return this.thePool}give(t){return this.sourceDocument=t,this.thePool.give(this.sourceDocument),this}value(t){return typeof t=="function"?this.thePool.distribute(this.sourceDocument,new Y(t)):this.thePool.distribute(this.sourceDocument,t),this}}class ge{constructor(t){this.baseGuest=t}give(t,s){let n=this.baseGuest;return typeof n=="function"&&(n=new Y(n)),n.give(t,s),this}introduction(){return typeof this.baseGuest=="function"||!this.baseGuest.introduction?"guest":this.baseGuest.introduction()}disposed(t){const s=this.baseGuest;return s.disposed?s.disposed(t):!1}}var Os=Object.defineProperty,Ms=(o,t,s)=>t in o?Os(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,ct=(o,t,s)=>Ms(o,typeof t!="symbol"?t+"":t,s);class js{constructor(t){ct(this,"guests",new Set),ct(this,"patronPool"),this.patronPool=new me(t)}give(t,s){return this.deliverToGuests(t,s),this.patronPool.give(t,s),this}add(t){return(typeof t=="function"||!t.introduction||t.introduction()==="guest")&&this.guests.add(t),this.patronPool.add(t),this}remove(t){return this.guests.delete(t),this.patronPool.remove(t),this}distribute(t,s){return this.add(s),this.give(t),this}size(){return this.patronPool.size()+this.guests.size}deliverToGuests(t,s){this.guests.forEach(n=>{Q(t,n,s)}),this.guests.clear()}}var Ps=Object.defineProperty,Is=(o,t,s)=>t in o?Ps(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,ye=(o,t,s)=>Is(o,typeof t!="symbol"?t+"":t,s);class Ds{constructor(){ye(this,"theChain"),ye(this,"keysKnown",new Set),ye(this,"keysFilled",new Set),ye(this,"filledChainPool",new js(this)),this.theChain=new ce({})}resultArray(t){const s=new ge(t);return this.filledChainPool.add(new ne(s,n=>{s.give(Object.values(n))})),this.isChainFilled()&&this.theChain.value(new Y(n=>{this.filledChainPool.give(Object.values(n))})),this}result(t){const s=new ge(t);return this.isChainFilled()?(this.filledChainPool.add(s),this.theChain.value(new Y(n=>{this.filledChainPool.give(n)}))):this.filledChainPool.add(s),this}receiveKey(t){return this.keysKnown.add(t),new Y(s=>{queueMicrotask(()=>{this.theChain.value(new Y(n=>{this.keysFilled.add(t);const r={...n,[t]:s};this.theChain.give(r),this.isChainFilled()&&this.filledChainPool.give(r)}))})})}isChainFilled(){return this.keysFilled.size>0&&this.keysFilled.size===this.keysKnown.size}}class As{constructor(t){this.theValue=t}give(t){return this.theValue=t,this}value(){return this.theValue}}class Rs{constructor(t){this.willBePatron=t}introduction(){return"patron"}give(t,s){return Q(t,this.willBePatron,s),this}disposed(t){var n;const s=this.willBePatron;return((n=s==null?void 0:s.disposed)==null?void 0:n.call(s,t))||!1}}var Ls=Object.defineProperty,zs=(o,t,s)=>t in o?Ls(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,vs=(o,t,s)=>zs(o,t+"",s);class Hs{constructor(t){this.baseGuest=t,vs(this,"received",!1)}introduction(){return"patron"}give(t,s){this.received||Q(t,this.baseGuest,s);const n=s==null?void 0:s.data;return n!=null&&n.pool&&n.pool.remove(this),this}disposed(t){const s=this.baseGuest;return s.disposed?s.disposed(t):!1}}var Us=Object.defineProperty,Ks=(o,t,s)=>t in o?Us(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,Gs=(o,t,s)=>Ks(o,t+"",s);class re{constructor(){Gs(this,"baseSource",new ce(null))}value(t){return this.baseSource.value(new ne(t,s=>{s!==null&&Q(s,t)})),this}give(t){return this.baseSource.give(t),this}pool(){return this.baseSource.pool()}}class F{constructor(t,s={}){this.constructorFn=t,this.factories=s}create(...t){return new this.constructorFn(...t,this.factories)}}class le extends Error{constructor(t,s){super(t,s)}}class Ws{constructor(t){this.fileHandler=t}content(t){return this.fileHandler.getFile().then(async s=>await new Response(s).text()).then(s=>{t.give(s)}).catch(s=>{throw new le("Problem when reading file in SystemFileFromHandler",{cause:s})}),this}}class qs{constructor(t){this.fileHandler=t}save(t){return this.fileHandler.createWritable().then(s=>(s.write(t).catch(n=>{throw new le("Cant save file in browser",{cause:n})}),s)).then(s=>{s.close().catch(n=>{throw new le("Cant close written file in browser",{cause:n})})}),this}}class Qs{constructor(t){this.content=t}result(){return JSON.parse(this.content)}}class Js{constructor(t){this.content=t}result(){return JSON.stringify(this.content)}}class Xs{constructor(t,s=100,n=100){this.svgContent=t,this.width=s,this.height=n}markup(){return this.svgContent.replaceAll("${width}",String(this.width)).replaceAll("${height}",String(this.height))}}class Ys{constructor(t,s){this.type=t,this.factories=s}markup(){return this.factories.svgImage.create(this.type.svg,this.type.width,this.type.height).markup()}}class Zs{constructor(t,s,n){this.chunksCount=t,this.baseNumber=s,this.factories=n}chunks(t){return this.baseNumber.value(this.factories.guestInTheMiddle.create(t,s=>{const n=Math.round(s/this.chunksCount),r=[];for(let i=1;i<=this.chunksCount;i+=1)r.push(i*n);t.give(r)})),t}}class en{constructor(t,s){this.mapUrl=t,this.factories=s}name(t){this.mapUrl.value(this.factories.guestInTheMiddle.create(t,s=>{let n=s.replace("/","").replaceAll("/","_");n.match("_")&&(n=`_${n}`),t.give(n)}))}}class tn{constructor(t,s){this.text=t,this.factories=s}noHtml(t){return this.text.value(this.factories.guestInTheMiddle.create(t,s=>{const n=document.createElement("DIV");n.innerHTML=s;const r=n.textContent||n.innerText||"";t.give(r)})),t}}var lt;const be=typeof window<"u",sn=o=>typeof o<"u",nn=o=>typeof o=="function",rn=o=>typeof o=="string",Ie=()=>{};be&&((lt=window==null?void 0:window.navigator)!=null&&lt.userAgent)&&/iP(ad|hone|od)/.test(window.navigator.userAgent);function Z(o){return typeof o=="function"?o():e.unref(o)}function on(o){return o}function an(o){return e.getCurrentScope()?(e.onScopeDispose(o),!0):!1}function dt(o,t=!0){e.getCurrentInstance()?e.onMounted(o):t?o():e.nextTick(o)}function cn(o){e.getCurrentInstance()&&e.onUnmounted(o)}function ln(o){var t;const s=Z(o);return(t=s==null?void 0:s.$el)!=null?t:s}const ht=be?window:void 0,dn=be?window.document:void 0,hn=be?window.navigator:void 0;function we(...o){let t,s,n,r;if(rn(o[0])||Array.isArray(o[0])?([s,n,r]=o,t=ht):[t,s,n,r]=o,!t)return Ie;Array.isArray(s)||(s=[s]),Array.isArray(n)||(n=[n]);const i=[],a=()=>{i.forEach(h=>h()),i.length=0},c=(h,l,p,g)=>(h.addEventListener(l,p,g),()=>h.removeEventListener(l,p,g)),d=e.watch(()=>[ln(t),Z(r)],([h,l])=>{a(),h&&i.push(...s.flatMap(p=>n.map(g=>c(h,p,g,l))))},{immediate:!0,flush:"post"}),u=()=>{d(),a()};return an(u),u}function pn(o,t=!1){const s=e.ref(),n=()=>s.value=!!o();return n(),dt(n,t),s}function un(o){return JSON.parse(JSON.stringify(o))}const pt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ut="__vueuse_ssr_handlers__";pt[ut]=pt[ut]||{};const fn={ctrl:"control",command:"meta",cmd:"meta",option:"alt",up:"arrowup",down:"arrowdown",left:"arrowleft",right:"arrowright"};function mn(o={}){const{reactive:t=!1,target:s=ht,aliasMap:n=fn,passive:r=!0,onEventFired:i=Ie}=o,a=e.reactive(new Set),c={toJSON(){return{}},current:a},d=t?e.reactive(c):c,u=new Set,h=new Set;function l(y,f){y in d&&(t?d[y]=f:d[y].value=f)}function p(){a.clear();for(const y of h)l(y,!1)}function g(y,f){var b,x;const T=(b=y.key)==null?void 0:b.toLowerCase(),I=[(x=y.code)==null?void 0:x.toLowerCase(),T].filter(Boolean);T&&(f?a.add(T):a.delete(T));for(const S of I)h.add(S),l(S,f);T==="meta"&&!f?(u.forEach(S=>{a.delete(S),l(S,!1)}),u.clear()):typeof y.getModifierState=="function"&&y.getModifierState("Meta")&&f&&[...a,...I].forEach(S=>u.add(S))}we(s,"keydown",y=>(g(y,!0),i(y)),{passive:r}),we(s,"keyup",y=>(g(y,!1),i(y)),{passive:r}),we("blur",p,{passive:!0}),we("focus",p,{passive:!0});const m=new Proxy(d,{get(y,f,b){if(typeof f!="string")return Reflect.get(y,f,b);if(f=f.toLowerCase(),f in n&&(f=n[f]),!(f in d))if(/[+_-]/.test(f)){const T=f.split(/[+_-]/g).map(M=>M.trim());d[f]=e.computed(()=>T.every(M=>e.unref(m[M])))}else d[f]=e.ref(!1);const x=Reflect.get(y,f,b);return t?e.unref(x):x}});return m}var ft;(function(o){o.UP="UP",o.RIGHT="RIGHT",o.DOWN="DOWN",o.LEFT="LEFT",o.NONE="NONE"})(ft||(ft={}));function gn(o,t=Ie,s={}){const{immediate:n=!0,manual:r=!1,type:i="text/javascript",async:a=!0,crossOrigin:c,referrerPolicy:d,noModule:u,defer:h,document:l=dn,attrs:p={}}=s,g=e.ref(null);let m=null;const y=x=>new Promise((T,M)=>{const I=k=>(g.value=k,T(k),k);if(!l){T(!1);return}let S=!1,w=l.querySelector(`script[src="${Z(o)}"]`);w?w.hasAttribute("data-loaded")&&I(w):(w=l.createElement("script"),w.type=i,w.async=a,w.src=Z(o),h&&(w.defer=h),c&&(w.crossOrigin=c),u&&(w.noModule=u),d&&(w.referrerPolicy=d),Object.entries(p).forEach(([k,N])=>w==null?void 0:w.setAttribute(k,N)),S=!0),w.addEventListener("error",k=>M(k)),w.addEventListener("abort",k=>M(k)),w.addEventListener("load",()=>{w.setAttribute("data-loaded","true"),t(w),I(w)}),S&&(w=l.head.appendChild(w)),x||I(w)}),f=(x=!0)=>(m||(m=y(x)),m),b=()=>{if(!l)return;m=null,g.value&&(g.value=null);const x=l.querySelector(`script[src="${Z(o)}"]`);x&&l.head.removeChild(x)};return n&&!r&&dt(f),r||cn(b),{scriptTag:g,load:f,unload:b}}var yn=Object.defineProperty,mt=Object.getOwnPropertySymbols,bn=Object.prototype.hasOwnProperty,wn=Object.prototype.propertyIsEnumerable,gt=(o,t,s)=>t in o?yn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,yt=(o,t)=>{for(var s in t||(t={}))bn.call(t,s)&&gt(o,s,t[s]);if(mt)for(var s of mt(t))wn.call(t,s)&&gt(o,s,t[s]);return o};function Cn(o={},t={}){const{navigator:s=hn}=t,n=s,r=pn(()=>n&&"canShare"in n);return{isSupported:r,share:async(a={})=>{if(r.value){const c=yt(yt({},Z(o)),Z(a));let d=!0;if(c.files&&n.canShare&&(d=n.canShare({files:c.files})),d)return n.share(c)}}}}var kn=Object.defineProperty,bt=Object.getOwnPropertySymbols,xn=Object.prototype.hasOwnProperty,_n=Object.prototype.propertyIsEnumerable,wt=(o,t,s)=>t in o?kn(o,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[t]=s,Nn=(o,t)=>{for(var s in t||(t={}))xn.call(t,s)&&wt(o,s,t[s]);if(bt)for(var s of bt(t))_n.call(t,s)&&wt(o,s,t[s]);return o};Nn({linear:on},{easeInSine:[.12,0,.39,0],easeOutSine:[.61,1,.88,1],easeInOutSine:[.37,0,.63,1],easeInQuad:[.11,0,.5,0],easeOutQuad:[.5,1,.89,1],easeInOutQuad:[.45,0,.55,1],easeInCubic:[.32,0,.67,0],easeOutCubic:[.33,1,.68,1],easeInOutCubic:[.65,0,.35,1],easeInQuart:[.5,0,.75,0],easeOutQuart:[.25,1,.5,1],easeInOutQuart:[.76,0,.24,1],easeInQuint:[.64,0,.78,0],easeOutQuint:[.22,1,.36,1],easeInOutQuint:[.83,0,.17,1],easeInExpo:[.7,0,.84,0],easeOutExpo:[.16,1,.3,1],easeInOutExpo:[.87,0,.13,1],easeInCirc:[.55,0,1,.45],easeOutCirc:[0,.55,.45,1],easeInOutCirc:[.85,0,.15,1],easeInBack:[.36,0,.66,-.56],easeOutBack:[.34,1.56,.64,1],easeInOutBack:[.68,-.6,.32,1.6]});function Ce(o,t,s,n={}){var r,i,a;const{clone:c=!1,passive:d=!1,eventName:u,deep:h=!1,defaultValue:l}=n,p=e.getCurrentInstance(),g=s||(p==null?void 0:p.emit)||((r=p==null?void 0:p.$emit)==null?void 0:r.bind(p))||((a=(i=p==null?void 0:p.proxy)==null?void 0:i.$emit)==null?void 0:a.bind(p==null?void 0:p.proxy));let m=u;m=u||m||`update:${t.toString()}`;const y=b=>c?nn(c)?c(b):un(b):b,f=()=>sn(o[t])?y(o[t]):l;if(d){const b=f(),x=e.ref(b);return e.watch(()=>o[t],T=>x.value=y(T)),e.watch(x,T=>{(T!==o[t]||h)&&g(m,T)},{deep:h}),x}else return e.computed({get(){return f()},set(b){g(m,b)}})}class $n{constructor(t,s,n,r){_(this,"loadingCache");this.callbackName=t,this.url=s,this.emptyValue=n,this.factories=r,this.loadingCache=r.sourceEmpty.create()}content(t){this.loadingCache.give(!0);const s=setTimeout(()=>{this.loadingCache.give(!1),t.give(this.emptyValue)},1e4);return gn(this.url,()=>{var r;clearInterval(s);const n=((r=window[this.callbackName])==null?void 0:r.call(window))||this.emptyValue;t.give(n),this.loadingCache.give(!1)}),t}loading(t){return this.loadingCache.value(t),t}}class Vn{constructor(t){this.text=t}asString(t){return t.give(this.text),t}}class Sn{constructor(t,s){this.baseText=t,this.factories=s}asString(t){return this.baseText.asString(this.factories.guestInTheMiddle.create(t,s=>{t.give((s??"").replace(/<\/?[^>]+>/gi," "))})),t}}var ke=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function De(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Ae={exports:{}},Re,Ct;function Tn(){if(Ct)return Re;Ct=1;var o=1e3,t=o*60,s=t*60,n=s*24,r=n*7,i=n*365.25;Re=function(h,l){l=l||{};var p=typeof h;if(p==="string"&&h.length>0)return a(h);if(p==="number"&&isFinite(h))return l.long?d(h):c(h);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(h))};function a(h){if(h=String(h),!(h.length>100)){var l=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(h);if(l){var p=parseFloat(l[1]),g=(l[2]||"ms").toLowerCase();switch(g){case"years":case"year":case"yrs":case"yr":case"y":return p*i;case"weeks":case"week":case"w":return p*r;case"days":case"day":case"d":return p*n;case"hours":case"hour":case"hrs":case"hr":case"h":return p*s;case"minutes":case"minute":case"mins":case"min":case"m":return p*t;case"seconds":case"second":case"secs":case"sec":case"s":return p*o;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function c(h){var l=Math.abs(h);return l>=n?Math.round(h/n)+"d":l>=s?Math.round(h/s)+"h":l>=t?Math.round(h/t)+"m":l>=o?Math.round(h/o)+"s":h+"ms"}function d(h){var l=Math.abs(h);return l>=n?u(h,l,n,"day"):l>=s?u(h,l,s,"hour"):l>=t?u(h,l,t,"minute"):l>=o?u(h,l,o,"second"):h+" ms"}function u(h,l,p,g){var m=l>=p*1.5;return Math.round(h/p)+" "+g+(m?"s":"")}return Re}function Bn(o){s.debug=s,s.default=s,s.coerce=d,s.disable=i,s.enable=r,s.enabled=a,s.humanize=Tn(),s.destroy=u,Object.keys(o).forEach(h=>{s[h]=o[h]}),s.names=[],s.skips=[],s.formatters={};function t(h){let l=0;for(let p=0;p<h.length;p++)l=(l<<5)-l+h.charCodeAt(p),l|=0;return s.colors[Math.abs(l)%s.colors.length]}s.selectColor=t;function s(h){let l,p=null,g,m;function y(...f){if(!y.enabled)return;const b=y,x=Number(new Date),T=x-(l||x);b.diff=T,b.prev=l,b.curr=x,l=x,f[0]=s.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let M=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(S,w)=>{if(S==="%%")return"%";M++;const k=s.formatters[w];if(typeof k=="function"){const N=f[M];S=k.call(b,N),f.splice(M,1),M--}return S}),s.formatArgs.call(b,f),(b.log||s.log).apply(b,f)}return y.namespace=h,y.useColors=s.useColors(),y.color=s.selectColor(h),y.extend=n,y.destroy=s.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(g!==s.namespaces&&(g=s.namespaces,m=s.enabled(h)),m),set:f=>{p=f}}),typeof s.init=="function"&&s.init(y),y}function n(h,l){const p=s(this.namespace+(typeof l>"u"?":":l)+h);return p.log=this.log,p}function r(h){s.save(h),s.namespaces=h,s.names=[],s.skips=[];let l;const p=(typeof h=="string"?h:"").split(/[\s,]+/),g=p.length;for(l=0;l<g;l++)p[l]&&(h=p[l].replace(/\*/g,".*?"),h[0]==="-"?s.skips.push(new RegExp("^"+h.slice(1)+"$")):s.names.push(new RegExp("^"+h+"$")))}function i(){const h=[...s.names.map(c),...s.skips.map(c).map(l=>"-"+l)].join(",");return s.enable(""),h}function a(h){if(h[h.length-1]==="*")return!0;let l,p;for(l=0,p=s.skips.length;l<p;l++)if(s.skips[l].test(h))return!1;for(l=0,p=s.names.length;l<p;l++)if(s.names[l].test(h))return!0;return!1}function c(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}function d(h){return h instanceof Error?h.stack||h.message:h}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}var En=Bn;(function(o,t){t.formatArgs=n,t.save=r,t.load=i,t.useColors=s,t.storage=a(),t.destroy=(()=>{let d=!1;return()=>{d||(d=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let d;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(d=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(d[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(d){if(d[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+d[0]+(this.useColors?"%c ":" ")+"+"+o.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;d.splice(1,0,u,"color: inherit");let h=0,l=0;d[0].replace(/%[a-zA-Z%]/g,p=>{p!=="%%"&&(h++,p==="%c"&&(l=h))}),d.splice(l,0,u)}t.log=console.debug||console.log||(()=>{});function r(d){try{d?t.storage.setItem("debug",d):t.storage.removeItem("debug")}catch{}}function i(){let d;try{d=t.storage.getItem("debug")}catch{}return!d&&typeof process<"u"&&"env"in process&&(d=process.env.DEBUG),d}function a(){try{return localStorage}catch{}}o.exports=En(t);const{formatters:c}=o.exports;c.j=function(d){try{return JSON.stringify(d)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(Ae,Ae.exports);var $=Ae.exports;const kt=De($),Fn=$.debug("TextNlAsBr");class On{constructor(t,s){this.baseText=t,this.factories=s}asString(t){return this.baseText.asString(this.factories.guestInTheMiddle.create(t,s=>{if(typeof s>"u"||s===null)return"";const n="<br />";return Fn(s),t.give((s??"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,`$1${n}$2`)),!0})),t}}const Mn=new F(ce),jn=new F(ce),Pn=new F(re),In=new F(Y),Dn=new F(ne),An=new F(Pe),Rn=new F(me),Ln=new F(Rs),zn=new F(Hs),vn=new F(ne),Hn=new F(Ds),Un=new F(As),J={cache:Mn,chain:Hn,guest:In,guestCast:Dn,guestAware:An,guestInTheMiddle:vn,guestSync:Un,patron:Ln,patronOnce:zn,pool:Rn,source:jn,sourceEmpty:Pn},Kn=new F(Ws),Gn=new F(qs),Wn=new F(Js),qn=new F(Qs),xt=new F(Xs),Qn=new F(Ys,{...J,svgImage:xt}),Jn=new F(Zs,J),Xn=new F(en,J),Yn=new F(tn,J),Zn=new F($n,J),er=new F(Vn),tr=new F(Sn,J),sr=new F(On,J),nr={...J,fileHandlerContent:Kn,browserFileSaved:Gn,transformToString:Wn,transformToObject:qn,svgImage:xt,svgMapTypeImage:Qn,numberChunks:Jn,mapNameFromUrl:Xn,textNoHtml:Yn,jsonp:Zn,textOf:er,textNlAsBr:sr,textWithoutHTML:tr},A=()=>nr;class Le{constructor(t,s,n){this.notification=t,this.check=s,this.factories=n}breakOnFail(t,s){return this.check.check(t,this.factories.guest.create(n=>{n===!0?s.give(!0):this.notification.give({type:"error",text:n})})),this}continueOnFail(t,s){return this.check.check(t,this.factories.guest.create(n=>{s.give(n),n!==!0&&this.notification.give({type:"error",text:n})})),this}}const ze=$.debug("MapCurrent");class _t{constructor(t,s,n){_(this,"objectsCache");_(this,"settingsCache");_(this,"typesCache");this.mapFile=t,this.mapId=s,this.factories=n,this.objectsCache=n.sourceEmpty.create(),this.settingsCache=n.sourceEmpty.create(),this.typesCache=n.sourceEmpty.create(),t.currentMap(n.patron.create(n.guest.create(r=>{ze("current map changed",r),this.settingsCache.give(r.settings),this.objectsCache.give(Object.values(r.objects)),this.typesCache.give(Object.entries(r.types).map(([i,a])=>({...a,id:i})))})))}settings(t){return this.settingsCache.value(t),t}objects(t){return ze("notify about new objects"),this.objectsCache.value(t),t}types(t){return this.typesCache.value(t),t}give(t){return ze("save map document",t),this.mapId.id(this.factories.guest.create(s=>{this.mapFile.mapFile(this.factories.guest.create(n=>{this.mapFile.give({...n,[s]:t})}))})),this}}class rr{constructor(t){_(this,"idCache");this.idCache=t.cache.create("current")}id(t){return this.idCache.value(t),t}give(t){return this.idCache.give(t),this}}class or{constructor(t){this.mapFile=t}value(t){return this.mapFile.currentMap(new ne(t,s=>{t.give(s.settings.title)})),this}}const xe=$.debug("MapHistory"),Nt=o=>{const t=JSON.parse(JSON.stringify(o));return Object.values(t.objects).forEach(s=>{s.width=0,s.height=0}),JSON.stringify(t)};class ir{constructor(t,s,n,r){_(this,"mapsHistory");_(this,"historyIndex");this.mapFile=t,this.map=s,this.mapId=n,this.factories=r,this.mapsHistory=r.cache.create([]),this.historyIndex=r.cache.create(0),this.mapFile.currentMap(r.patron.create(this)),this.mapId.id(r.patron.create(r.guest.create(()=>{this.mapsHistory.give([]),this.historyIndex.give(0)})))}give(t){return requestIdleCallback(()=>{this.historyIndex.value(this.factories.guest.create(s=>{this.mapsHistory.value(this.factories.guest.create(n=>{xe("add map to history",n,t);const r=n.some(i=>Nt(i)===Nt(t));if(xe("isMapFromHistory",r),!r){const i=n[s]?[n[s]]:[];this.historyIndex.give(0),this.mapsHistory.give([t,...i,...n.slice(0,9)])}}))}))}),this}isPrevPossible(t){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(t,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(t,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(t,({historyIndex:n,mapsHistory:r})=>{const i=n<r.length-1;xe("recalculate is prev possible",i),t.give(i)})),t}prev(){this.historyIndex.value(this.factories.guest.create(t=>{const s=t+1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(n=>{const r=n[s];this.map.give(r)}))}))}isNextPossible(t){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(t,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(t,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(t,({historyIndex:n,mapsHistory:r})=>{const i=n>0&&n<=r.length-1;xe("recalculate is next possible",i),t.give(i)})),t}next(){this.historyIndex.value(this.factories.guest.create(t=>{const s=t-1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(n=>{const r=n[s];this.map.give(r)}))}))}}class ar{constructor(t,s,n){this.mapFile=t,this.mapId=s,this.factories=n}give(t){const{guest:s}=this.factories;return this.mapFile.mapFile(s.create(n=>{delete n[t],this.mapFile.give(n),this.mapId.give("current")})),this}}const _e=$.debug("MapFileOfContent");class cr{constructor(t,s,n){_(this,"currentMapPatrons");_(this,"mapFileCache");this.mapFileContent=t,this.mapId=s,this.factories=n,this.currentMapPatrons=n.pool.create(this),this.mapFileCache=n.cache.create(!1),t.value(n.patron.create(r=>{if(!r)return;const i=this.factories.transformToObject.create(r).result();_e("get map file",i),this.mapFileCache.give(i)}))}currentMap(t){const s=this.factories.chain.create();return this.mapId.id(this.factories.guestCast.create(t,s.receiveKey("mapId"))),this.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({mapId:n,mapFile:r})=>{if(_e("get current map",n,r,typeof r),!r[n])this.createEmptyMapByName(n,t);else{const i=r[n];this.currentMapPatrons.distribute(i!=null&&i.structure?i.structure:i,t)}})),t}give(t){return _e("save map file document",t),this.mapFileContent.give(this.factories.transformToString.create(t).result()),this}mapFile(t){return this.mapFileCache.value(t),t}createEmptyMapByName(t,s){_e("creating empty map by name",t);const n=this.factories.transformToObject.create(this.generateEmptyMapFile()).result();this.mapFile(this.factories.guest.create(r=>{this.give({...r,[t]:n.current}),s.give(n.current)}))}generateEmptyMapFile(){return'{"current":{"progress":0,"settings":{"colored":false,"title":"current"},"objects":{},"types":{},"url":"/current","parent":""}}'}}const lr=$.debug("MapFileForRendering");class dr{constructor(t,s,n){_(this,"mapCache");this.mapId=s,this.factories=n,this.mapCache=n.cache.create({objects:{},types:{},settings:{}}),t.currentMap(n.patron.create(this.mapCache))}currentMap(t){return this.mapCache.value(t),t}mapFile(t){return this.mapCache.value(this.factories.guestInTheMiddle.create(t,s=>{this.mapId.id(this.factories.guest.create(n=>{t.give({[n]:s})}))})),t}give(t){return this.mapId.id(this.factories.guest.create(s=>{lr("received map file, objects = ",t[s].objects),this.mapCache.give(t[s])})),this}}class $t{constructor(t,s,n){this.map=t,this.mapFile=s,this.factories=n}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,objects:{...s.objects,[t.id]:{...t,createTimestamp:t.createTimestamp??Date.now(),changeTimestamp:Date.now()}}})})),this}}const Vt=kt("app:MapObjectCurrent");class hr{constructor(t,s){_(this,"idCache");_(this,"silenceActivator");this.drawer=t,this.factories=s,this.idCache=s.sourceEmpty.create(),this.silenceActivator=s.source.create(!1),this.idCache.value(s.patron.create(s.guest.create(n=>{n&&t.give("object")})))}silenceOn(t){return this.silenceActivator.give(t),this}silenceOff(){return this.silenceActivator.give(!1),this}objectId(t){return this.idCache.value(t),t}give(t){return Vt("new value current object",t),this.silenceActivator.value(this.factories.guest.create(s=>{Vt("silence activator",s),s?s.give(t):this.idCache.give(t)})),this}}class pr{constructor(t,s){this.mapFile=t,this.factories=s}check(t,s){return this.mapFile.currentMap(this.factories.guest.create(n=>{let r=!1;Object.values(n.objects).forEach(i=>{r=r||i.arrows.some(a=>a.id===t.id)}),s.give(!r||"У объекта есть входящие связи!")})),this}}const ve=$.debug("MapObjectNew");class ur{constructor(t,s,n,r,i){this.map=t,this.mapObject=s,this.canvas=n,this.stagePosition=r,this.factories=i}byTypeName(t,s){return ve("start to add new type",t,s),this.stagePosition.position(this.factories.guest.create(n=>{this.map.types(this.factories.guest.create(r=>{this.canvas.canvas(this.factories.guest.create(i=>{const a=i.getBoundingClientRect(),c=r.find(h=>h.id===t);ve("is type found",c);const d=s.x-a.left,u=s.y-a.top;c&&(ve("add new type"),this.mapObject.give({additionalName:"",arrows:[],description:"",inMenu:!1,lastClick:Date.now(),linked:!1,menuOrder:0,name:"",outlink:"",targetBlank:!1,type:t,width:c.width,height:c.height,zindex:0,id:new Date().getTime().toString(),createTimestamp:Date.now(),changeTimestamp:Date.now(),position:[d>0?d+n.x:0,u>0?u+n.y:0]}))}))}))})),this}}class fr{constructor(t,s){this.mapId=t,this.factories=s}names(t){return this.mapId.id(this.factories.guestInTheMiddle.create(t,s=>{const n=s.split("_").filter(a=>!!a);let r="";const i=n.map(a=>{const c=`${r}${a}`;return r||(r="_"),r+=`${a}_`,c});r="",t.give(i)})),t}}class mr{constructor(t){this.mapObject=t}give(t){const{arrows:s}=t.object;return s.splice(t.index,1),this.mapObject.give({...t.object,arrows:s}),this}}class gr{constructor(t,s,n,r){this.map=t,this.mapFile=s,this.checks=n,this.factories=r}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail(t,s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.objects[t.id],this.map.give(n)}))})),this}}const yr=$.debug("MapObjectsLink");class br{constructor(t,s,n,r,i){_(this,"objectIdsCache");this.mapObjectCurrent=t,this.map=s,this.mapObject=n,this.newArrow=r,this.factories=i,this.objectIdsCache=i.cache.create([])}objectIds(t){return this.objectIdsCache.value(t),t}startLink(){this.mapObjectCurrent.give(""),this.objectIdsCache.value(this.factories.guest.create(t=>{if(t.length){this.mapObjectCurrent.silenceOff(),this.objectIdsCache.give([]);return}const s=["first"];this.objectIdsCache.give(s),this.mapObjectCurrent.silenceOn(this.factories.guest.create(n=>{s.push(n),this.objectIdsCache.give([...s]),yr("object ids",s),s.length===2&&this.map.objects(this.factories.guest.create(r=>{const[,i]=s,a=r.find(c=>c.id===i);a&&this.newArrow.forObject(a)})),s.length===3&&(this.newArrow.dispose(),this.mapObjectCurrent.silenceOff(),this.map.objects(this.factories.guest.create(r=>{const[,i,a]=s,c=r.find(d=>d.id===i);c&&a&&(this.objectIdsCache.give([]),this.mapObject.give({...c,arrows:[...c.arrows,{id:a,label:""}]}))})))}))}))}}function wr(o){var t=typeof o;return o!=null&&(t=="object"||t=="function")}var He=wr,Cr=typeof ke=="object"&&ke&&ke.Object===Object&&ke,kr=Cr,xr=kr,_r=typeof self=="object"&&self&&self.Object===Object&&self,Nr=xr||_r||Function("return this")(),St=Nr,$r=St,Vr=function(){return $r.Date.now()},Sr=Vr,Tr=/\s/;function Br(o){for(var t=o.length;t--&&Tr.test(o.charAt(t)););return t}var Er=Br,Fr=Er,Or=/^\s+/;function Mr(o){return o&&o.slice(0,Fr(o)+1).replace(Or,"")}var jr=Mr,Pr=St,Ir=Pr.Symbol,Tt=Ir,Bt=Tt,Et=Object.prototype,Dr=Et.hasOwnProperty,Ar=Et.toString,de=Bt?Bt.toStringTag:void 0;function Rr(o){var t=Dr.call(o,de),s=o[de];try{o[de]=void 0;var n=!0}catch{}var r=Ar.call(o);return n&&(t?o[de]=s:delete o[de]),r}var Lr=Rr,zr=Object.prototype,vr=zr.toString;function Hr(o){return vr.call(o)}var Ur=Hr,Ft=Tt,Kr=Lr,Gr=Ur,Wr="[object Null]",qr="[object Undefined]",Ot=Ft?Ft.toStringTag:void 0;function Qr(o){return o==null?o===void 0?qr:Wr:Ot&&Ot in Object(o)?Kr(o):Gr(o)}var Jr=Qr;function Xr(o){return o!=null&&typeof o=="object"}var Yr=Xr,Zr=Jr,eo=Yr,to="[object Symbol]";function so(o){return typeof o=="symbol"||eo(o)&&Zr(o)==to}var no=so,ro=jr,Mt=He,oo=no,jt=NaN,io=/^[-+]0x[0-9a-f]+$/i,ao=/^0b[01]+$/i,co=/^0o[0-7]+$/i,lo=parseInt;function ho(o){if(typeof o=="number")return o;if(oo(o))return jt;if(Mt(o)){var t=typeof o.valueOf=="function"?o.valueOf():o;o=Mt(t)?t+"":t}if(typeof o!="string")return o===0?o:+o;o=ro(o);var s=ao.test(o);return s||co.test(o)?lo(o.slice(2),s?2:8):io.test(o)?jt:+o}var po=ho,uo=He,Ue=Sr,Pt=po,fo="Expected a function",mo=Math.max,go=Math.min;function yo(o,t,s){var n,r,i,a,c,d,u=0,h=!1,l=!1,p=!0;if(typeof o!="function")throw new TypeError(fo);t=Pt(t)||0,uo(s)&&(h=!!s.leading,l="maxWait"in s,i=l?mo(Pt(s.maxWait)||0,t):i,p="trailing"in s?!!s.trailing:p);function g(S){var w=n,k=r;return n=r=void 0,u=S,a=o.apply(k,w),a}function m(S){return u=S,c=setTimeout(b,t),h?g(S):a}function y(S){var w=S-d,k=S-u,N=t-w;return l?go(N,i-k):N}function f(S){var w=S-d,k=S-u;return d===void 0||w>=t||w<0||l&&k>=i}function b(){var S=Ue();if(f(S))return x(S);c=setTimeout(b,y(S))}function x(S){return c=void 0,p&&n?g(S):(n=r=void 0,a)}function T(){c!==void 0&&clearTimeout(c),u=0,n=d=r=c=void 0}function M(){return c===void 0?a:x(Ue())}function I(){var S=Ue(),w=f(S);if(n=arguments,r=this,d=S,w){if(c===void 0)return m(d);if(l)return clearTimeout(c),c=setTimeout(b,t),g(d)}return c===void 0&&(c=setTimeout(b,t)),a}return I.cancel=T,I.flush=M,I}var It=yo;const oe=De(It),bo=o=>{if(o[o.length-1]==="/"){const t=o.split("");return t.splice(t.length-1,1),t.join("")}return o},wo=oe(o=>{window==null||window.open(o)},200),Ke=$.debug("MapObjectUrl");class Co{constructor(t,s){this.mapId=t,this.factories=s}open(t,s){if(t!=null&&t.linked){const n=t.outlink;t.targetBlank?wo(n):(Ke("open new map",n),this.factories.mapNameFromUrl.create(this.factories.source.create(n)).name(this.factories.guest.create(i=>{Ke("open map name",n,i),s.give(i)})))}return this}url(t,s){return t.value(this.factories.guestInTheMiddle.create(s,n=>{this.mapId.id(this.factories.guest.create(r=>{const i=r[0]==="_"?r.replaceAll("_","/"):"/current",a=n.name?n.name:n.additionalName?n.additionalName:"";this.factories.textNoHtml.create(this.factories.source.create(a)).noHtml(this.factories.guest.create(c=>{let d=n.outlink?n.outlink:`${i}/${ko(c)}`;Ke("link is",d),d=bo(d),s.give(d)}))}))})),s}}function ko(o){return o.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}const xo=$.debug("ObjectPositionBounds");class _o{constructor(t,s){this.stageSize=t,this.factories=s}position(t,s,n){return this.stageSize.value(this.factories.guestInTheMiddle.create(n,r=>{let{x:i,y:a}=s;i<30&&(i=30),a<30&&(a=30);const c=r.width-t.width;i>c&&(i=c);const d=r.height-t.height;a>d&&(a=d),xo("position",i,a),n.give({x:i,y:a})})),n}}const Ne=15;class No{constructor(t,s){this.baseRestriction=t,this.factories=s}position(t,s,n){return this.baseRestriction.position(t,s,this.factories.guestInTheMiddle.create(n,r=>{n.give({x:Math.round(r.x/Ne)*Ne,y:Math.round(r.y/Ne)*Ne})})),n}}const Dt={x:"width",y:"height"},Ge={x:0,y:1},$o={positive:1,negative:-1},At=$.debug("ObjectsOutsideScreen");class Vo{constructor(t,s,n,r){this.map=t,this.stageSize=s,this.layer=n,this.factories=r}count(t,s){const n=t.direction==="positive",r=this.factories.chain.create();return this.map.objects(this.factories.guestCast.create(s,r.receiveKey("objects"))),this.layer.layer(this.factories.guestCast.create(s,r.receiveKey("layer"))),this.layer.position(this.factories.guestCast.create(s,r.receiveKey("position"))),r.result(this.factories.guestInTheMiddle.create(s,({objects:i,layer:a,position:c})=>{var l;const d=$o[t.direction],h=i.sort((p,g)=>p.position[Ge[t.axis]]*d-g.position[Ge[t.axis]]*d).filter(p=>{const g=p.position[Ge[t.axis]]+(n?0:p[Dt[t.axis]]),m=c[t.axis]*-1+(n?a[Dt[t.axis]]():0);return At("mb nearest points",t.direction,"objectP=",g,"screenP=",m),n?g>m:g<m});At("nearest",h),s.give({count:h.length,nearestObjectId:((l=h.at(n?-1:0))==null?void 0:l.id)??""})})),s}}class So{constructor(t,s,n){this.mapFile=t,this.map=s,this.factories=n}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,settings:t})})),this}}class To{constructor(t){_(this,"idCache");this.idCache=t.sourceEmpty.create()}typeId(t){return this.idCache.value(t),t}give(t){return this.idCache.give(t),this}}class Bo{constructor(t){this.mapType=t}byName(){const t=String(new Date().getTime());this.mapType.give({name:t,type:{id:t,name:"Новый тип",svg:'<div style="background: lightyellow;border: 1px solid #ccc;">type</div>',width:100,height:40}})}}class Eo{constructor(t,s,n,r){this.map=t,this.mapFile=s,this.checks=n,this.factories=r}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail({name:t.id,type:t},s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.types[t.id],this.map.give(n)}))})),this}}class Fo{constructor(t,s,n,r){this.map=t,this.mapFile=s,this.checks=n,this.factories=r}give(t){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail(t,s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.types[t.name],this.map.give({...n,types:{...n.types,[t.type.name]:t.type}})}))})),this}}const Oo=$.debug("MapTypeUsed");class Mo{constructor(t,s){this.mapFile=t,this.factories=s}check(t,s){return this.mapFile.currentMap(this.factories.guest.create(n=>{const r=Object.values(n.objects).some(i=>i.type===t.name);Oo("is type used",r),s.give(!r||"Тип карты использован")})),this}}class jo{constructor(t,s){this.mapTypeUsedCheck=t,this.factories=s}check(t,s){return this.mapTypeUsedCheck.check(t,this.factories.guest.create(n=>{n!==!0&&t.name!==t.type.name?s.give("Нельзя изменять имя типа, который использован!"):s.give(!0)})),this}}const Rt=$.debug("ParentTypes");class Po{constructor(t,s,n){this.parentNames=t,this.mapFile=s,this.factories=n}types(t){Rt("parent types requested");const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(t,s.receiveKey("parentNames"))),this.mapFile.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({parentNames:n,mapFile:r})=>{const i=n.slice(0,-1);Rt("parent names",i);const a={};i.map(d=>r[d]).forEach(d=>{Object.values(d.types).forEach(u=>{a[u.name]=u})}),t.give(Object.values(a))})),t}}const Lt=$.debug("ObjectsMatchedToQuery");class Io{constructor(t,s){this.map=t,this.factories=s}objects(t,s){return t.value(this.factories.guestInTheMiddle.create(s,oe(r=>{r=r.toLowerCase(),this.map.objects(this.factories.guest.create(i=>{if(!r){Lt("reset results"),s.give([]);return}const a=i.filter(c=>{var d;return c.name.toLowerCase().includes(r)||((d=c.additionalName)==null?void 0:d.toLowerCase().includes(r))||Object.values(c.additionalFields??{}).join(" ").toLowerCase().includes(r)});Lt("objects in searching",a,r),s.give(a)}))},500))),s}}const Do={height:3e3,width:3e3};class Ao{value(t){return t.give(Do),t}}const zt=$.debug("StageMoveRestriction");class Ro{constructor(t,s,n){this.canvasDep=t,this.stageSize=s,this.factories=n}position(t,s){return this.canvasDep.canvas(this.factories.guest.create(n=>{this.stageSize.value(this.factories.guest.create(r=>{zt("income position",t);const i=r.width-n.clientWidth,a=r.height-n.clientHeight,c=t.x*-1,d=t.y*-1;if(a<0||i<0)return{x:0,y:0};zt("boundings",a,i,d,c),s.give({x:t.x>0?0:c>i?i*-1:t.x,y:t.y>0?0:d>a?a*-1:t.y})}))})),s}}const he=$.debug("app:MapObjectsVisible");class Lo{constructor(t,s,n,r){_(this,"visibleObjectsCache",new re);he("constructor initialized");const i=r.chain.create();s.size(r.patron.create(i.receiveKey("size"))),t.position(r.patron.create(i.receiveKey("position"))),n.currentMap(r.patron.create(i.receiveKey("map"))),i.result(r.patron.create(r.guest.create(({position:a,size:c,map:d})=>{const u=Object.values(d.objects);he("objects come to result",u);const h=u.filter(l=>{const p=d.types[l.type]??{},g={width:l.width||p.width,height:l.height||p.height};return this.isInBounding(a,c,l.position,g)});he("visible objects calculated",h),this.visibleObjectsCache.give(h)})))}objects(t){return this.visibleObjectsCache.value(t),this}isInBounding(t,s,n,r){const i=t.x,a=t.x-s.width,c=t.y,d=t.y-s.height,[u,h]=n;return he("bounding vars",i,a,c,d),he("object position",n),i>-u-r.width&&-u>a&&c>-h-r.height&&-h>d}}const zo=(o,t)=>{const s=o.matchAll(t);return Array.from(s).map(n=>n[1])},vo=(o,t)=>o.reduce((s,n)=>(s[n]=t[n]||n,s),{});class Ho{constructor(t,s,n,r){this.mapFile=s,this.mapObject=n,this.factories=r,t.objectId(this)}give(t){return this.mapFile.currentMap(this.factories.guest.create(s=>{const n=s.objects[t];if(!n)return;const r=s.types[n.type],i=/\$\{([a-zA-Z1-9]+)\}/g,c=zo(r.svg,i).filter(d=>d!=="width"&&d!=="height");n.additionalFields=vo(c,n.additionalFields??{}),this.mapObject.give(n)})),this}introduction(){return"patron"}}class Uo{constructor(){_(this,"filledPoints",new Map)}clear(){this.filledPoints.clear()}breakPoints(t,s,n){const r=this.arrowPointPosition(t.shapeGeometry,t.shapePosition,t.lookToGeometry,t.lookToPosition),i=this.arrowPointPosition(s.shapeGeometry,s.shapePosition,s.lookToGeometry,s.lookToPosition);return n.give([+r.point.x+r.shift.x,+r.point.y+r.shift.y,+r.breakPoint.x+r.shift.x,+r.breakPoint.y+r.shift.y,+i.breakPoint.x+i.shift.x,+i.breakPoint.y+i.shift.y,+i.point.x+i.shift.x,+i.point.y+i.shift.y]),this}arrowPointPosition(t,s,n,r){const i={x:+r.x+Math.round(n.width/2),y:+r.y+Math.round(n.height/2)},a={x:+s.x+Math.round(t.width/2),y:+s.y+Math.round(t.height/2)},c=a.x-i.x,d=a.y-i.y,u=Math.abs(d)>Math.abs(c);let h=+s.x,l=+s.y;const p=u&&d>=0,g=!u&&c>=0,m=u&&d<0,y=!u&&c<0,f={x:0,y:0};let b=0,x=0;p?(h+=Math.round(t.width/2),f.x=h,f.y=(s.y+r.y+n.height)/2,b=r.x>s.x?1:-1):y?(l+=Math.round(t.height/2),h+=+t.width,f.x=(s.x+t.width+r.x)/2,f.y=l,x=r.y>s.y?1:-1):m?(h+=Math.round(t.width/2),l+=+t.height,f.x=h,f.y=(s.y+t.height+r.y)/2,b=r.x>s.x?1:-1):g&&(l+=Math.round(t.height/2),f.x=(s.x+r.x+n.width)/2,f.y=l,x=r.y>s.y?1:-1);const T=[h,l].join("-"),M=this.filledPoints.get(T)||0;return this.filledPoints.set(T,M+1),{point:{x:h,y:l},breakPoint:f,shift:{x:b*M*10,y:x*M*10}}}}var Ko=It,Go=He,Wo="Expected a function";function qo(o,t,s){var n=!0,r=!0;if(typeof o!="function")throw new TypeError(Wo);return Go(s)&&(n="leading"in s?!!s.leading:n,r="trailing"in s?!!s.trailing:r),Ko(o,t,{leading:n,maxWait:t,trailing:r})}var Qo=qo;const Jo=De(Qo),$e=$.debug("MapObjectsArrows");class Xo{constructor(t,s,n,r,i){_(this,"previouslyRenderedArrows",new Map);this.konvaLayer=t,this.mapFile=s,this.mapDep=n,this.arrowPath=r,this.factories=i,$e("draw arrows on canvas");const a=this.factories.chain.create();this.konvaLayer.layer(this.factories.patron.create(a.receiveKey("layer"))),this.mapFile.currentMap(this.factories.patron.create(a.receiveKey("map"))),this.mapDep.objects(this.factories.patron.create(a.receiveKey("objects"))),a.result(this.factories.patron.create(this.factories.guest.create(Jo(({layer:c,map:d,objects:u})=>{const h=(l,p)=>{const g=d.types[p.type];this.arrowPath.breakPoints({shapeGeometry:{width:l.width,height:l.height},shapePosition:{x:l.position[0],y:l.position[1]},lookToGeometry:{width:p.width,height:p.height},lookToPosition:{x:p.position[0],y:p.position[1]}},{shapeGeometry:{width:p.width||g.width,height:p.height||g.height},shapePosition:{x:p.position[0],y:p.position[1]},lookToGeometry:{width:l.width,height:l.height},lookToPosition:{x:l.position[0],y:l.position[1]}},this.factories.guest.create(m=>{const y=m.join("-"),f=[l.id,p.id].join("-");if($e("points",m),$e(l,p),this.previouslyRenderedArrows.has(f)){const x=this.previouslyRenderedArrows.get(f);x.arrow.show(),x.arrow.points(m);return}const b=new X.Arrow({x:0,y:0,points:m,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2});this.previouslyRenderedArrows.set(f,{arrow:b,arrowKey:y}),c.add(b)}))};this.arrowPath.clear(),this.previouslyRenderedArrows.forEach(l=>l.arrow.hide()),u.forEach(l=>{l.arrows&&($e("visible objects",u.length),l.arrows.forEach(p=>{const g=u.find(m=>m.id===p.id)||d.objects[p.id];g&&h(l,g)}))})},50))))}introduction(){return"patron"}}const We=$.debug("NewArrow"),vt={width:10,height:10};class Yo{constructor(t,s,n,r){_(this,"cursorGuest");_(this,"arrowCache");this.konvaLayer=t,this.cursorPosition=s,this.arrowPath=n,this.factories=r,this.cursorGuest=this.factories.sourceEmpty.create(),this.arrowCache=this.factories.sourceEmpty.create()}forObject(t){We("start watch cursor"),this.cursorGuest.value(this.factories.guest.create(r=>{at(r)}));let s=null;const n=this.factories.patron.create(this.factories.guest.create(r=>{We("cursor moves"),this.konvaLayer.layer(this.factories.guest.create(i=>{We("cursor moves in layer"),this.arrowPath.breakPoints({shapeGeometry:{width:t.width,height:t.height},shapePosition:{x:t.position[0],y:t.position[1]},lookToGeometry:vt,lookToPosition:r},{lookToGeometry:{width:t.width,height:t.height},lookToPosition:{x:t.position[0],y:t.position[1]},shapeGeometry:vt,shapePosition:r},this.factories.guest.create(a=>{if(s){s.points(a);return}s=new X.Arrow({x:0,y:0,points:a,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2}),i.add(s),this.arrowCache.give(s)}))})),this.arrowPath.clear()}));this.cursorPosition.value(n),this.cursorGuest.give(n)}dispose(){this.cursorGuest.value(this.factories.guest.create(t=>{at(t)})),this.arrowCache.value(this.factories.guest.create(t=>{t.remove()}))}}const qe=$.debug("MapObjectBackground");class Zo{constructor(t,s,n,r){_(this,"mapNameCache");this.konvaLayer=t,this.mapFile=s,this.zIndex=n,this.factories=r,this.mapNameCache=r.cache.create(""),this.mapFile.currentMap(r.patron.create(this))}give(t){return this.konvaLayer.layer(this.factories.patronOnce.create(s=>{qe("map received in background",t),this.mapNameCache.value(this.factories.guest.create(n=>{if(n===t.url)return;qe("background cache is not equals",n),this.mapNameCache.give(t.url),new Image;const r=document.querySelector(".grid-example");qe("grid example",r)}))})),this}}const ei=$.debug("Breadcrumbs");class ti{constructor(t,s,n){this.parentNames=t,this.mapFile=s,this.factories=n}list(t){const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(t,s.receiveKey("names"))),this.mapFile.mapFile(this.factories.guestCast.create(t,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(t,({names:n,mapFile:r})=>{ei("map id",n,r),t.give(n.map(i=>{var a,c;return{title:((c=(a=r[i])==null?void 0:a.settings)==null?void 0:c.title)||"unknown",name:i}}))})),t}}const Ht=$.debug("CursorWithObjects");class si{constructor(t,s,n){this.objectsVisible=t,this.cursor=s,this.factories=n}value(t){const s=this.factories.chain.create();return this.cursor.value(this.factories.guestCast.create(t,s.receiveKey("cursor"))),this.objectsVisible.objects(this.factories.guestCast.create(t,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(t,({cursor:n,objects:r})=>{const i=r.find(a=>{const c=a.position[0],d=a.position[0]+a.width||100,u=a.position[1],h=a.position[1]+a.height||100;return n.x>=c&&n.x<=d&&n.y>=u&&n.y<=h});i?(Ht("crossed with",i),t.give({x:i.position[0]+i.width/2,y:i.position[1]+i.height/2})):(Ht("cursor pos",n),t.give(n))})),this}}const Ut=$.debug("Drawer");class ni{constructor(t,s){_(this,"drawerNameCache");this.keyboard=t,this.factories=s,this.drawerNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(n=>{Ut("new key in drawer",n),n==="Escape"&&this.give("")})))}isOpenedByName(t,s){return this.drawerNameCache.value(this.factories.guestInTheMiddle.create(s,n=>{Ut("new drawer name",n),s.give(n===t)})),s}openedByName(t){return this.factories.guestAware.create(s=>{this.isOpenedByName(t,s)})}give(t){return this.drawerNameCache.give(t),this}}class ri{value(t){typeof performance>"u"&&t.give(0);const s=10;let n=performance.now(),r=0;const i=()=>requestAnimationFrame(()=>{if(r+=1,r>=s){const a=performance.now(),c=a-n;t.give(Math.round(1e3/(c/r))),n=a,r=0}i()});return i(),t}}class oi{constructor(t,s){this.mapFile=t,this.factories=s}menuObjects(t){return this.mapFile.currentMap(this.factories.guestInTheMiddle.create(t,s=>{const n=Object.values(s.objects).filter(r=>r.inMenu);t.give(n)})),t}}const Kt=$.debug("app:MiniMap"),Gt=130;class ii{constructor(t,s,n,r){_(this,"theSize");_(this,"thePoints");_(this,"viewportSizeCache");this.map=t,this.layer=s,this.stageSize=n,this.factories=r,this.theSize=r.sourceEmpty.create(),this.thePoints=r.sourceEmpty.create(),this.viewportSizeCache=r.sourceEmpty.create();const i=r.chain.create();t.objects(r.patron.create(i.receiveKey("objects"))),s.layer(r.patron.create(i.receiveKey("layer"))),n.value(r.patron.create(i.receiveKey("size"))),i.result(r.patron.create(r.guest.create(({layer:a,size:c,objects:d})=>{const u=Gt/c.width,h={width:Math.round(a.width()*u),height:Math.round(a.height()*u)};this.viewportSizeCache.give(h);const l={width:Math.round(c.width*u),height:Math.round(c.height*u)};this.theSize.give(l);const p=d.map(g=>({id:g.id,x:Math.round(g.position[0]*u),y:Math.round(g.position[1]*u),width:Math.round(g.width*u),height:Math.round(g.height*u)}));Kt("minimap points",p),this.thePoints.give(p)})))}viewportPosition(t){const s=this.factories.chain.create();return this.stageSize.value(this.factories.guestCast.create(t,s.receiveKey("size"))),this.layer.position(this.factories.guestCast.create(t,s.receiveKey("position"))),s.result(this.factories.guestInTheMiddle.create(t,({size:n,position:r})=>{const i=Gt/n.width,a={x:r.x*i*-1,y:r.y*i*-1};Kt("scaled position is",a),t.give(a)})),t}viewportSize(t){return this.viewportSizeCache.value(t),t}size(t){return this.theSize.value(t),t}points(t){return this.thePoints.value(t),t}}const Wt=$.debug("Modal");class ai{constructor(t,s){_(this,"modalNameCache");this.keyboard=t,this.factories=s,Wt("modal created"),this.modalNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(n=>{Wt("new key in modal",n),n==="Escape"&&this.give("")})))}isOpenedByName(t,s){return this.modalNameCache.value(this.factories.guestInTheMiddle.create(s,n=>{s.give(n===t)})),s}openedByName(t){return this.factories.guestAware.create(s=>{this.isOpenedByName(t,s)})}give(t){return this.modalNameCache.give(t),this}}class ci{constructor(t){_(this,"messageCache");_(this,"notificationLifetimeDelay",3500);_(this,"lastTimerHead",null);this.messageCache=t.sourceEmpty.create()}message(t){return this.messageCache.value(t),t}give(t){return this.messageCache.give(t),this.lastTimerHead&&clearTimeout(this.lastTimerHead),this.lastTimerHead=setTimeout(()=>{this.messageCache.give({type:"success",text:"hide"})},this.notificationLifetimeDelay),this}}const pe=$.debug("ObjectGeometryFix");class li{constructor(t,s,n,r){_(this,"innerReceive");this.mapFile=s,this.map=n,this.factories=r,t.objects(r.patron.create(this)),this.innerReceive=oe(i=>{this.mapFile.currentMap(this.factories.guest.create(a=>{pe("objects to fix",i);const c=document.querySelectorAll(".objects-container .rendered-object"),d=a.objects;let u=!1;c.forEach(h=>{const l=h.getAttribute("data-object-id");if(pe("i see id",l),!l)return;const p=d[l];if(p&&(pe("dom object geometry",h.clientWidth,h.clientHeight),pe("saved object geometry",p.width,p.height),(p.width!==h.clientWidth||p.height!==h.clientHeight)&&(u=!0,pe("update object geometry"),p.width=h.clientWidth,p.height=h.clientHeight),!p.width||!p.height)){const g=a.types[p.type];p.width=g.width,p.height=g.height}}),u&&this.map.give({...a,objects:d})}))},500)}give(t){return this.innerReceive(t),this}}const ue=$.debug("MapObjectsRectsPatron");class di{constructor(t,s,n,r,i,a,c,d,u){_(this,"previouslyRenderedRects",new Map);this.konvaLayer=t,this.mapFile=s,this.mapObject=n,this.mapObjectCurrent=i,this.mapObjectForRendering=a,this.objectPosition=c,this.settings=d,this.factories=u,r.objects(this)}give(t){return this.konvaLayer.layer(this.factories.patronOnce.create(this.factories.guest.create(s=>{const n=this.factories.chain.create();this.mapFile.currentMap(n.receiveKey("map")),this.settings.value(n.receiveKey("settings")),n.result(this.factories.guest.create(r=>{const{map:i,settings:a}=r;ue("rerender object rects"),this.previouslyRenderedRects.forEach(c=>{c.hide()}),t.forEach(c=>{const d=i.types[c.type],u=+c.width||+d.width||100,h=+c.height||+d.height||100;if(this.previouslyRenderedRects.has(c)){const p=this.previouslyRenderedRects.get(c);p.width(u),p.height(h),p.x(+c.position[0]),p.y(+c.position[1]),p.show();return}ue("rect object",c,d);const l=new _s.Rect({x:+c.position[0],y:+c.position[1],width:u,height:h,name:c.id,draggable:!a.readonly,objectId:c.id,zIndex:3});this.previouslyRenderedRects.set(c,l),s.add(l),l.on("mouseenter",()=>{s.getStage().container().style.cursor="pointer"}),l.on("mouseleave",()=>{s.getStage().container().style.cursor="default"}),l.on("dragend",()=>{ue("drag ended"),this.objectPosition.position(c,{x:l.x(),y:l.y()},this.factories.guest.create(p=>{this.mapObject.give({...c,position:[p.x,p.y]})}))}),l.on("dragmove",()=>{ue("dragmove works",l.x(),l.y()),s.getStage().container().style.cursor="move",this.objectPosition.position(c,{x:l.x(),y:l.y()},this.factories.guest.create(p=>{this.mapObjectForRendering.give({...c,position:[p.x,p.y]})}))}),l.on("click",()=>{ue("object clicked with id",c.id),this.mapObjectCurrent.give(c.id)})})}))}))),this}introduction(){return"patron"}}class hi{constructor(t,s,n,r){this.canvas=s,this.konvaLayer=n,this.factories=r,t.currentMap(this)}give(){const t=new ResizeObserver(n=>{requestAnimationFrame(()=>{const[r]=n;this.canvas.canvas(this.factories.guest.create(i=>{const a=i.getBoundingClientRect();this.konvaLayer.layer(this.factories.guest.create(c=>{c.getStage().width(r.contentRect.width-a.left),c.getStage().height(r.contentRect.height-a.top),this.canvas.give(i),this.konvaLayer.give(c)}))}))})}),s=document.querySelector("body");return s&&t.observe(s),this}}const pi=$.debug("StagePosition");class ui{constructor(t){this.stageMove=t}give(t){return pi("received position",t),this.stageMove.move(t),this}}class fi{constructor(t,s){this.stageMove=t,this.factories=s}move(t,s){return t.value(this.factories.guest.create(n=>{this.stageMove.move(n.objects[s])})),this}}const qt=$.debug("Zindex");class mi{constructor(t){_(this,"fnsCache");this.factories=t,this.fnsCache=t.cache.create([]),this.fnsCache.value(t.patron.create(t.guest.create(oe(s=>{qt("zindex fns run"),s.forEach(n=>n())},50))))}give(t){return qt("zindex received value"),this.fnsCache.value(this.factories.guest.create(s=>{this.fnsCache.give(s.concat(t))})),this}}const Qt=$.debug("app:BrowserCanvas");class gi{constructor(t){_(this,"canvasCache");this.factories=t,this.canvasCache=t.sourceEmpty.create()}canvas(t){return this.canvasCache.value(t),this}size(t){return this.canvasCache.value(this.factories.guestInTheMiddle.create(t,s=>{const n=s.width||s.clientWidth,r=s.height||s.clientHeight;Qt("canvas size",n,r),t.give({height:r,width:n})})),this}give(t){return Qt("receive new canvas",t),this.canvasCache.give(t),this}}const yi=$.debug("Cursor");class bi{constructor(t,s){_(this,"cursorPool");this.cursorPool=s.pool.create(this);const n={x:0,y:0};window==null||window.addEventListener("mousemove",r=>{const i={x:r.offsetX+-n.x,y:r.offsetY+-n.y};yi("move cursor fired",i),this.cursorPool.give(i)}),t.position(s.patron.create(s.guest.create(r=>{n.x=r.x,n.y=r.y})))}value(t){return this.cursorPool.add(t),this}}class wi{constructor(t){this.el=t,t.value(this)}give(t){return t.addEventListener("dragstart",s=>{const n=s.target;if(!n)return;const r=n.cloneNode(!0);r.style.transform="translate(0,0)",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.zIndex="999",s.dataTransfer&&s.dataTransfer.setDragImage(r,0,0),document.body.append(r);const i=a=>{r.style.transform=`translate(${a.clientX}px, ${a.clientY}px)`};n.addEventListener("drag",i,{passive:!0}),n.addEventListener("dragend",()=>{r.removeEventListener("drag",i),r.remove()})}),this}introduction(){return"patron"}}const Ve=$.debug("ControlCombo");class Ci{constructor(t,s){this.keyboard=t,this.factories=s}happened(t,s){this.keyboard.event(this.factories.guestInTheMiddle.create(s,n=>{Ve("combo happened look for key",t,"received",n.code),n.ctrlKey&&n.code===t&&n.type==="keydown"&&(n.preventDefault(),s.give(n))}))}happenedConditional(t,s,n){Ve("combo control happened registration"),this.keyboard.event(this.factories.guestInTheMiddle.create(n,r=>{Ve("keyboard event come"),s.value(this.factories.guest.create(i=>{Ve("combo happened look for key",t,"received",r.code),i&&r.ctrlKey&&r.code===t&&r.type==="keydown"&&(r.preventDefault(),n.give(r))}))}))}}const fe=$.debug("Keyboard");class ki{constructor(t){_(this,"pressedPool");_(this,"combinationsPool");fe("keyboard created"),this.pressedPool=t.pool.create(this),this.combinationsPool=t.pool.create(this),window==null||window.addEventListener("keyup",s=>{fe("keyboard pressed",s.key),this.pressedPool.give(s.key)}),mn({passive:!1,onEventFired:s=>{fe("magic combination happens 11",s.ctrlKey,s.key),this.combinationsPool.give(s)}})}pressed(t){return fe("keyboard receive pressed subscriber"),this.pressedPool.add(t),this}event(t){return fe("keyboard receive combination subscriber"),this.combinationsPool.add(t),this}}const Jt=$.debug("app:konva:KonvaLayer");class xi{constructor(t,s,n,r){_(this,"guestChain");_(this,"positionCache");_(this,"layerCache");this.canvasDep=t,this.stageMoveRestriction=n,this.factories=r,this.positionCache=r.cache.create({x:0,y:0}),this.guestChain=r.chain.create(),this.layerCache=r.sourceEmpty.create(),this.canvasDep.canvas(r.patron.create(this.guestChain.receiveKey("canvas"))),s.value(this.guestChain.receiveKey("stageSize")),this.guestChain.result(r.guest.create(({canvas:i})=>{Jt("create new konva stage");const a=new nt.Stage({width:i.clientWidth,height:i.clientHeight,container:i,fill:"#ffeeee",draggable:!0}),c=new nt.Layer;a.add(c),c.draw(),this.layerCache.give(c),a.on("dragend",u=>{if(!(u.target instanceof rt.Stage))return;const h={x:a.x(),y:a.y()};Jt("new position",h),this.positionCache.give(h)}),a.on("dragmove",u=>{if(!(u.target instanceof rt.Stage))return;const h={x:a.x(),y:a.y()};this.positionCache.give(h)});const d=this.factories.guestSync.create({x:0,y:0});a.dragBoundFunc(u=>(n.position(u,d),d.value()))}))}layer(t){return this.layerCache.value(t),t}position(t){return this.positionCache.value(t),t}give(t){this.layerCache.give(t);const s=t.getStage();return this.positionCache.give({x:s.x(),y:s.y()}),this}}class _i{constructor(t,s){this.konvaLayer=t,this.factories=s}position(t){return this.konvaLayer.position(this.factories.guestInTheMiddle.create(t,s=>{t.give({x:s.x*-1,y:s.y*-1})})),t}}const Ni=$.debug("position");class $i{constructor(t,s,n,r,i){this.layer=t,this.canvas=s,this.stageSize=n,this.stageMoveRestriction=r,this.factories=i}move(t){Ni("move stage to new point",t.position),this.stageSize.value(this.factories.guest.create(()=>{this.canvas.size(this.factories.guest.create(s=>{this.layer.layer(this.factories.guest.create(n=>{const[r,i]=t.position,a={x:-r-Math.round(t.width/2)+Math.round(s.width/2),y:-i-Math.round(t.height/2)+Math.round(s.height/2)};this.stageMoveRestriction.position(a,this.factories.guest.create(c=>{n.getStage().position(c),setTimeout(()=>{this.layer.give(n)})}))}))}))}))}}const C=A(),Se=new ki(C),Xt=new ce({readonly:!1,presets:{}}),Vi=new ai(Se,C),Yt=new ni(Se,C),Te=new ci(C),W=new rr(C),Zt=C.sourceEmpty.create(),O=new cr(Zt,W,C),Si=new or(O),Ti=new Vs(Si),Qe=new dr(O,W,C),Je=new _t(Qe,W,C),Bi=new $t(Je,Qe,C),z=new _t(O,W,C),Ei=new Pe(o=>{O.currentMap(new ge(o))}),Be=new hr(Yt,C),Fi=new To(C),Oi=new So(O,z,C),ee=new gi(C),te=new Ao,es=new Ro(ee,te,C),v=new xi(ee,te,es,C),Mi=new mi(C),ji=new Zo(v,O,Mi,C),ie=new $t(z,O,C),Pi=new gr(z,O,[new Le(Te,new pr(O,C),C)],C),Ii=new _i(v,C),Di=new ur(z,ie,ee,Ii,C),ts=new Mo(O,C),ss=new Fo(z,O,[new Le(Te,new jo(ts,C),C)],C),Ai=new Eo(z,O,[new Le(Te,ts,C)],C),Ri=new Bo(ss),Ee=new Lo(v,ee,Qe,C),Li=new li(Ee,O,z,C),zi=new di(v,O,ie,Ee,Be,Bi,new No(new _o(te,C),C),Xt,C),vi=new bi(v,C),Hi=new si(Ee,vi,C),ns=new Uo,rs=new Yo(v,Hi,ns,C),Ui=new Xo(v,O,Je,ns,C),Ki=new ii(Je,v,te,C),Gi=new br(Be,z,ie,rs,C),Wi=new hi(O,ee,v,C),qi=new Ho(Be,O,ie,C),Qi=new ar(O,W,C),Ji=new mr(ie),Xi=new ri,Xe=new fr(W,C),Yi=new ti(Xe,O,C),Zi=new Co(W,C),ea=new Po(Xe,O,C),ta=new Ci(Se,C),sa=new oi(O,C),os=new $i(v,ee,te,es,C),na=new ui(os),ra=new fi(os,C),oa=new Io(z,C),ia=new ir(O,z,W,C),aa=new Vo(z,te,v,C),is=new re;new wi(is);const ca={mapCurrentID:W,mapFile:O,mapCurrent:z,mapCurrentSource:Ei,mapRemoved:Qi,mapSettings:Oi,mapObject:ie,mapObjectRemoved:Pi,mapType:ss,mapTypeRemoved:Ai,mapTypeNew:Ri,mapObjectsVisible:Ee,mapObjectCurrent:Be,mapObjectNew:Di,mapObjectsLink:Gi,mapTypeCurrent:Fi,mapRects:zi,mapBackground:ji,mapObjectArrows:Ui,mapObjectsGeometryFix:Li,canvas:ee,miniMap:Ki,notification:Te,modal:Vi,drawer:Yt,konvaLayer:v,resizing:Wi,objectAdditionalFieldsFix:qi,mapObjectRelationRemoved:Ji,fps:Xi,breadcrumbs:Yi,mapObjectUrl:Zi,keyboard:Se,parentNames:Xe,parentTypes:ea,controlCombo:ta,menu:sa,stagePosition:na,stagePositionByObjectId:ra,objectsMatchedToQuery:oa,stageSize:te,mapHistory:ia,fileContent:Zt,newArrow:rs,objectsOutsideScreen:aa,settings:Xt,documentTitle:Ti,sidebarDraggable:is},P=()=>ca;class V{constructor(t=void 0){_(this,"innerRef");this.innerRef=e.ref(t)}get value(){return this.innerRef.value}ref(){return this.innerRef}give(t){return this.innerRef.value=t,this}introduction(){return"patron"}}const la={key:0},da={class:"flex-grow overflow-y-auto"},ha={key:1,class:"flex gap-1"},Ye=e.defineComponent({__name:"BaseDrawer",props:{name:{type:String,required:!0},direction:{type:String,default:"ltr",validator:o=>["ltr","rtl","ttb","btt"].includes(o)}},emits:["close"],setup(o,{emit:t}){const s=o,n=t,r=e.computed(()=>["e2e-drawer-back absolute z-10 top-0 left-0 w-full h-full bg-black/50"]),i={ltr:"top-0 left-0 w-[50%] max-w-[900px] ",rtl:"top-0 right-0 w-[50%] max-w-[900px] ",ttb:"top-0 right-0 left-0",btt:"top-auto h-[900px] max-h-[50%] bottom-0 right-0 left-0"},{drawer:a}=P(),c=()=>{a.give(""),n("close")},d=a.isOpenedByName(s.name,new V).ref();return(u,h)=>(e.openBlock(),e.createBlock(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.unref(d)?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(r.value),onClick:c},[e.createElementVNode("div",{class:e.normalizeClass(["absolute bg-white h-full p-3 flex flex-col overflow-hidden",i[o.direction]]),onClick:h[0]||(h[0]=e.withModifiers(()=>{},["stop"]))},[u.$slots.header?(e.openBlock(),e.createElementBlock("div",la,[e.renderSlot(u.$slots,"header",{class:"BaseDrawer-Header"})])):e.createCommentVNode("",!0),e.createElementVNode("div",da,[e.renderSlot(u.$slots,"default")]),u.$slots.footer?(e.openBlock(),e.createElementBlock("div",ha,[e.renderSlot(u.$slots,"footer")])):e.createCommentVNode("",!0)],2)],2)):e.createCommentVNode("",!0)]),_:3}))}}),R=e.defineComponent({__name:"BaseIcon",props:{icon:{type:String}},setup(o){const t={"fa-bars":D.faBars,"fa-text-width":D.faTextWidth,"fa-search":D.faSearch,"fa-history":D.faHistory,"fa-plus-square":D.faPlusSquare,"fa-cog":D.faCog,"fa-file-text":D.faFileText,"fa-rotate-left":D.faRotateLeft,"fa-rotate-right":D.faRotateRight,"fa-map":D.faMap,"fa-close":D.faClose,"fa-arrow-left":D.faArrowLeft,"fa-arrow-right":D.faArrowRight,"fa-arrow-down":D.faArrowDown,"fa-arrow-up":D.faArrowUp};return(s,n)=>(e.openBlock(),e.createBlock(e.unref(Ns.FontAwesomeIcon),{icon:t[o.icon]},null,8,["icon"]))}}),pa=e.createElementVNode("h2",{class:"text-lg font-bold"}," Карты в файле ",-1),ua=["onClick"],fa=e.defineComponent({__name:"AppFileMaps",setup(o){const{mapFile:t,mapCurrentID:s,drawer:n,mapRemoved:r}=P(),i=t.mapFile(new V).ref(),a=s.id(new V).ref(),c=d=>{confirm("Вы уверены?")&&r.give(d)};return(d,u)=>(e.openBlock(),e.createBlock(Ye,{direction:"rtl",name:"fileMaps"},{header:e.withCtx(()=>[pa]),default:e.withCtx(()=>[e.createElementVNode("div",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(i),(h,l)=>(e.openBlock(),e.createElementBlock("div",{key:l,class:"flex items-center gap-2"},[e.createElementVNode("a",{href:"#",class:e.normalizeClass({"font-bold":e.unref(a)===l}),onClick:e.withModifiers(p=>{e.unref(s).give(l),e.unref(n).give("")},["prevent"])},e.toDisplayString(h.settings.title),11,ua),e.createVNode(R,{onClick:p=>c(l),class:"text-danger-second cursor-pointer",title:"Удалить карту",icon:"fa-close"},null,8,["onClick"])]))),128))])]),_:1}))}}),ma={class:"AppMenuObject"},ga={key:0,class:"AppMenuObject-Empty"},ya={key:1,class:"flex flex-col gap-1"},ba=["onClick"],wa=["innerHTML"],Ca=e.defineComponent({__name:"AppMenuObject",setup(o){const{controlCombo:t,drawer:s,menu:n,stagePosition:r}=P(),{guest:i,patron:a}=A(),c=n.menuObjects(new V).ref();return t.happened("KeyM",a.create(i.create(()=>{s.give("menu")}))),(d,u)=>(e.openBlock(),e.createBlock(Ye,{direction:"rtl",name:"menu"},{default:e.withCtx(()=>[e.createElementVNode("div",ma,[e.unref(c).length?(e.openBlock(),e.createElementBlock("div",ya,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(c),h=>(e.openBlock(),e.createElementBlock("a",{key:h.id,class:"AppMenuObject-Item",href:"#",onClick:e.withModifiers(l=>{e.unref(r).give(h),e.unref(s).give("")},["prevent"])},[e.createElementVNode("span",{innerHTML:h.additionalName?h.additionalName:h.name},null,8,wa)],8,ba))),128))])):(e.openBlock(),e.createElementBlock("div",ga,e.toDisplayString(d.$t("appMenuObject.noItems")),1))])]),_:1}))}}),E=e.defineComponent({__name:"BaseButton",props:{size:{type:String,default:"md",validator:o=>["sm","md","lg"].includes(o)},type:{type:String,default:"standard"}},setup(o){const t=o,s=["rounded-main",`text-${t.size}`,`p-${t.size}`,`bg-${t.type} hover:bg-${t.type}-second`];return s.push(""),(n,r)=>(e.openBlock(),e.createElementBlock("button",{type:"button",class:e.normalizeClass(s)},[e.renderSlot(n.$slots,"default")]))}}),ka={key:0,title:"Назад",class:"absolute text-white left-0 top-0 -ml-5 flex justify-center items-center bg-primary/70 hover:bg-primary-second/70 cursor-pointer w-5"},xa={key:1,class:"BaseModal-Header"},_a={class:"overflow-y-auto flex-grow"},Na={key:2,class:"BaseModal-Footer"},se=e.defineComponent({__name:"BaseModal",props:{name:{type:String,required:!0}},setup(o){const{modal:t}=P(),s=o,n=t.isOpenedByName(s.name,new V).ref(),r=[],i=()=>{t.give("")};return(a,c)=>(e.openBlock(),e.createBlock(e.Transition,{name:"fade"},{default:e.withCtx(()=>[e.unref(n)?(e.openBlock(),e.createElementBlock("div",{key:0,class:"absolute rounded-main overflow-y-auto flex justify-center items-center top-0 left-0 bg-black/10 z-20 h-full w-full",onClick:i},[e.createElementVNode("div",{class:"w-full relative flex flex-col max-w-[800px] max-h-[90%] bg-white p-3",onClick:c[0]||(c[0]=e.withModifiers(()=>{},["stop"]))},[r.length>1?(e.openBlock(),e.createElementBlock("div",ka," < ")):e.createCommentVNode("",!0),e.createElementVNode("div",{title:"Закрыть",class:"e2e-modal-close absolute text-white right-0 top-0 -mr-5 flex justify-center items-center bg-danger/70 hover:bg-danger-second/70 cursor-pointer w-5",onClick:i}," × "),a.$slots.header?(e.openBlock(),e.createElementBlock("div",xa,[e.renderSlot(a.$slots,"header")])):e.createCommentVNode("",!0),e.createElementVNode("div",_a,[e.renderSlot(a.$slots,"default")]),a.$slots.footer?(e.openBlock(),e.createElementBlock("div",Na,[e.renderSlot(a.$slots,"footer")])):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0)]),_:3}))}}),$a={class:"AppPresets"},Va=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Общие",-1),Sa={class:"flex flex-col gap-2"},Ta={class:"text-md font-bold mb-1"},Ba={class:"flex gap-2 flex-wrap items-end"},Ea={class:"AppTypesParent-ItemTitle"},Fa=["innerHTML"],Oa=e.defineComponent({__name:"AppPresets",setup(o){const{svgMapTypeImage:t}=A(),{mapType:s,settings:n}=P(),r=new V;n.value(r);const i=e.computed(()=>Object.fromEntries(Object.entries(r.value.presets).map(([a,c])=>[a,c.map(d=>({preset:d,image:t.create(d).markup()}))])));return(a,c)=>(e.openBlock(),e.createBlock(se,{name:"presets"},{default:e.withCtx(()=>[e.createElementVNode("div",$a,[Va,e.createElementVNode("div",Sa,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.value,(d,u)=>(e.openBlock(),e.createElementBlock("div",{key:u},[e.createElementVNode("h3",Ta,e.toDisplayString(u),1),e.createElementVNode("div",Ba,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(d,h=>(e.openBlock(),e.createElementBlock("div",{key:h.preset.name,class:"flex flex-col gap-2"},[e.createElementVNode("div",Ea,e.toDisplayString(h.preset.name),1),e.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:h.image,style:e.normalizeStyle(`width:${h.preset.width}px;height:${h.preset.height}px`)},null,12,Fa),e.createVNode(E,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:l=>e.unref(s).give({name:h.preset.name,type:h.preset})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])]))),128))])])]),_:1}))}}),K=e.defineComponent({__name:"BaseInput",props:{modelValue:{type:[String,Number],default:""},autofocus:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(o,{emit:t}){const s=o,n=t,r=e.ref(null);e.watch(r,oe(()=>{s.autofocus&&r.value.focus()},500));const i=Ce(s,"modelValue",n);return(a,c)=>e.withDirectives((e.openBlock(),e.createElementBlock("input",{ref_key:"input",ref:r,"onUpdate:modelValue":c[0]||(c[0]=d=>e.isRef(i)?i.value=d:null),class:"block rounded-main w-full p-2 border border-solid border-body-dark",type:"text"},null,512)),[[e.vModelText,e.unref(i)]])}});class Ze{constructor(t){_(this,"pool",new me(this));this.refSource=t,e.watch(t,s=>{s!==void 0&&this.pool.give(s)},{deep:!0})}value(t){return this.refSource.value&&t.give(this.refSource.value),this.pool.add(t),this}}const Ma={class:"AppSearch"},ja={key:0,class:"AppSearch-Items"},Pa=["onClick"],Ia=["innerHTML"],Da=["innerHTML"],Aa=["innerHTML"],Ra={key:1},La={key:2},za=e.defineComponent({__name:"AppSearch",setup(o){const{objectsMatchedToQuery:t,controlCombo:s,modal:n,stagePosition:r}=P(),{guest:i,patron:a}=A(),c=e.ref(),d=$.debug("app:AppSearch");n.isOpenedByName("search",a.create(i.create(l=>{setTimeout(()=>{l&&c.value&&(d("search is opened",l),c.value.$el.focus())},500)})));const u=e.ref(""),h=t.objects(new Ze(u),new V([])).ref();return s.happened("KeyF",a.create(i.create(()=>{n.give("search")}))),(l,p)=>(e.openBlock(),e.createBlock(se,{name:"search"},{default:e.withCtx(()=>[e.createElementVNode("div",Ma,[e.createVNode(K,{ref_key:"inputRef",ref:c,modelValue:u.value,"onUpdate:modelValue":p[0]||(p[0]=g=>u.value=g),class:"mb-2 e2e-query-input",placeholder:l.$t("general.specifyQuery")},null,8,["modelValue","placeholder"]),e.unref(h).length?(e.openBlock(),e.createElementBlock("div",ja,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(h),g=>(e.openBlock(),e.createElementBlock("div",{key:g.name,class:"cursor-pointer",onClick:e.withModifiers(m=>{e.unref(r).give(g),e.unref(n).give("")},["prevent"])},[e.createElementVNode("b",{class:"AppSearch-ItemName",innerHTML:g.name},null,8,Ia),g.additionalName?(e.openBlock(),e.createElementBlock("b",{key:0,class:"AppSearch-ItemName",innerHTML:g.additionalName},null,8,Da)):e.createCommentVNode("",!0),g.additionalFields?(e.openBlock(),e.createElementBlock("div",{key:1,innerHTML:Object.values(g.additionalFields).join(" ")},null,8,Aa)):e.createCommentVNode("",!0)],8,Pa))),128))])):u.value?(e.openBlock(),e.createElementBlock("div",Ra,e.toDisplayString(l.$t("general.noResults")),1)):(e.openBlock(),e.createElementBlock("div",La,e.toDisplayString(l.$t("general.resultsWillBeHere")),1))])]),_:1}))}}),va={class:"AppTypes"},Ha=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Родительские типы",-1),Ua={class:"flex gap-2 items-end"},Ka={class:"AppTypesParent-ItemTitle"},Ga=["innerHTML"],Wa=e.defineComponent({__name:"AppTypesParent",setup(o){const{parentTypes:t,mapType:s}=P(),{svgMapTypeImage:n}=A(),r=t.types(new V).ref(),i=e.computed(()=>{var a;return(a=r.value)==null?void 0:a.map(c=>({type:c,image:n.create(c).markup()})).sort((c,d)=>+(c.type.name>=d.type.name))});return(a,c)=>(e.openBlock(),e.createBlock(se,{name:"parentTypes"},{default:e.withCtx(()=>[e.createElementVNode("div",va,[Ha,e.createElementVNode("div",Ua,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.value,d=>(e.openBlock(),e.createElementBlock("div",{key:d.type.name,class:"flex flex-col gap-2"},[e.createElementVNode("div",Ka,e.toDisplayString(d.type.name),1),e.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:d.image,style:e.normalizeStyle(`width:${d.type.width}px;height:${d.type.height}px`)},null,12,Ga),e.createVNode(E,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:u=>e.unref(s).give({name:d.type.name,type:d.type})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])])]),_:1}))}});class as{constructor(t,s=void 0){_(this,"innerRef");this.executor=t,this.innerRef=e.ref(s)}ref(){return this.executor(this.innerRef),this.innerRef}}const qa={class:"flex gap-2"},et=e.defineComponent({__name:"BaseCheckbox",props:{modelValue:{type:Boolean},label:{type:String,required:!0}},emits:["update:modelValue"],setup(o,{emit:t}){const r=Ce(o,"modelValue",t);return(i,a)=>(e.openBlock(),e.createElementBlock("label",qa,[e.withDirectives(e.createElementVNode("input",{"onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(r)?r.value=c:null),type:"checkbox"},null,512),[[e.vModelCheckbox,e.unref(r)]]),i.$slots.default?e.renderSlot(i.$slots,"default",{key:0}):(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createTextVNode(e.toDisplayString(o.label),1)],64))]))}}),Fe=(o,t)=>{const s=o.__vccOpts||o;for(const[n,r]of t)s[n]=r;return s},Qa={},Ja={class:"text-sm font-bold"};function Xa(o,t){return e.openBlock(),e.createElementBlock("div",Ja,[e.renderSlot(o.$slots,"default")])}const L=Fe(Qa,[["render",Xa]]),Ya={},Za={class:"mb-2"};function ec(o,t){return e.openBlock(),e.createElementBlock("div",Za,[e.renderSlot(o.$slots,"default")])}const H=Fe(Ya,[["render",ec]]),tc={class:"rounded-main p-2 border border-solid border-body-dark"},sc={class:"flex gap-2 p-2 bg-white border border-solid border-body-dark rounded-main"},Oe=e.defineComponent({__name:"BaseEditor",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(o,{emit:t}){const s=o,n=t,r=je.useEditor({content:s.modelValue,extensions:[$s],onUpdate:()=>{r.value&&n("update:modelValue",r.value.getHTML())}});return e.onBeforeUnmount(()=>{var i;(i=r.value)==null||i.destroy()}),e.watch(()=>s.modelValue,i=>{!r.value||r.value.getHTML()===i||r.value.commands.setContent(i,!1)}),(i,a)=>(e.openBlock(),e.createElementBlock("div",tc,[e.createVNode(e.unref(je.EditorContent),{editor:e.unref(r)},null,8,["editor"]),e.unref(r)?(e.openBlock(),e.createBlock(e.unref(je.BubbleMenu),{key:0,editor:e.unref(r),"tippy-options":{duration:100}},{default:e.withCtx(()=>[e.createElementVNode("div",sc,[e.createElementVNode("button",{onClick:a[0]||(a[0]=c=>e.unref(r).chain().focus().toggleBold().run()),class:e.normalizeClass({"font-bold":e.unref(r).isActive("bold")})}," bold ",2),e.createElementVNode("button",{onClick:a[1]||(a[1]=c=>e.unref(r).chain().focus().toggleItalic().run()),class:e.normalizeClass({"font-bold":e.unref(r).isActive("italic")})}," italic ",2),e.createElementVNode("button",{onClick:a[2]||(a[2]=c=>e.unref(r).chain().focus().toggleStrike().run()),class:e.normalizeClass({"font-bold":e.unref(r).isActive("strike")})}," strike ",2)])]),_:1},8,["editor"])):e.createCommentVNode("",!0)]))}}),nc=["value"],rc=e.defineComponent({__name:"BaseSelect",props:{modelValue:{type:[String,Number],default:""},items:{type:Array,required:!0},optionId:{type:String,required:!0},optionLabel:{type:String,required:!0}},emits:["update:modelValue"],setup(o,{emit:t}){const s=o,r=Ce(s,"modelValue",t);return(i,a)=>e.withDirectives((e.openBlock(),e.createElementBlock("select",{label:"select","onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(r)?r.value=c:null),class:"block bg-white rounded-main w-full p-2 border border-solid border-body-dark"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.items,c=>(e.openBlock(),e.createElementBlock("option",{key:c[s.optionId],value:c[s.optionId]},e.toDisplayString(c[s.optionLabel]),9,nc))),128))],512)),[[e.vModelSelect,e.unref(r)]])}}),oc={class:"text-lg font-bold"},ic={key:0,class:"flex gap-2 items-center"},ac={key:1,class:"flex gap-2 mt-2"},cc={key:0},lc={key:1},dc={key:0,class:"flex flex-col gap-2"},hc={class:"FormObject-Inner"},pc={class:"FormObject-Row"},uc={class:"FormObject-Row"},fc={class:"FormObject-Row"},mc={class:"my-2"},gc={class:"FormObject-Title"},yc={class:"FormObject-Row"},bc={class:"FormObject-Title"},wc={class:"FormObject-Row"},Cc={key:0,class:"FormObject-ArrowName"},kc={class:"py-3 flex gap-1"},xc=e.defineComponent({__name:"FormObject",setup(o){const t=kt("FormObject"),{mapObjectCurrent:s,mapFile:n,mapObject:r,mapCurrent:i,drawer:a,mapObjectRemoved:c,mapObjectRelationRemoved:d,mapObjectUrl:u,controlCombo:h}=P(),{patron:l,chain:p,guest:g}=A(),m=new as(()=>{const w=p.create();s.objectId(l.create(w.receiveKey("objectId"))),s.objectId(l.create(k=>{t("sep obj",k)})),n.currentMap(l.create(w.receiveKey("map"))),n.currentMap(l.create(k=>{t("sep map",k)})),w.result(l.create(g.create(({map:k,objectId:N})=>{t("object opened",N),m.value=k.objects[N]})))}).ref(),y=i.types(new V).ref(),f=n.currentMap(new V).ref(),b=new Ze(m),x=u.url(b,new V).ref(),T=()=>{s.give(""),a.give("")},M=()=>{c.give(m.value),T()},I=()=>{r.give({...m.value,outlink:m.value.outlink||x.value}),T()},S=w=>{d.give({index:w,object:m.value})};return h.happenedConditional("KeyS",a.openedByName("object"),l.create(g.create(I))),(w,k)=>(e.openBlock(),e.createBlock(Ye,{name:"object",onClose:T},{header:e.withCtx(()=>[e.createElementVNode("h2",oc,e.toDisplayString(w.$t("general.mapObject")),1),e.unref(m)?(e.openBlock(),e.createElementBlock("small",ic,[e.createElementVNode("span",null," ID #"+e.toDisplayString(e.unref(m).id),1)])):e.createCommentVNode("",!0),e.unref(m)?(e.openBlock(),e.createElementBlock("div",ac,[e.unref(m).createTimestamp?(e.openBlock(),e.createElementBlock("div",cc," Создан: "+e.toDisplayString(new Date(e.unref(m).createTimestamp).toLocaleString()),1)):e.createCommentVNode("",!0),e.unref(m).changeTimestamp?(e.openBlock(),e.createElementBlock("div",lc," Изменен: "+e.toDisplayString(new Date(e.unref(m).changeTimestamp).toLocaleString()),1)):e.createCommentVNode("",!0)])):e.createCommentVNode("",!0)]),footer:e.withCtx(()=>[e.createElementVNode("div",kc,[e.createVNode(E,{type:"success",onClick:I},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.save")),1)]),_:1}),e.createVNode(E,{type:"danger",onClick:M},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.delete")),1)]),_:1}),e.createVNode(E,{onClick:T},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.cancel")),1)]),_:1})])]),default:e.withCtx(()=>[e.unref(m)?(e.openBlock(),e.createElementBlock("div",dc,[e.createElementVNode("div",hc,[e.createElementVNode("div",pc,[e.createVNode(et,{modelValue:e.unref(m).linked,"onUpdate:modelValue":k[0]||(k[0]=N=>e.unref(m).linked=N),label:w.$t("general.nameAsLink")},null,8,["modelValue","label"])]),e.unref(m).linked?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.outerLink")),1)]),_:1}),e.createElementVNode("div",uc,[e.createVNode(K,{"model-value":e.unref(m).outlink||e.unref(x),"onUpdate:modelValue":k[1]||(k[1]=N=>e.unref(m).outlink=N)},null,8,["model-value"])]),e.createElementVNode("div",fc,[e.createVNode(et,{modelValue:e.unref(m).targetBlank,"onUpdate:modelValue":k[2]||(k[2]=N=>e.unref(m).targetBlank=N),label:w.$t("general.inNewTab")},null,8,["modelValue","label"])])],64)):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(m).additionalFields,(N,U)=>(e.openBlock(),e.createBlock(H,{class:"mb-2",key:U},{default:e.withCtx(()=>[e.createVNode(L,{class:"mb-1"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(U),1)]),_:2},1024),e.createVNode(Oe,{modelValue:e.unref(m).additionalFields[U],"onUpdate:modelValue":q=>e.unref(m).additionalFields[U]=q},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128)),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.topName")),1)]),_:1}),e.createVNode(Oe,{modelValue:e.unref(m).additionalName,"onUpdate:modelValue":k[3]||(k[3]=N=>e.unref(m).additionalName=N)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.bottomName")),1)]),_:1}),e.createVNode(Oe,{modelValue:e.unref(m).name,"onUpdate:modelValue":k[4]||(k[4]=N=>e.unref(m).name=N)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.description")),1)]),_:1}),e.createVNode(Oe,{modelValue:e.unref(m).description,"onUpdate:modelValue":k[5]||(k[5]=N=>e.unref(m).description=N)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Z-Index ")]),_:1}),e.createVNode(K,{modelValue:e.unref(m).zindex,"onUpdate:modelValue":k[6]||(k[6]=N=>e.unref(m).zindex=N),type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Width ")]),_:1}),e.createVNode(K,{modelValue:e.unref(m).width,"onUpdate:modelValue":k[7]||(k[7]=N=>e.unref(m).width=N),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Height ")]),_:1}),e.createVNode(K,{modelValue:e.unref(m).height,"onUpdate:modelValue":k[8]||(k[8]=N=>e.unref(m).height=N),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.objectType")),1)]),_:1}),e.createVNode(rc,{modelValue:e.unref(m).type,"onUpdate:modelValue":k[9]||(k[9]=N=>e.unref(m).type=N),items:e.unref(y),"option-id":"id","option-label":"name"},null,8,["modelValue","items"])]),_:1}),e.createElementVNode("div",mc,[e.createVNode(et,{modelValue:e.unref(m).inMenu,"onUpdate:modelValue":k[10]||(k[10]=N=>e.unref(m).inMenu=N),label:w.$t("general.useInMenu")},null,8,["modelValue","label"])]),e.unref(m).inMenu?(e.openBlock(),e.createElementBlock(e.Fragment,{key:1},[e.createElementVNode("div",gc,e.toDisplayString(w.$t("general.menuOrder")),1),e.createElementVNode("div",yc,[e.createVNode(K,{modelValue:e.unref(m).menuOrder,"onUpdate:modelValue":k[11]||(k[11]=N=>e.unref(m).menuOrder=N),type:"number"},null,8,["modelValue"])])],64)):e.createCommentVNode("",!0),e.unref(m).arrows&&e.unref(m).arrows.length?(e.openBlock(),e.createElementBlock(e.Fragment,{key:2},[e.createElementVNode("div",bc,e.toDisplayString(w.$t("general.relations")),1),e.createElementVNode("div",wc,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(m).arrows,(N,U)=>{var q;return e.openBlock(),e.createElementBlock("div",{key:N.id,class:"FormObject-Arrow"},[(q=e.unref(f))!=null&&q.objects[N.id]?(e.openBlock(),e.createElementBlock("span",Cc," #"+e.toDisplayString(U+1)+" "+e.toDisplayString(e.unref(f).objects[N.id].name),1)):e.createCommentVNode("",!0),e.createVNode(E,{class:"FormObject-ArrowButton",type:"danger",size:"sm",onClick:ae=>S(U)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(w.$t("general.delete")),1)]),_:2},1032,["onClick"])])}),128))])],64)):e.createCommentVNode("",!0)])])):e.createCommentVNode("",!0)]),_:1}))}}),_c={class:"BaseTextarea"},Nc=["v-bind"],cs=e.defineComponent({inheritAttrs:!1,__name:"BaseTextarea",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(o,{emit:t}){const r=Ce(o,"modelValue",t);return(i,a)=>(e.openBlock(),e.createElementBlock("div",_c,[e.withDirectives(e.createElementVNode("textarea",{ref:"textarea","v-bind":i.$attrs,"onUpdate:modelValue":a[0]||(a[0]=c=>e.isRef(r)?r.value=c:null),class:"rounded-main block w-full p-2 border min-h-[200px] border-solid border-body-dark"},null,8,Nc),[[e.vModelText,e.unref(r)]])]))}}),$c={class:"text-lg font-bold"},Vc={key:0,class:"flex flex-col"},Sc={class:"flex justify-end pt-4 gap-2"},Tc=e.defineComponent({__name:"FormType",setup(o){const{mapTypeCurrent:t,mapFile:s,mapType:n,modal:r,controlCombo:i}=P(),{patron:a,chain:c,guest:d}=A();t.typeId(a.create(d.create(m=>{m&&r.give("type")})));const u=e.ref(""),h=c.create(),l=new as(()=>{t.typeId(a.create(h.receiveKey("typeId"))),s.currentMap(a.create(h.receiveKey("map"))),h.result(a.create(d.create(({map:m,typeId:y})=>{var f;l.value=m.types[y],u.value=(f=l.value)==null?void 0:f.name})))}).ref(),p=()=>{t.give(""),r.give(""),h.receiveKey("typeId").give("")},g=()=>{n.give({name:u.value,type:l.value}),p()};return i.happenedConditional("KeyS",r.openedByName("type"),a.create(d.create(g))),(m,y)=>(e.openBlock(),e.createBlock(se,{name:"type"},{header:e.withCtx(()=>[e.createElementVNode("h2",$c,e.toDisplayString(m.$t("general.mapType")),1)]),footer:e.withCtx(()=>[e.createElementVNode("div",Sc,[e.createVNode(E,{type:"success",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(m.$t("general.save")),1)]),_:1}),e.createVNode(E,{onClick:p},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(m.$t("general.cancel")),1)]),_:1})])]),default:e.withCtx(()=>[e.unref(l)?(e.openBlock(),e.createElementBlock("div",Vc,[e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Название типа ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).name,"onUpdate:modelValue":y[0]||(y[0]=f=>e.unref(l).name=f)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" SVG ")]),_:1}),e.createVNode(cs,{modelValue:e.unref(l).svg,"onUpdate:modelValue":y[1]||(y[1]=f=>e.unref(l).svg=f)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Ширина ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).width,"onUpdate:modelValue":y[2]||(y[2]=f=>e.unref(l).width=f)},null,8,["modelValue"])]),_:1}),e.createVNode(H,null,{default:e.withCtx(()=>[e.createVNode(L,null,{default:e.withCtx(()=>[e.createTextVNode(" Высота ")]),_:1}),e.createVNode(K,{modelValue:e.unref(l).height,"onUpdate:modelValue":y[3]||(y[3]=f=>e.unref(l).height=f)},null,8,["modelValue"])]),_:1})])):e.createCommentVNode("",!0)]),_:1}))}}),tt=$.debug("MapObjectsWithTemplates");class Bc{constructor(t,s,n){this.mapObjects=t,this.map=s,this.factories=n}objects(t){const s=this.factories.chain.create();return this.map.types(this.factories.guestCast.create(t,s.receiveKey("types"))),this.mapObjects.objects(this.factories.guestCast.create(t,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(t,({types:n,objects:r})=>{tt("visible objects",r);const i=r.map(a=>{const c=n.find(u=>String(u.id)===String(a.type));if(tt("check type existed",c),!c)return{obj:a,template:""};let{svg:d}=c;return tt("type svg",d),a.additionalFields&&Object.entries(a.additionalFields).forEach(([u,h])=>{d=d.replaceAll(`\${${u}}`,h)}),["width","height"].forEach(u=>{d=d.replaceAll(`\${${u}}`,a[u])}),{obj:a,template:d}});t.give(i)})),t}}const Ec=e.defineComponent({__name:"BaseNotify",setup(o){const{notification:t}=P(),s=t.message(new V).ref();return(n,r)=>e.unref(s)&&e.unref(s).text!=="hide"?(e.openBlock(),e.createElementBlock("div",{key:0,class:e.normalizeClass(["inline font-bold",`text-${e.unref(s).type}-second`])},e.toDisplayString(e.unref(s).text),3)):e.createCommentVNode("",!0)}}),Fc={class:"relative"},Oc={class:"absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-1"},Mc={class:"text-sm z-10 p-2 absolute bottom-0 left-5"},jc=e.createStaticVNode('<div class="absolute bottom-3 shadow-standard-second shadow-md drop-shadow right-3 z-10"><div class="grid-example grid grid-rows-2 grid-cols-2 bg-standard-second border border-standard-second gap-[1px] border-t-0 border-l-0"><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div></div></div><div class="absolute z-30 top-0 left-0 h-[18px] w-[22px] bg-white"></div>',2),Pc=["title"],Ic={class:"font-bold"},Dc=["title"],Ac={class:"font-bold"},Rc=["title"],Lc={class:"font-bold"},zc=["title"],vc={class:"font-bold"},Hc=["data-object-id"],Uc={class:"absolute bottom-[100%] left-[50%] translate-x-[-50%] text-center pb-2 pointer-events-auto text-sm w-[300px]"},Kc=["innerHTML","onClick"],Gc=["innerHTML"],Wc=["data-object-id","innerHTML"],qc=e.defineComponent({__name:"TheEditor",setup(o){const{canvas:t,mapObjectsVisible:s,mapCurrent:n,konvaLayer:r,fps:i,mapCurrentID:a,mapObjectUrl:c,stageSize:d,objectsOutsideScreen:u,stagePositionByObjectId:h,mapCurrentSource:l}=P(),p=A(),g=i.value(new V).ref(),y=new Bc(s,n,p).objects(new V([])).ref(),f=d.value(new V).ref(),b=r.position(new V).ref(),x=e.computed(()=>{var ae;return(ae=f.value)==null?void 0:ae.width}),T=new Ze(x),M=p.numberChunks.create(10,T).chunks(new V).ref(),I=e.ref();e.onMounted(()=>{t.give(I.value)});const S=ae=>{c.open(ae,p.guest.create(G=>{a.give(G)}))},w=u.count({axis:"x",direction:"negative"},new V).ref(),k=u.count({axis:"x",direction:"positive"},new V).ref(),N=u.count({axis:"y",direction:"negative"},new V).ref(),U=u.count({axis:"y",direction:"positive"},new V).ref(),q=h.move.bind(h,l);return(ae,G)=>{var hs,ps,us,fs,ms,gs,ys,bs,ws,Cs,ks,xs;return e.openBlock(),e.createElementBlock("div",Fc,[e.createElementVNode("div",Oc,[e.createElementVNode("div",Mc,[e.createTextVNode(" Видимых объектов: "+e.toDisplayString(e.unref(y).length)+", FPS: "+e.toDisplayString(e.unref(g))+", ",1),e.createVNode(Ec)]),jc,((hs=e.unref(w))==null?void 0:hs.count)>0?(e.openBlock(),e.createElementBlock("div",{key:0,class:"pointer-events-auto absolute z-30 top-0 left-4 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ps=e.unref(w))==null?void 0:ps.count} шт. объектов левее`,onClick:G[0]||(G[0]=j=>e.unref(q)(e.unref(w).nearestObjectId))},[e.createVNode(R,{icon:"fa-arrow-left"}),e.createElementVNode("span",Ic,e.toDisplayString((us=e.unref(w))==null?void 0:us.count),1)],8,Pc)):e.createCommentVNode("",!0),((fs=e.unref(k))==null?void 0:fs.count)>0?(e.openBlock(),e.createElementBlock("div",{key:1,class:"pointer-events-auto absolute z-30 p-1 top-0 right-0 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ms=e.unref(k))==null?void 0:ms.count} шт. объектов правее`,onClick:G[1]||(G[1]=j=>e.unref(q)(e.unref(k).nearestObjectId))},[e.createElementVNode("span",Ac,e.toDisplayString((gs=e.unref(k))==null?void 0:gs.count),1),e.createVNode(R,{icon:"fa-arrow-right"})],8,Dc)):e.createCommentVNode("",!0),((ys=e.unref(N))==null?void 0:ys.count)>0?(e.openBlock(),e.createElementBlock("div",{key:2,class:"pointer-events-auto absolute z-30 top-[18px] left-0 w-[18px] bg-white flex flex-col leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(bs=e.unref(N))==null?void 0:bs.count} шт. объектов выше`,onClick:G[2]||(G[2]=j=>e.unref(q)(e.unref(N).nearestObjectId))},[e.createVNode(R,{icon:"fa-arrow-up"}),e.createElementVNode("span",Lc,e.toDisplayString((ws=e.unref(N))==null?void 0:ws.count),1)],8,Rc)):e.createCommentVNode("",!0),((Cs=e.unref(U))==null?void 0:Cs.count)>0?(e.openBlock(),e.createElementBlock("div",{key:3,class:"pointer-events-auto absolute z-30 p-1 bottom-0 left-0 w-[18px] bg-white flex flex-col-reverse leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ks=e.unref(U))==null?void 0:ks.count} шт. объектов ниже`,onClick:G[3]||(G[3]=j=>e.unref(q)(e.unref(U).nearestObjectId))},[e.createVNode(R,{icon:"fa-arrow-down"}),e.createElementVNode("span",vc,e.toDisplayString((xs=e.unref(U))==null?void 0:xs.count),1)],8,zc)):e.createCommentVNode("",!0),e.createElementVNode("div",{class:e.normalizeClass({"objects-container absolute top-0 left-0":!0}),style:e.normalizeStyle({width:`${e.unref(f).width}px`,height:`${e.unref(f).height}px`,transform:`translate(${e.unref(b).x}px, ${e.unref(b).y}px)`})},[e.createElementVNode("div",{class:"absolute flex top-0 left-0 w-full z-20 h-[20px] bg-default border-b-2 border-border text-right text-sm px-2",style:e.normalizeStyle({transform:`translate(0, ${-e.unref(b).y}px)`})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(M),j=>(e.openBlock(),e.createElementBlock("span",{class:"flex-1 text-body-dark",key:`horiz_${j}`},e.toDisplayString(j)+"px",1))),128))],4),e.createElementVNode("div",{class:"absolute flex [writing-mode:vertical-lr] top-0 left-0 h-full z-20 w-[20px] bg-default border-r-2 border-border text-left text-sm py-2",style:e.normalizeStyle({transform:`translate(${-e.unref(b).x}px, 0)`})},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(M),j=>(e.openBlock(),e.createElementBlock("span",{class:"flex-1 rotate-180 text-body-dark",key:`vert_${j}`},e.toDisplayString(j)+"px",1))),128))],4),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(y),j=>(e.openBlock(),e.createElementBlock("div",{key:j.obj.id,class:"absolute z-10","data-object-id":j.obj.id,style:e.normalizeStyle(`width:${j.obj.width}px;height: ${j.obj.height}px;top: ${j.obj.position[1]}px;left:${j.obj.position[0]}px;z-index:${j.obj.zindex}`)},[e.createElementVNode("div",Uc,[e.createElementVNode("span",{innerHTML:j.obj.additionalName,class:e.normalizeClass([j.obj.linked&&"cursor-pointer underline"]),onClick:Yl=>S(j.obj)},null,10,Kc)]),e.createElementVNode("div",{class:"absolute top-[100%] left-[50%] translate-x-[-50%] text-center pt-2 text-sm w-[300px]",innerHTML:j.obj.name},null,8,Gc),e.createElementVNode("div",{"data-object-id":j.obj.id,class:"rendered-object",innerHTML:j.template},null,8,Wc)],12,Hc))),128))],4)]),e.createElementVNode("div",{class:"h-full",ref_key:"canvasWrapper",ref:I},null,512)])}}}),Qc={class:"flex flex-wrap gap-2"},Jc={key:0},Xc={key:1},Yc=["onClick"],Zc=e.defineComponent({__name:"BaseBreadcrumbs",setup(o){const{breadcrumbs:t,mapCurrentID:s}=P(),n=t.list(new V).ref();return(r,i)=>(e.openBlock(),e.createElementBlock("div",Qc,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(n),(a,c)=>(e.openBlock(),e.createElementBlock("span",{class:"flex gap-2",key:a.name},[c!==0?(e.openBlock(),e.createElementBlock("span",Jc,"/")):e.createCommentVNode("",!0),c===e.unref(n).length-1?(e.openBlock(),e.createElementBlock("b",Xc,"Открыто: "+e.toDisplayString(a.title),1)):(e.openBlock(),e.createElementBlock("a",{key:2,href:"#",onClick:e.withModifiers(d=>e.unref(s).give(a.name),["prevent"])},e.toDisplayString(a.title),9,Yc))]))),128))]))}}),el={class:"flex items-center p-3 gap-3"},tl={class:"ml-auto gap-1 flex"},sl=e.defineComponent({__name:"TheHeader",setup(o){const{drawer:t,modal:s,mapHistory:n,controlCombo:r,settings:i}=P(),{patron:a,guest:c}=A(),d=n.isNextPossible(new V).ref(),u=n.isPrevPossible(new V).ref();r.happened("KeyZ",a.create(c.create(()=>{u.value&&n.prev()}))),r.happened("KeyP",a.create(c.create(()=>{d.value&&n.next()})));const h=new V;return i.value(h),(l,p)=>(e.openBlock(),e.createElementBlock("div",el,[e.createVNode(Zc,{class:"TheHeader-Breadcrumbs"}),e.createElementVNode("div",tl,[e.unref(d)&&!e.unref(h).value.readonly?(e.openBlock(),e.createBlock(E,{key:0,size:"sm",title:"Отменить последнее действие",class:"w-7 block",onClick:p[0]||(p[0]=g=>e.unref(n).next())},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-rotate-left"})]),_:1})):e.createCommentVNode("",!0),e.unref(u)&&!e.unref(h).value.readonly?(e.openBlock(),e.createBlock(E,{key:1,size:"sm",title:"Вернуть отмененное действие",class:"w-7 block",onClick:p[1]||(p[1]=g=>e.unref(n).prev())},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-rotate-right"})]),_:1})):e.createCommentVNode("",!0),e.createVNode(E,{type:"success",size:"sm",class:"w-7 block e2e-open-menu",title:l.$t("general.menu"),onClick:p[2]||(p[2]=g=>e.unref(t).give("menu"))},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-bars"})]),_:1},8,["title"]),e.createVNode(E,{title:l.$t("general.byText"),type:"primary",size:"sm",class:"w-7 block",onClick:p[3]||(p[3]=g=>e.unref(s).give("mapAsText"))},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-text-width"})]),_:1},8,["title"]),e.createVNode(E,{class:"w-7 block e2e-search",size:"sm",onClick:p[4]||(p[4]=g=>e.unref(s).give("search"))},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-search"})]),_:1}),e.createVNode(E,{size:"sm",title:"Все карты файла",class:"w-7 block",onClick:p[5]||(p[5]=g=>e.unref(t).give("fileMaps"))},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-map"})]),_:1})])]))}}),nl={},rl={class:"text-lg font-bold"};function ol(o,t){return e.openBlock(),e.createElementBlock("span",rl,[e.renderSlot(o.$slots,"default")])}const il=Fe(nl,[["render",ol]]),al={class:"flex gap-1"},cl={key:0,class:"TheMapAsText select-auto"},ll=["innerHTML"],dl=e.defineComponent({__name:"TheMapAsText",setup(o){const{mapFile:t,mapCurrent:s}=P(),{guest:n,patron:r,textOf:i,textNlAsBr:a,textWithoutHTML:c}=A(),d=t.currentMap(new V).ref(),u=e.ref(""),h=e.ref([]);s.objects(r.create(n.create(oe(f=>{h.value=f,a.create(i.create(f.map(b=>`<div class="TheMapAsText-Item">
                <h3>${b.name}</h3><p>${b.additionalName||""}</p><p>${b.description||""}</p><p>${b.additionalFields&&Object.values(b.additionalFields).join("</p><p>")}</p></div>`).join(""))).asString(n.create(b=>{u.value=b}))},500))));const{share:l,isSupported:p}=Cn(),g=()=>{p.value||alert("Sharing is not supported"),c.create(i.create(u.value)).asString(n.create(f=>{l({text:f})}))},m=e.ref(),y=()=>{var f,b;if(d.value){const x=new Range;x.setStart(m.value,0),x.setEnd(m.value,Object.values(h.value).length),(f=document.getSelection())==null||f.removeAllRanges(),(b=document.getSelection())==null||b.addRange(x)}};return(f,b)=>(e.openBlock(),e.createBlock(se,{name:"mapAsText"},{header:e.withCtx(()=>[e.createVNode(il,{class:"block mb-3"},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.mapAsText"))+" ",1),e.createElementVNode("div",al,[e.createVNode(E,{size:"sm",type:"success",class:"font-normal",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.share")),1)]),_:1}),e.createVNode(E,{size:"sm",type:"primary",class:"font-normal",onClick:y},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(f.$t("general.selectAll")),1)]),_:1})])]),_:1})]),default:e.withCtx(()=>[e.unref(d)?(e.openBlock(),e.createElementBlock("article",cl,[e.createElementVNode("div",{ref_key:"textRef",ref:m,innerHTML:u.value},null,8,ll)])):e.createCommentVNode("",!0)]),_:1}))}}),hl={key:1},pl=e.defineComponent({__name:"TheMiniMap",setup(o){const{miniMap:t}=P(),s=t.points(new V).ref(),n=t.size(new V).ref(),r=t.viewportSize(new V).ref(),i=t.viewportPosition(new V).ref();return(a,c)=>e.unref(n)?(e.openBlock(),e.createElementBlock("div",{key:0,style:e.normalizeStyle({width:`${e.unref(n).width}px`,height:`${e.unref(n).height}px`}),class:"absolute pointer-events-none block bg-white bottom-[10px] mt-3 right-3 z-1 border border-solid border-body-dark"},[e.unref(i)?(e.openBlock(),e.createElementBlock("div",{key:0,style:e.normalizeStyle({width:`${e.unref(r).width}px`,height:`${e.unref(r).height}px`,top:`${e.unref(i).y}px`,left:`${e.unref(i).x}px`}),class:"absolute bg-primary/50"},null,4)):e.createCommentVNode("",!0),e.unref(s)?(e.openBlock(),e.createElementBlock("div",hl,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(s),d=>(e.openBlock(),e.createElementBlock("div",{key:d.id,class:"absolute w-1 h-1 block bg-danger",style:e.normalizeStyle({top:`${d.y}px`,left:`${d.x}px`,width:`${d.width}px`,height:`${d.height}px`})},null,4))),128))])):e.createCommentVNode("",!0)],4)):e.createCommentVNode("",!0)}}),ul={class:"text-lg font-bold"},fl={key:0,class:"TheSettings"},ml={class:"mb-2"},gl={class:"TheSettings-Row"},yl={class:"flex gap-2 mb-2"},bl={class:"mb-2"},wl={class:"mb-2"},Cl={href:"https://github.com/kosukhin/mind-map-creator",target:"_blank"},kl={class:"flex gap-2"},xl=e.defineComponent({__name:"FormSettings",setup(o){const{modal:t,mapFile:s,mapRemoved:n,mapSettings:r,controlCombo:i,parentNames:a,mapCurrentID:c}=P(),{patron:d,guest:u}=A(),h=a.names(new V).ref(),l=s.currentMap(new V).ref(),p=c.id(new V).ref(),g=()=>{t.give("")},m=()=>{r.give(l.value.settings),g()};return i.happenedConditional("KeyS",t.openedByName("settings"),d.create(u.create(m))),(y,f)=>(e.openBlock(),e.createBlock(se,{name:"settings"},{header:e.withCtx(()=>[e.createElementVNode("h2",ul,e.toDisplayString(y.$t("general.mapSettings")),1)]),default:e.withCtx(()=>{var b;return[(b=e.unref(l))!=null&&b.settings?(e.openBlock(),e.createElementBlock("div",fl,[e.createElementVNode("div",ml,[e.createElementVNode("div",gl,[e.createElementVNode("div",yl,[e.unref(h).length>1?(e.openBlock(),e.createBlock(E,{key:0,type:"primary",class:"text-white",onClick:f[0]||(f[0]=x=>e.unref(t).give("parentTypes"))},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.parentTypes")),1)]),_:1})):e.createCommentVNode("",!0),e.createVNode(E,{type:"primary",class:"text-white",onClick:f[1]||(f[1]=x=>e.unref(t).give("export"))},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.exportOrImport")),1)]),_:1}),e.createVNode(E,{type:"primary",class:"text-white e2e-open-presets",onClick:f[2]||(f[2]=x=>e.unref(t).give("presets"))},{default:e.withCtx(()=>[e.createTextVNode(" Пресеты ")]),_:1})])]),e.createElementVNode("div",bl,[e.createElementVNode("label",null,[e.createElementVNode("b",null,e.toDisplayString(y.$t("general.mapName")),1),e.createVNode(K,{modelValue:e.unref(l).settings.title,"onUpdate:modelValue":f[3]||(f[3]=x=>e.unref(l).settings.title=x)},null,8,["modelValue"])])]),e.createElementVNode("div",wl,[e.createElementVNode("a",Cl,e.toDisplayString(y.$t("general.githubRepo")),1)])]),e.createElementVNode("div",kl,[e.createVNode(E,{class:"TheSettings-Button",type:"success",onClick:f[4]||(f[4]=x=>m())},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.save")),1)]),_:1}),e.createVNode(E,{class:"TheSettings-Button",onClick:g},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.cancel")),1)]),_:1}),e.createVNode(E,{class:"TheSettings-Button",type:"danger",onClick:f[5]||(f[5]=x=>{e.unref(n).give(e.unref(p)),g()})},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(y.$t("general.removeMap")),1)]),_:1})])])):e.createCommentVNode("",!0)]}),_:1}))}}),_l={},Nl={class:"BaseGroup"};function $l(o,t){return e.openBlock(),e.createElementBlock("div",Nl,[e.renderSlot(o.$slots,"default")])}const Vl=Fe(_l,[["render",$l]]),Sl="default",Tl=e.defineComponent({__name:"TheLinker",setup(o){const{mapObjectsLink:t}=P(),s=t.objectIds(new V([])).ref();return(n,r)=>(e.openBlock(),e.createBlock(E,{type:Sl,onClick:r[0]||(r[0]=i=>e.unref(t).startLink())},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(e.unref(s).length===1?"Выбиретие объект":e.unref(s).length===2?"Второй объект":"Связать объекты"),1)]),_:1}))}}),Bl={class:"flex e2e-sidebar flex-col items-center gap-3 max-h-[100%] overflow-hidden"},El={class:"TheSideBar-ItemName"},Fl=["innerHTML","draggable","title","onDragend"],Ol={key:0,class:"flex gap-1"},Ml={key:0,class:"mt-auto w-full p-3 pt-0"},jl=e.defineComponent({__name:"TheSideBar",setup(o){const{mapObjectNew:t,mapCurrent:s,mapTypeCurrent:n,mapTypeRemoved:r,mapTypeNew:i,modal:a,settings:c,sidebarDraggable:d}=P(),u=s.types(new V).ref(),h=e.ref();e.onMounted(()=>{d.give(h.value)});const{svgMapTypeImage:l}=A(),p=e.computed(()=>{var m;return(m=u.value)==null?void 0:m.map(y=>({type:y,image:l.create(y).markup()})).sort((y,f)=>+(y.type.name>=f.type.name))}),g=new V;return c.value(g),(m,y)=>(e.openBlock(),e.createElementBlock("div",Bl,[e.createElementVNode("div",{ref_key:"dragWrapperRef",ref:h,class:"flex flex-col gap-3 flex-grow w-full overflow-y-auto"},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(p.value,(f,b)=>(e.openBlock(),e.createElementBlock("div",{key:b,class:"flex flex-col items-center justify-center gap-2"},[e.createElementVNode("div",El,e.toDisplayString(f.type.name),1),e.createElementVNode("div",{innerHTML:f.image,class:"TheSideBar-ItemImage",draggable:e.unref(g).value.readonly?"false":"true",style:e.normalizeStyle(`width:${f.type.width}px;height:${f.type.height}px`),title:m.$t("general.notifications.dragToCanvasToAdd"),onDragend:x=>e.unref(t).byTypeName(f.type.id,x)},null,44,Fl),e.unref(g).value.readonly?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",Ol,[e.createVNode(E,{class:"text-white",size:"sm",type:"primary",onClick:x=>e.unref(n).give(f.type.id)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(m.$t("general.change")),1)]),_:2},1032,["onClick"]),e.createVNode(E,{class:"text-white",size:"sm",type:"danger",onClick:x=>e.unref(r).give(f.type)},{default:e.withCtx(()=>[e.createTextVNode(e.toDisplayString(m.$t("general.delete")),1)]),_:2},1032,["onClick"])]))]))),128))],512),e.unref(g).value.readonly?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",Ml,[e.createVNode(Vl,{class:"mb-1 grid gap-1 grid-cols-2"},{default:e.withCtx(()=>[e.createVNode(E,{title:m.$t("general.addType"),type:"success",onClick:y[0]||(y[0]=f=>e.unref(i).byName())},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-plus-square"})]),_:1},8,["title"]),e.createVNode(E,{class:"e2e-show-settings",title:m.$t("general.settings"),type:"primary",onClick:y[1]||(y[1]=f=>e.unref(a).give("settings"))},{default:e.withCtx(()=>[e.createVNode(R,{icon:"fa-cog"})]),_:1},8,["title"])]),_:1}),e.createVNode(Tl,{class:"w-[100%] block mb-1"})]))]))}});class Pl{constructor(t,s,n=!1){this.basePatron=t,this.guest=s,this.refWatcherCreated=n}ref(){return this.basePatron.ref()}get value(){return this.basePatron.value}introduction(){return this.basePatron.introduction()}give(t){return this.basePatron.give(t),this.refWatcherCreated||(this.refWatcherCreated=!0,e.watch(this.basePatron.ref(),s=>{s&&this.guest.give(s)},{deep:!0})),this}}class Il{constructor(t){this.baseSource=t}value(t){return this.baseSource.value(new ne(t,s=>{Q(JSON.stringify(s),t)})),this}give(t){return this.value(s=>{t!==s&&this.baseSource.give(JSON.parse(t))}),this}pool(){return this.baseSource.pool()}}class Dl{constructor(t,s){this.baseGuest=t,this.baseGuestAware=s}value(t){return this.baseGuestAware.value(t),this}give(t){return Q(t,this.baseGuest),this}pool(){throw Error("No pool in SourceDynamic")}}const Al={class:"AppPresets"},Rl=e.createElementVNode("div",{class:"text-md font-bold mb-2"},"Экспорт\\Импорт текущей карты",-1),Ll={class:"flex flex-col gap-2"},zl=e.defineComponent({__name:"AppExport",setup(o){const{mapFile:t,mapCurrent:s}=P(),n=new Dl(s,new Pe(c=>{t.currentMap(new ge(c))})),r=new Il(n),i=new Pl(new V,r);r.value(i);const a=i.ref();return(c,d)=>(e.openBlock(),e.createBlock(se,{name:"export"},{default:e.withCtx(()=>[e.createElementVNode("div",Al,[Rl,e.createElementVNode("div",Ll,[e.createVNode(cs,{modelValue:e.unref(a),"onUpdate:modelValue":d[0]||(d[0]=u=>e.isRef(a)?a.value=u:null)},null,8,["modelValue"])])])]),_:1}))}}),vl={class:"bg-body absolute top-0 left-0 w-full h-full"},Hl={class:"grid grid-cols-[200px_1fr] grid-rows-[50px_1fr] h-dvh relative"},Ul=e.defineComponent({__name:"PatronSchemeEditor",props:{modelValue:{type:String,required:!0},readonly:{type:Boolean,default:!1},presets:{type:Object,default:()=>({})}},emits:["update:modelValue"],setup(o,{emit:t}){const s=o,n=t,{fileContent:r,settings:i}=P(),{guest:a,patron:c}=A();return i.value(d=>{i.give({...d,readonly:s.readonly,presets:s.presets})}),e.watch(()=>s.modelValue,d=>{r.value(a.create(u=>{d!==u&&r.give(d)}))},{immediate:!0}),r.value(c.create(d=>{n("update:modelValue",d)})),(d,u)=>(e.openBlock(),e.createElementBlock("div",vl,[e.createElementVNode("div",Hl,[e.createVNode(sl,{class:"col-span-2"}),e.createVNode(jl),e.createVNode(qc,{class:"w-auto col-auto h-full"}),e.createVNode(pl)]),e.createVNode(xc),e.createVNode(Tc),e.createVNode(xl),e.createVNode(Oa),e.createVNode(Wa),e.createVNode(zl),e.createVNode(Ca),e.createVNode(dl),e.createVNode(za),e.createVNode(fa)]))}}),ls=$.debug("FileSystemContent");class Kl{constructor(t,s,n){_(this,"contentPatrons");_(this,"fileHandler",null);_(this,"contentSource");this.launchQueue=t,this.notification=s,this.factories=n,this.contentPatrons=n.pool.create(this),this.contentSource=n.sourceEmpty.create()}content(t){const s=this.factories.guest.create(n=>{this.fileHandler=n,this.factories.fileHandlerContent.create(n).content(this.factories.guest.create(r=>{this.contentPatrons.distribute(r,t),this.contentSource.give(r)}))});return this.fileHandler||this.launchQueue.fileHandler(s),this.contentSource.value(t),this}give(t){if(ls("save file as content string",t),!this.fileHandler)throw new le("Cant save file because no fileHandler");try{return this.contentSource.give(t),this.factories.browserFileSaved.create(this.fileHandler).save(t),this.contentPatrons.give(t),this}catch(s){throw new le("Cant handle receive for map file FS",{cause:s})}finally{this.notification.give({type:"success",text:"Успешно сохранен файл карты!"})}}canBeUsed(t){const s="launchQueue"in window;ls("can be used",s);const n=window&&window.matchMedia("(display-mode: standalone)");return t.give(s&&n.matches),t}}const Me=$.debug("FirstPossibleFileContent");class Gl{constructor(t,s){_(this,"firstPossibleFileContent",null);_(this,"contentSource",new re);_(this,"canBeUsedSource",new re);Me("length",t.length),t.forEach(n=>{n.canBeUsed(s.patronOnce.create(s.guest.create(r=>{Me("canbeused result",n,r),r&&!this.firstPossibleFileContent&&(this.firstPossibleFileContent=n,n.canBeUsed(s.patron.create(this.canBeUsedSource)),n.content(s.patron.create(this.contentSource)),this.contentSource.value(s.patron.create(i=>{n.content(s.guest.create(a=>{i!==a&&n.give(i)}))})))})))})}canBeUsed(t){return Me("can be used to",this.firstPossibleFileContent),this.canBeUsedSource.value(t),t}content(t){return Me("content to",this.firstPossibleFileContent),this.contentSource.value(t),this}give(t){return this.contentSource.give(t),this}}const st=$.debug("UrlContent");class Wl{constructor(t,s){_(this,"contentCache");this.notification=t,this.factories=s,this.contentCache=s.sourceEmpty.create()}canBeUsed(t){if(!window)return t.give(!1),this;const s=window.location.search.indexOf("?view=")>-1;if(st("can be used",s),t.give(window.location.search.indexOf("?view=")>-1),s){const n=window.location.search.split("=")[1]??"";fetch(n,{redirect:"follow"}).then(r=>r.text()).then(r=>{st("received text",r),this.contentCache.give(r)})}return t}content(t){if(!window)return this;const s=window.location.search.split("=")[1]??"";return st("visit url",s),this.contentCache.value(this.factories.patronOnce.create(t)),this}give(){return this.notification.give({type:"error",text:"Невозможно сохранить карту, открытую по ссылке!"}),this}}const ds=new re;class ql{constructor(t=window.launchQueue,s="launchQueue"in window){_(this,"isCalculated",!1);this.launchQueue=t,this.isLaunchQueueSupported=s}fileHandler(t){return this.isLaunchQueueSupported&&!this.isCalculated&&(this.isCalculated=!0,this.launchQueue.setConsumer(s=>{if(console.log("require file handler"),s.files&&s.files.length){const[n]=s.files;ds.give(n)}})),ds.value(t),this}}B.BrowserLaunchQueue=ql,B.FileSystemContent=Kl,B.FirstPossibleFileContent=Gl,B.PatronSchemeEditor=Ul,B.UrlContent=Wl,B.VueRefPatron=V,B.useApplication=P,B.useFactories=A,Object.defineProperty(B,Symbol.toStringTag,{value:"Module"})});

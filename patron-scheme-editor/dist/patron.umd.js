(function($,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("vue"),require("@vueuse/core"),require("konva"),require("@fortawesome/vue-fontawesome"),require("@fortawesome/free-solid-svg-icons"),require("@tiptap/vue-3"),require("@tiptap/starter-kit")):typeof define=="function"&&define.amd?define(["exports","vue","@vueuse/core","konva","@fortawesome/vue-fontawesome","@fortawesome/free-solid-svg-icons","@tiptap/vue-3","@tiptap/starter-kit"],t):($=typeof globalThis<"u"?globalThis:$||self,t($.patron={},$.Vue,$.core,$.Konva,$.vueFontawesome,$.freeSolidSvgIcons,$.vue3,$.StarterKit))})(this,function($,t,L,Z,hs,P,Ie,ps){"use strict";var Ol=Object.defineProperty;var Pl=($,t,L)=>t in $?Ol($,t,{enumerable:!0,configurable:!0,writable:!0,value:L}):$[t]=L;var w=($,t,L)=>Pl($,typeof t!="symbol"?t+"":t,L);var ye=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function je(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var De={exports:{}},Oe,nt;function ms(){if(nt)return Oe;nt=1;var i=1e3,e=i*60,s=e*60,n=s*24,r=n*7,o=n*365.25;Oe=function(d,h){h=h||{};var m=typeof d;if(m==="string"&&d.length>0)return a(d);if(m==="number"&&isFinite(d))return h.long?c(d):l(d);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(d))};function a(d){if(d=String(d),!(d.length>100)){var h=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(d);if(h){var m=parseFloat(h[1]),f=(h[2]||"ms").toLowerCase();switch(f){case"years":case"year":case"yrs":case"yr":case"y":return m*o;case"weeks":case"week":case"w":return m*r;case"days":case"day":case"d":return m*n;case"hours":case"hour":case"hrs":case"hr":case"h":return m*s;case"minutes":case"minute":case"mins":case"min":case"m":return m*e;case"seconds":case"second":case"secs":case"sec":case"s":return m*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return m;default:return}}}}function l(d){var h=Math.abs(d);return h>=n?Math.round(d/n)+"d":h>=s?Math.round(d/s)+"h":h>=e?Math.round(d/e)+"m":h>=i?Math.round(d/i)+"s":d+"ms"}function c(d){var h=Math.abs(d);return h>=n?p(d,h,n,"day"):h>=s?p(d,h,s,"hour"):h>=e?p(d,h,e,"minute"):h>=i?p(d,h,i,"second"):d+" ms"}function p(d,h,m,f){var u=h>=m*1.5;return Math.round(d/m)+" "+f+(u?"s":"")}return Oe}function us(i){s.debug=s,s.default=s,s.coerce=c,s.disable=o,s.enable=r,s.enabled=a,s.humanize=ms(),s.destroy=p,Object.keys(i).forEach(d=>{s[d]=i[d]}),s.names=[],s.skips=[],s.formatters={};function e(d){let h=0;for(let m=0;m<d.length;m++)h=(h<<5)-h+d.charCodeAt(m),h|=0;return s.colors[Math.abs(h)%s.colors.length]}s.selectColor=e;function s(d){let h,m=null,f,u;function A(...g){if(!A.enabled)return;const b=A,C=Number(new Date),D=C-(h||C);b.diff=D,b.prev=h,b.curr=C,h=C,g[0]=s.coerce(g[0]),typeof g[0]!="string"&&g.unshift("%O");let V=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,(F,N)=>{if(F==="%%")return"%";V++;const _=s.formatters[N];if(typeof _=="function"){const k=g[V];F=_.call(b,k),g.splice(V,1),V--}return F}),s.formatArgs.call(b,g),(b.log||s.log).apply(b,g)}return A.namespace=d,A.useColors=s.useColors(),A.color=s.selectColor(d),A.extend=n,A.destroy=s.destroy,Object.defineProperty(A,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(f!==s.namespaces&&(f=s.namespaces,u=s.enabled(d)),u),set:g=>{m=g}}),typeof s.init=="function"&&s.init(A),A}function n(d,h){const m=s(this.namespace+(typeof h>"u"?":":h)+d);return m.log=this.log,m}function r(d){s.save(d),s.namespaces=d,s.names=[],s.skips=[];let h;const m=(typeof d=="string"?d:"").split(/[\s,]+/),f=m.length;for(h=0;h<f;h++)m[h]&&(d=m[h].replace(/\*/g,".*?"),d[0]==="-"?s.skips.push(new RegExp("^"+d.slice(1)+"$")):s.names.push(new RegExp("^"+d+"$")))}function o(){const d=[...s.names.map(l),...s.skips.map(l).map(h=>"-"+h)].join(",");return s.enable(""),d}function a(d){if(d[d.length-1]==="*")return!0;let h,m;for(h=0,m=s.skips.length;h<m;h++)if(s.skips[h].test(d))return!1;for(h=0,m=s.names.length;h<m;h++)if(s.names[h].test(d))return!0;return!1}function l(d){return d.toString().substring(2,d.toString().length-2).replace(/\.\*\?$/,"*")}function c(d){return d instanceof Error?d.stack||d.message:d}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}var fs=us;(function(i,e){e.formatArgs=n,e.save=r,e.load=o,e.useColors=s,e.storage=a(),e.destroy=(()=>{let c=!1;return()=>{c||(c=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let c;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(c=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(c[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(c){if(c[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+c[0]+(this.useColors?"%c ":" ")+"+"+i.exports.humanize(this.diff),!this.useColors)return;const p="color: "+this.color;c.splice(1,0,p,"color: inherit");let d=0,h=0;c[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(d++,m==="%c"&&(h=d))}),c.splice(h,0,p)}e.log=console.debug||console.log||(()=>{});function r(c){try{c?e.storage.setItem("debug",c):e.storage.removeItem("debug")}catch{}}function o(){let c;try{c=e.storage.getItem("debug")}catch{}return!c&&typeof process<"u"&&"env"in process&&(c=process.env.DEBUG),c}function a(){try{return localStorage}catch{}}i.exports=fs(e);const{formatters:l}=i.exports;l.j=function(c){try{return JSON.stringify(c)}catch(p){return"[UnexpectedJSONParseError]: "+p.message}}})(De,De.exports);var B=De.exports;const Pe=je(B);class ae{constructor(e){this.guestReceiver=e}value(e){return this.guestReceiver(e),e}}function I(i,e,s){typeof e=="function"?e(i,s):e.give(i,s)}class te{constructor(e){this.receiver=e}give(e,s){return this.receiver(e,s),this}}class O{constructor(e,s){this.sourceGuest=e,this.targetGuest=s}introduction(){return typeof this.sourceGuest=="function"||!this.sourceGuest.introduction?"guest":this.sourceGuest.introduction()}give(e,s){return I(e,this.targetGuest,s),this}disposed(e){const s=this.sourceGuest;return s.disposed?s.disposed(e):!1}}var gs=Object.defineProperty,ys=(i,e,s)=>e in i?gs(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,rt=(i,e,s)=>ys(i,typeof e!="symbol"?e+"":e,s);const it=new Map,ot=i=>{it.forEach(e=>{e.delete(i)})};class we{constructor(e){this.initiator=e,rt(this,"patrons"),rt(this,"give"),this.patrons=new Set,it.set(this,this.patrons);let s=null;const n=(r,o)=>{this.patrons.forEach(a=>{this.sendValueToGuest(r,a,o)})};this.give=(r,o)=>{const a=()=>{a===s&&n(r,o)};return s=a,queueMicrotask(a),this}}size(){return this.patrons.size}add(e){if(!e)throw new Error("PatronPool add method received nothing!");return typeof e!="function"&&e.introduction&&e.introduction()==="patron"&&this.patrons.add(e),this}remove(e){return this.patrons.delete(e),this}distribute(e,s){return this.add(s),this.sendValueToGuest(e,s,{}),this}sendValueToGuest(e,s,n){this.guestDisposed(e,s)||I(e,s,{...n,data:{...(n==null?void 0:n.data)??{},initiator:this.initiator,pool:this}})}guestDisposed(e,s){var n;return(n=s.disposed)!=null&&n.call(s,e)?(this.remove(s),!0):!1}}var ws=Object.defineProperty,As=(i,e,s)=>e in i?ws(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,bs=(i,e,s)=>As(i,e+"",s);class X{constructor(e){this.sourceDocument=e,bs(this,"thePool",new we(this))}pool(){return this.thePool}give(e){return this.sourceDocument=e,this.thePool.give(this.sourceDocument),this}value(e){return typeof e=="function"?this.thePool.distribute(this.sourceDocument,new te(e)):this.thePool.distribute(this.sourceDocument,e),this}}class Ae{constructor(e){this.baseGuest=e}give(e,s){let n=this.baseGuest;return typeof n=="function"&&(n=new te(n)),n.give(e,s),this}introduction(){return typeof this.baseGuest=="function"||!this.baseGuest.introduction?"guest":this.baseGuest.introduction()}disposed(e){const s=this.baseGuest;return s.disposed?s.disposed(e):!1}}var Cs=Object.defineProperty,xs=(i,e,s)=>e in i?Cs(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,at=(i,e,s)=>xs(i,typeof e!="symbol"?e+"":e,s);class ks{constructor(e){at(this,"guests",new Set),at(this,"patronPool"),this.patronPool=new we(e)}give(e,s){return this.deliverToGuests(e,s),this.patronPool.give(e,s),this}add(e){return(typeof e=="function"||!e.introduction||e.introduction()==="guest")&&this.guests.add(e),this.patronPool.add(e),this}remove(e){return this.guests.delete(e),this.patronPool.remove(e),this}distribute(e,s){return this.add(s),this.give(e),this}size(){return this.patronPool.size()+this.guests.size}deliverToGuests(e,s){this.guests.forEach(n=>{I(e,n,s)}),this.guests.clear()}}var _s=Object.defineProperty,Bs=(i,e,s)=>e in i?_s(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,be=(i,e,s)=>Bs(i,typeof e!="symbol"?e+"":e,s);class Ce{constructor(){be(this,"theChain"),be(this,"keysKnown",new Set),be(this,"keysFilled",new Set),be(this,"filledChainPool",new ks(this)),this.theChain=new X({})}resultArray(e){const s=new Ae(e);return this.filledChainPool.add(new O(s,n=>{s.give(Object.values(n))})),this.isChainFilled()&&this.theChain.value(new te(n=>{this.filledChainPool.give(Object.values(n))})),this}result(e){const s=new Ae(e);return this.isChainFilled()?(this.filledChainPool.add(s),this.theChain.value(new te(n=>{this.filledChainPool.give(n)}))):this.filledChainPool.add(s),this}receiveKey(e){return this.keysKnown.add(e),new te(s=>{queueMicrotask(()=>{this.theChain.value(new te(n=>{this.keysFilled.add(e);const r={...n,[e]:s};this.theChain.give(r),this.isChainFilled()&&this.filledChainPool.give(r)}))})})}isChainFilled(){return this.keysFilled.size>0&&this.keysFilled.size===this.keysKnown.size}}class Ns{constructor(e){this.theValue=e}give(e){return this.theValue=e,this}value(){return this.theValue}}class Re{constructor(e){this.willBePatron=e}introduction(){return"patron"}give(e,s){return I(e,this.willBePatron,s),this}disposed(e){var n;const s=this.willBePatron;return((n=s==null?void 0:s.disposed)==null?void 0:n.call(s,e))||!1}}var Vs=Object.defineProperty,$s=(i,e,s)=>e in i?Vs(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,Ss=(i,e,s)=>$s(i,e+"",s);class Fs{constructor(e){this.baseGuest=e,Ss(this,"received",!1)}introduction(){return"patron"}give(e,s){this.received||I(e,this.baseGuest,s);const n=s==null?void 0:s.data;return n!=null&&n.pool&&n.pool.remove(this),this}disposed(e){const s=this.baseGuest;return s.disposed?s.disposed(e):!1}}var Es=Object.defineProperty,Ts=(i,e,s)=>e in i?Es(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s,Ms=(i,e,s)=>Ts(i,e+"",s);class se{constructor(){Ms(this,"baseSource",new X(null))}value(e){return this.baseSource.value(new O(e,s=>{s!==null&&I(s,e)})),this}give(e){return this.baseSource.give(e),this}pool(){return this.baseSource.pool()}}class E{constructor(e,s={}){this.constructorFn=e,this.factories=s}create(...e){return new this.constructorFn(...e,this.factories)}}const Is=Pe("SharedFile");class js{constructor(e,s="Share file"){w(this,"loading",new X(!1));this.fileSource=e,this.sharingTitle=s}value(e){return this.loading.value(e),this}do(){return this.fileSource.value(e=>{try{const s=new File([e.content],e.name.replace(".json",".txt"),{type:"text/plain"});this.loading.give(!0),navigator.share({title:`${this.sharingTitle} ${e.name}`,files:[s]}).finally(()=>{this.loading.give(!1)})}catch(s){Is(s)}}),this}}class ct{constructor(e){w(this,"source",new X(null));this.name=e;const s=JSON.parse(localStorage.getItem(e)||"null");this.source.give(s),document.addEventListener("localDataStorage",n=>{n.detail.key===e&&this.source.give(JSON.parse(n.detail.newval))},!1)}give(e){return localStorage.setItem(this.name,JSON.stringify(e)),this.source.give(e),this}pool(){return this.source.pool()}value(e){return this.source.value(e),this}}const lt=new ct("shared-map"),Ds=new js(lt),Os={sharedStorageRecord:lt,sharedFile:Ds},He=()=>Os;class Ps{constructor(e){e.value(this)}give(e){return document.title=e,this}introduction(){return"patron"}}class de extends Error{constructor(e,s){super(e,s)}}class Rs{constructor(e){this.fileHandler=e}content(e){return this.fileHandler.getFile().then(async s=>await new Response(s).text()).then(s=>{e.give(s)}).catch(s=>{throw new de("Problem when reading file in SystemFileFromHandler",{cause:s})}),this}}class Hs{constructor(e){this.fileHandler=e}save(e){return this.fileHandler.createWritable().then(s=>(s.write(e).catch(n=>{throw new de("Cant save file in browser",{cause:n})}),s)).then(s=>{s.close().catch(n=>{throw new de("Cant close written file in browser",{cause:n})})}),this}}class zs{constructor(e){this.content=e}result(){return JSON.parse(this.content)}}class Ls{constructor(e){this.content=e}result(){return JSON.stringify(this.content)}}class Us{constructor(e,s=100,n=100){this.svgContent=e,this.width=s,this.height=n}markup(){return this.svgContent.replaceAll("${width}",String(this.width)).replaceAll("${height}",String(this.height))}}class Qs{constructor(e,s){this.type=e,this.factories=s}markup(){return this.factories.svgImage.create(this.type.svg,this.type.width,this.type.height).markup()}}class vs{constructor(e,s,n){this.chunksCount=e,this.baseNumber=s,this.factories=n}chunks(e){return this.baseNumber.value(this.factories.guestInTheMiddle.create(e,s=>{const n=Math.round(s/this.chunksCount),r=[];for(let o=1;o<=this.chunksCount;o+=1)r.push(o*n);e.give(r)})),e}}class Ws{constructor(e,s){this.mapUrl=e,this.factories=s}name(e){this.mapUrl.value(this.factories.guestInTheMiddle.create(e,s=>{let n=s.replace("/","").replaceAll("/","_");n.match("_")&&(n=`_${n}`),e.give(n)}))}}class Gs{constructor(e,s){this.text=e,this.factories=s}noHtml(e){return this.text.value(this.factories.guestInTheMiddle.create(e,s=>{const n=document.createElement("DIV");n.innerHTML=s;const r=n.textContent||n.innerText||"";e.give(r)})),e}}class Ks{constructor(e,s,n,r){w(this,"loadingCache");this.callbackName=e,this.url=s,this.emptyValue=n,this.factories=r,this.loadingCache=r.sourceEmpty.create()}content(e){this.loadingCache.give(!0);const s=setTimeout(()=>{this.loadingCache.give(!1),e.give(this.emptyValue)},1e4);return L.useScriptTag(this.url,()=>{var r;clearInterval(s);const n=((r=window[this.callbackName])==null?void 0:r.call(window))||this.emptyValue;e.give(n),this.loadingCache.give(!1)}),e}loading(e){return this.loadingCache.value(e),e}}class qs{constructor(e){this.text=e}asString(e){return e.give(this.text),e}}class Js{constructor(e,s){this.baseText=e,this.factories=s}asString(e){return this.baseText.asString(this.factories.guestInTheMiddle.create(e,s=>{e.give((s??"").replace(/<\/?[^>]+>/gi," "))})),e}}const Ys=B.debug("TextNlAsBr");class Zs{constructor(e,s){this.baseText=e,this.factories=s}asString(e){return this.baseText.asString(this.factories.guestInTheMiddle.create(e,s=>{if(typeof s>"u"||s===null)return"";const n="<br />";return Ys(s),e.give((s??"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,`$1${n}$2`)),!0})),e}}const Xs=new E(X),en=new E(X),tn=new E(se),sn=new E(te),nn=new E(O),rn=new E(ae),on=new E(we),an=new E(Re),cn=new E(Fs),ln=new E(O),dn=new E(Ce),hn=new E(Ns),ee={cache:Xs,chain:dn,guest:sn,guestCast:nn,guestAware:rn,guestInTheMiddle:ln,guestSync:hn,patron:an,patronOnce:cn,pool:on,source:en,sourceEmpty:tn},pn=new E(Rs),mn=new E(Hs),un=new E(Ls),fn=new E(zs),dt=new E(Us),gn=new E(Qs,{...ee,svgImage:dt}),yn=new E(vs,ee),wn=new E(Ws,ee),An=new E(Gs,ee),bn=new E(Ks,ee),Cn=new E(qs),xn=new E(Js,ee),kn=new E(Zs,ee),_n={...ee,fileHandlerContent:pn,browserFileSaved:mn,transformToString:un,transformToObject:fn,svgImage:dt,svgMapTypeImage:gn,numberChunks:yn,mapNameFromUrl:wn,textNoHtml:An,jsonp:bn,textOf:Cn,textNlAsBr:kn,textWithoutHTML:xn},H=()=>_n;class ze{constructor(e,s,n){this.notification=e,this.check=s,this.factories=n}breakOnFail(e,s){return this.check.check(e,this.factories.guest.create(n=>{n===!0?s.give(!0):this.notification.give({type:"error",text:n})})),this}continueOnFail(e,s){return this.check.check(e,this.factories.guest.create(n=>{s.give(n),n!==!0&&this.notification.give({type:"error",text:n})})),this}}const Le=B.debug("MapCurrent");class ht{constructor(e,s,n){w(this,"objectsCache");w(this,"settingsCache");w(this,"typesCache");this.mapFile=e,this.mapId=s,this.factories=n,this.objectsCache=n.sourceEmpty.create(),this.settingsCache=n.sourceEmpty.create(),this.typesCache=n.sourceEmpty.create(),e.currentMap(n.patron.create(n.guest.create(r=>{Le("current map changed",r),this.settingsCache.give(r.settings),this.objectsCache.give(Object.values(r.objects)),this.typesCache.give(Object.entries(r.types).map(([o,a])=>({...a,id:o})))})))}settings(e){return this.settingsCache.value(e),e}objects(e){return Le("notify about new objects"),this.objectsCache.value(e),e}types(e){return this.typesCache.value(e),e}give(e){return Le("save map document",e),this.mapId.id(this.factories.guest.create(s=>{this.mapFile.mapFile(this.factories.guest.create(n=>{this.mapFile.give({...n,[s]:e})}))})),this}}class Bn{constructor(e){w(this,"idCache");this.idCache=e.cache.create("current")}id(e){return this.idCache.value(e),e}give(e){return this.idCache.give(e),this}}class Nn{constructor(e){this.mapFile=e}value(e){return this.mapFile.currentMap(new O(e,s=>{e.give(s.settings.title)})),this}}const xe=B.debug("MapHistory"),pt=i=>{const e=JSON.parse(JSON.stringify(i));return Object.values(e.objects).forEach(s=>{s.width=0,s.height=0}),JSON.stringify(e)};class Vn{constructor(e,s,n,r){w(this,"mapsHistory");w(this,"historyIndex");this.mapFile=e,this.map=s,this.mapId=n,this.factories=r,this.mapsHistory=r.cache.create([]),this.historyIndex=r.cache.create(0),this.mapFile.currentMap(r.patron.create(this)),this.mapId.id(r.patron.create(r.guest.create(()=>{this.mapsHistory.give([]),this.historyIndex.give(0)})))}give(e){return requestIdleCallback(()=>{this.historyIndex.value(this.factories.guest.create(s=>{this.mapsHistory.value(this.factories.guest.create(n=>{xe("add map to history",n,e);const r=n.some(o=>pt(o)===pt(e));if(xe("isMapFromHistory",r),!r){const o=n[s]?[n[s]]:[];this.historyIndex.give(0),this.mapsHistory.give([e,...o,...n.slice(0,9)])}}))}))}),this}isPrevPossible(e){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(e,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(e,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(e,({historyIndex:n,mapsHistory:r})=>{const o=n<r.length-1;xe("recalculate is prev possible",o),e.give(o)})),e}prev(){this.historyIndex.value(this.factories.guest.create(e=>{const s=e+1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(n=>{const r=n[s];this.map.give(r)}))}))}isNextPossible(e){const s=this.factories.chain.create(this);return this.historyIndex.value(this.factories.guestCast.create(e,s.receiveKey("historyIndex"))),this.mapsHistory.value(this.factories.guestCast.create(e,s.receiveKey("mapsHistory"))),s.result(this.factories.guestInTheMiddle.create(e,({historyIndex:n,mapsHistory:r})=>{const o=n>0&&n<=r.length-1;xe("recalculate is next possible",o),e.give(o)})),e}next(){this.historyIndex.value(this.factories.guest.create(e=>{const s=e-1;this.historyIndex.give(s),this.mapsHistory.value(this.factories.guest.create(n=>{const r=n[s];this.map.give(r)}))}))}}class $n{constructor(e,s,n){this.mapFile=e,this.mapId=s,this.factories=n}give(e){const{guest:s}=this.factories;return this.mapFile.mapFile(s.create(n=>{delete n[e],this.mapFile.give(n),this.mapId.give("current")})),this}}const ke=B.debug("MapFile");class Sn{constructor(e,s,n){w(this,"currentMapPatrons");w(this,"mapFileCache");this.mapFileContent=e,this.mapId=s,this.factories=n,this.currentMapPatrons=n.pool.create(this),this.mapFileCache=n.cache.create(!1),e.value(n.patron.create(r=>{if(!r)return;const o=this.factories.transformToObject.create(r).result();ke("get map file",o),this.mapFileCache.give(o)}))}currentMap(e){const s=this.factories.chain.create();return this.mapId.id(this.factories.guestCast.create(e,s.receiveKey("mapId"))),this.mapFile(this.factories.guestCast.create(e,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(e,({mapId:n,mapFile:r})=>{if(ke("get current map",n,r,typeof r),!r[n])this.createEmptyMapByName(n,e);else{const o=r[n];this.currentMapPatrons.distribute(o!=null&&o.structure?o.structure:o,e)}})),e}give(e){return ke("save map file document",e),this.mapFileContent.give(this.factories.transformToString.create(e).result()),this}mapFile(e){return this.mapFileCache.value(e),e}createEmptyMapByName(e,s){ke("creating empty map by name",e);const n=this.factories.transformToObject.create(this.generateEmptyMapFile()).result();this.mapFile(this.factories.guest.create(r=>{this.give({...r,[e]:n.current}),s.give(n.current)}))}generateEmptyMapFile(){return'{"current":{"progress":0,"settings":{"colored":false,"title":"current"},"objects":{},"types":{},"url":"/current","parent":""}}'}}const Fn=B.debug("MapFileForRendering");class En{constructor(e,s,n){w(this,"mapCache");this.mapId=s,this.factories=n,this.mapCache=n.cache.create({objects:{},types:{},settings:{}}),e.currentMap(n.patron.create(this.mapCache))}currentMap(e){return this.mapCache.value(e),e}mapFile(e){return this.mapCache.value(this.factories.guestInTheMiddle.create(e,s=>{this.mapId.id(this.factories.guest.create(n=>{e.give({[n]:s})}))})),e}give(e){return this.mapId.id(this.factories.guest.create(s=>{Fn("received map file, objects = ",e[s].objects),this.mapCache.give(e[s])})),this}}class mt{constructor(e,s,n){this.map=e,this.mapFile=s,this.factories=n}give(e){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,objects:{...s.objects,[e.id]:{...e,createTimestamp:e.createTimestamp??Date.now(),changeTimestamp:Date.now()}}})})),this}}const ut=Pe("app:MapObjectCurrent");class Tn{constructor(e,s){w(this,"idCache");w(this,"silenceActivator");this.drawer=e,this.factories=s,this.idCache=s.sourceEmpty.create(),this.silenceActivator=s.source.create(!1),this.idCache.value(s.patron.create(s.guest.create(n=>{n&&e.give("object")})))}silenceOn(e){return this.silenceActivator.give(e),this}silenceOff(){return this.silenceActivator.give(!1),this}objectId(e){return this.idCache.value(e),e}give(e){return ut("new value current object",e),this.silenceActivator.value(this.factories.guest.create(s=>{ut("silence activator",s),s?s.give(e):this.idCache.give(e)})),this}}class Mn{constructor(e,s){this.mapFile=e,this.factories=s}check(e,s){return this.mapFile.currentMap(this.factories.guest.create(n=>{let r=!1;Object.values(n.objects).forEach(o=>{r=r||o.arrows.some(a=>a.id===e.id)}),s.give(!r||"У объекта есть входящие связи!")})),this}}const Ue=B.debug("MapObjectNew");class In{constructor(e,s,n,r,o){this.map=e,this.mapObject=s,this.canvas=n,this.stagePosition=r,this.factories=o}byTypeName(e,s){return Ue("start to add new type",e,s),this.stagePosition.position(this.factories.guest.create(n=>{this.map.types(this.factories.guest.create(r=>{this.canvas.canvas(this.factories.guest.create(o=>{const a=o.getBoundingClientRect(),l=r.find(d=>d.id===e);Ue("is type found",l);const c=s.x-a.left,p=s.y-a.top;l&&(Ue("add new type"),this.mapObject.give({additionalName:"",arrows:[],description:"",inMenu:!1,lastClick:Date.now(),linked:!1,menuOrder:0,name:"",outlink:"",targetBlank:!1,type:e,width:l.width,height:l.height,zindex:0,id:new Date().getTime().toString(),createTimestamp:Date.now(),changeTimestamp:Date.now(),position:[c>0?c+n.x:0,p>0?p+n.y:0]}))}))}))})),this}}class jn{constructor(e,s){this.mapId=e,this.factories=s}names(e){return this.mapId.id(this.factories.guestInTheMiddle.create(e,s=>{const n=s.split("_").filter(a=>!!a);let r="";const o=n.map(a=>{const l=`${r}${a}`;return r||(r="_"),r+=`${a}_`,l});r="",e.give(o)})),e}}class Dn{constructor(e){this.mapObject=e}give(e){const{arrows:s}=e.object;return s.splice(e.index,1),this.mapObject.give({...e.object,arrows:s}),this}}class On{constructor(e,s,n,r){this.map=e,this.mapFile=s,this.checks=n,this.factories=r}give(e){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail(e,s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.objects[e.id],this.map.give(n)}))})),this}}const Pn=B.debug("MapObjectsLink");class Rn{constructor(e,s,n,r,o){w(this,"objectIdsCache");this.mapObjectCurrent=e,this.map=s,this.mapObject=n,this.newArrow=r,this.factories=o,this.objectIdsCache=o.cache.create([])}objectIds(e){return this.objectIdsCache.value(e),e}startLink(){this.mapObjectCurrent.give(""),this.objectIdsCache.value(this.factories.guest.create(e=>{if(e.length){this.mapObjectCurrent.silenceOff(),this.objectIdsCache.give([]);return}const s=["first"];this.objectIdsCache.give(s),this.mapObjectCurrent.silenceOn(this.factories.guest.create(n=>{s.push(n),this.objectIdsCache.give([...s]),Pn("object ids",s),s.length===2&&this.map.objects(this.factories.guest.create(r=>{const[,o]=s,a=r.find(l=>l.id===o);a&&this.newArrow.forObject(a)})),s.length===3&&(this.newArrow.dispose(),this.mapObjectCurrent.silenceOff(),this.map.objects(this.factories.guest.create(r=>{const[,o,a]=s,l=r.find(c=>c.id===o);l&&a&&(this.objectIdsCache.give([]),this.mapObject.give({...l,arrows:[...l.arrows,{id:a,label:""}]}))})))}))}))}}function Hn(i){var e=typeof i;return i!=null&&(e=="object"||e=="function")}var Qe=Hn,zn=typeof ye=="object"&&ye&&ye.Object===Object&&ye,Ln=zn,Un=Ln,Qn=typeof self=="object"&&self&&self.Object===Object&&self,vn=Un||Qn||Function("return this")(),ft=vn,Wn=ft,Gn=function(){return Wn.Date.now()},Kn=Gn,qn=/\s/;function Jn(i){for(var e=i.length;e--&&qn.test(i.charAt(e)););return e}var Yn=Jn,Zn=Yn,Xn=/^\s+/;function er(i){return i&&i.slice(0,Zn(i)+1).replace(Xn,"")}var tr=er,sr=ft,nr=sr.Symbol,gt=nr,yt=gt,wt=Object.prototype,rr=wt.hasOwnProperty,ir=wt.toString,he=yt?yt.toStringTag:void 0;function or(i){var e=rr.call(i,he),s=i[he];try{i[he]=void 0;var n=!0}catch{}var r=ir.call(i);return n&&(e?i[he]=s:delete i[he]),r}var ar=or,cr=Object.prototype,lr=cr.toString;function dr(i){return lr.call(i)}var hr=dr,At=gt,pr=ar,mr=hr,ur="[object Null]",fr="[object Undefined]",bt=At?At.toStringTag:void 0;function gr(i){return i==null?i===void 0?fr:ur:bt&&bt in Object(i)?pr(i):mr(i)}var yr=gr;function wr(i){return i!=null&&typeof i=="object"}var Ar=wr,br=yr,Cr=Ar,xr="[object Symbol]";function kr(i){return typeof i=="symbol"||Cr(i)&&br(i)==xr}var _r=kr,Br=tr,Ct=Qe,Nr=_r,xt=NaN,Vr=/^[-+]0x[0-9a-f]+$/i,$r=/^0b[01]+$/i,Sr=/^0o[0-7]+$/i,Fr=parseInt;function Er(i){if(typeof i=="number")return i;if(Nr(i))return xt;if(Ct(i)){var e=typeof i.valueOf=="function"?i.valueOf():i;i=Ct(e)?e+"":e}if(typeof i!="string")return i===0?i:+i;i=Br(i);var s=$r.test(i);return s||Sr.test(i)?Fr(i.slice(2),s?2:8):Vr.test(i)?xt:+i}var Tr=Er,Mr=Qe,ve=Kn,kt=Tr,Ir="Expected a function",jr=Math.max,Dr=Math.min;function Or(i,e,s){var n,r,o,a,l,c,p=0,d=!1,h=!1,m=!0;if(typeof i!="function")throw new TypeError(Ir);e=kt(e)||0,Mr(s)&&(d=!!s.leading,h="maxWait"in s,o=h?jr(kt(s.maxWait)||0,e):o,m="trailing"in s?!!s.trailing:m);function f(F){var N=n,_=r;return n=r=void 0,p=F,a=i.apply(_,N),a}function u(F){return p=F,l=setTimeout(b,e),d?f(F):a}function A(F){var N=F-c,_=F-p,k=e-N;return h?Dr(k,o-_):k}function g(F){var N=F-c,_=F-p;return c===void 0||N>=e||N<0||h&&_>=o}function b(){var F=ve();if(g(F))return C(F);l=setTimeout(b,A(F))}function C(F){return l=void 0,m&&n?f(F):(n=r=void 0,a)}function D(){l!==void 0&&clearTimeout(l),p=0,n=c=r=l=void 0}function V(){return l===void 0?a:C(ve())}function K(){var F=ve(),N=g(F);if(n=arguments,r=this,c=F,N){if(l===void 0)return u(c);if(h)return clearTimeout(l),l=setTimeout(b,e),f(c)}return l===void 0&&(l=setTimeout(b,e)),a}return K.cancel=D,K.flush=V,K}var _t=Or;const ne=je(_t),Pr=i=>{if(i[i.length-1]==="/"){const e=i.split("");return e.splice(e.length-1,1),e.join("")}return i},Rr=ne(i=>{window==null||window.open(i)},200),We=B.debug("MapObjectUrl");class Hr{constructor(e,s){this.mapId=e,this.factories=s}open(e,s){if(e!=null&&e.linked){const n=e.outlink;e.targetBlank?Rr(n):(We("open new map",n),this.factories.mapNameFromUrl.create(this.factories.source.create(n)).name(this.factories.guest.create(o=>{We("open map name",n,o),s.give(o)})))}return this}url(e,s){return e.value(this.factories.guestInTheMiddle.create(s,n=>{this.mapId.id(this.factories.guest.create(r=>{const o=r[0]==="_"?r.replaceAll("_","/"):"/current",a=n.name?n.name:n.additionalName?n.additionalName:"";this.factories.textNoHtml.create(this.factories.source.create(a)).noHtml(this.factories.guest.create(l=>{let c=n.outlink?n.outlink:`${o}/${zr(l)}`;We("link is",c),c=Pr(c),s.give(c)}))}))})),s}}function zr(i){return i.toLowerCase().replace(/ /g,"-").replace(/[^\w-]+/g,"")}const Lr=B.debug("ObjectPositionBounds");class Ur{constructor(e,s){this.stageSize=e,this.factories=s}position(e,s,n){return this.stageSize.value(this.factories.guestInTheMiddle.create(n,r=>{let{x:o,y:a}=s;o<30&&(o=30),a<30&&(a=30);const l=r.width-e.width;o>l&&(o=l);const c=r.height-e.height;a>c&&(a=c),Lr("position",o,a),n.give({x:o,y:a})})),n}}const _e=15;class Qr{constructor(e,s){this.baseRestriction=e,this.factories=s}position(e,s,n){return this.baseRestriction.position(e,s,this.factories.guestInTheMiddle.create(n,r=>{n.give({x:Math.round(r.x/_e)*_e,y:Math.round(r.y/_e)*_e})})),n}}const Bt={x:"width",y:"height"},Ge={x:0,y:1},vr={positive:1,negative:-1},Nt=B.debug("ObjectsOutsideScreen");class Wr{constructor(e,s,n,r){this.map=e,this.stageSize=s,this.layer=n,this.factories=r}count(e,s){const n=e.direction==="positive",r=this.factories.chain.create();return this.map.objects(this.factories.guestCast.create(s,r.receiveKey("objects"))),this.layer.layer(this.factories.guestCast.create(s,r.receiveKey("layer"))),this.layer.position(this.factories.guestCast.create(s,r.receiveKey("position"))),r.result(this.factories.guestInTheMiddle.create(s,({objects:o,layer:a,position:l})=>{var h;const c=vr[e.direction],d=o.sort((m,f)=>m.position[Ge[e.axis]]*c-f.position[Ge[e.axis]]*c).filter(m=>{const f=m.position[Ge[e.axis]]+(n?0:m[Bt[e.axis]]),u=l[e.axis]*-1+(n?a[Bt[e.axis]]():0);return Nt("mb nearest points",e.direction,"objectP=",f,"screenP=",u),n?f>u:f<u});Nt("nearest",d),s.give({count:d.length,nearestObjectId:((h=d.at(n?-1:0))==null?void 0:h.id)??""})})),s}}class Gr{constructor(e,s,n){this.mapFile=e,this.map=s,this.factories=n}give(e){return this.mapFile.currentMap(this.factories.guest.create(s=>{this.map.give({...s,settings:e})})),this}}class Kr{constructor(e){w(this,"idCache");this.idCache=e.sourceEmpty.create()}typeId(e){return this.idCache.value(e),e}give(e){return this.idCache.give(e),this}}class qr{constructor(e){this.mapType=e}byName(){const e=String(new Date().getTime());this.mapType.give({name:e,type:{id:e,name:"Новый тип",svg:'<div style="background: lightyellow;border: 1px solid #ccc;">type</div>',width:100,height:40}})}}class Jr{constructor(e,s,n,r){this.map=e,this.mapFile=s,this.checks=n,this.factories=r}give(e){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail({name:e.id,type:e},s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.types[e.id],this.map.give(n)}))})),this}}class Yr{constructor(e,s,n,r){this.map=e,this.mapFile=s,this.checks=n,this.factories=r}give(e){const s=this.factories.chain.create(this);return this.checks.forEach((n,r)=>{n.breakOnFail(e,s.receiveKey(String(r)))}),s.result(this.factories.guest.create(()=>{this.mapFile.currentMap(this.factories.guest.create(n=>{delete n.types[e.name],this.map.give({...n,types:{...n.types,[e.type.name]:e.type}})}))})),this}}const Zr=B.debug("MapTypeUsed");class Xr{constructor(e,s){this.mapFile=e,this.factories=s}check(e,s){return this.mapFile.currentMap(this.factories.guest.create(n=>{const r=Object.values(n.objects).some(o=>o.type===e.name);Zr("is type used",r),s.give(!r||"Тип карты использован")})),this}}class ei{constructor(e,s){this.mapTypeUsedCheck=e,this.factories=s}check(e,s){return this.mapTypeUsedCheck.check(e,this.factories.guest.create(n=>{n!==!0&&e.name!==e.type.name?s.give("Нельзя изменять имя типа, который использован!"):s.give(!0)})),this}}const Vt=B.debug("ParentTypes");class ti{constructor(e,s,n){this.parentNames=e,this.mapFile=s,this.factories=n}types(e){Vt("parent types requested");const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(e,s.receiveKey("parentNames"))),this.mapFile.mapFile(this.factories.guestCast.create(e,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(e,({parentNames:n,mapFile:r})=>{const o=n.slice(0,-1);Vt("parent names",o);const a={};o.map(c=>r[c]).forEach(c=>{Object.values(c.types).forEach(p=>{a[p.name]=p})}),e.give(Object.values(a))})),e}}const $t=B.debug("ObjectsMatchedToQuery");class si{constructor(e,s){this.map=e,this.factories=s}objects(e,s){return e.value(this.factories.guestInTheMiddle.create(s,ne(r=>{r=r.toLowerCase(),this.map.objects(this.factories.guest.create(o=>{if(!r){$t("reset results"),s.give([]);return}const a=o.filter(l=>{var c;return l.name.toLowerCase().includes(r)||((c=l.additionalName)==null?void 0:c.toLowerCase().includes(r))||Object.values(l.additionalFields??{}).join(" ").toLowerCase().includes(r)});$t("objects in searching",a,r),s.give(a)}))},500))),s}}const ni={height:3e3,width:3e3};class ri{value(e){return e.give(ni),e}}const St=B.debug("StageMoveRestriction");class ii{constructor(e,s,n){this.canvasDep=e,this.stageSize=s,this.factories=n}position(e,s){return this.canvasDep.canvas(this.factories.guest.create(n=>{this.stageSize.value(this.factories.guest.create(r=>{St("income position",e);const o=r.width-n.clientWidth,a=r.height-n.clientHeight,l=e.x*-1,c=e.y*-1;if(a<0||o<0)return{x:0,y:0};St("boundings",a,o,c,l),s.give({x:e.x>0?0:l>o?o*-1:e.x,y:e.y>0?0:c>a?a*-1:e.y})}))})),s}}const pe=B.debug("app:MapObjectsVisible");class oi{constructor(e,s,n,r){w(this,"visibleObjectsCache",new se);pe("constructor initialized");const o=r.chain.create();s.size(r.patron.create(o.receiveKey("size"))),e.position(r.patron.create(o.receiveKey("position"))),n.currentMap(r.patron.create(o.receiveKey("map"))),o.result(r.patron.create(r.guest.create(({position:a,size:l,map:c})=>{const p=Object.values(c.objects);pe("objects come to result",p);const d=p.filter(h=>{const m=c.types[h.type]??{},f={width:h.width||m.width,height:h.height||m.height};return this.isInBounding(a,l,h.position,f)});pe("visible objects calculated",d),this.visibleObjectsCache.give(d)})))}objects(e){return this.visibleObjectsCache.value(e),this}isInBounding(e,s,n,r){const o=e.x,a=e.x-s.width,l=e.y,c=e.y-s.height,[p,d]=n;return pe("bounding vars",o,a,l,c),pe("object position",n),o>-p-r.width&&-p>a&&l>-d-r.height&&-d>c}}const ai=(i,e)=>{const s=i.matchAll(e);return Array.from(s).map(n=>n[1])},ci=(i,e)=>i.reduce((s,n)=>(s[n]=e[n]||n,s),{});class li{constructor(e,s,n,r){this.mapFile=s,this.mapObject=n,this.factories=r,e.objectId(this)}give(e){return this.mapFile.currentMap(this.factories.guest.create(s=>{const n=s.objects[e];if(!n)return;const r=s.types[n.type],o=/\$\{([a-zA-Z1-9]+)\}/g,l=ai(r.svg,o).filter(c=>c!=="width"&&c!=="height");n.additionalFields=ci(l,n.additionalFields??{}),this.mapObject.give(n)})),this}introduction(){return"patron"}}class di{constructor(){w(this,"filledPoints",new Map)}clear(){this.filledPoints.clear()}breakPoints(e,s,n){const r=this.arrowPointPosition(e.shapeGeometry,e.shapePosition,e.lookToGeometry,e.lookToPosition),o=this.arrowPointPosition(s.shapeGeometry,s.shapePosition,s.lookToGeometry,s.lookToPosition);return n.give([+r.point.x+r.shift.x,+r.point.y+r.shift.y,+r.breakPoint.x+r.shift.x,+r.breakPoint.y+r.shift.y,+o.breakPoint.x+o.shift.x,+o.breakPoint.y+o.shift.y,+o.point.x+o.shift.x,+o.point.y+o.shift.y]),this}arrowPointPosition(e,s,n,r){return this.arrowPointPositionNear(e,s,n,r)}arrowPointPositionNear(e,s,n,r){const o={x:+r.x+Math.round(n.width/2),y:+r.y+Math.round(n.height/2)},a={x:+s.x+Math.round(e.width/2),y:+s.y+Math.round(e.height/2)},l=a.x-o.x,c=a.y-o.y,p=Math.abs(c)>Math.abs(l);let d=+s.x,h=+s.y;const m=p&&c>=0,f=!p&&l>=0,u=p&&c<0,A=!p&&l<0,g={x:0,y:0};let b=0,C=0;m?(d+=Math.round(e.width/2),g.x=d,g.y=(s.y+r.y+n.height)/2,b=r.x>s.x?1:-1):A?(h+=Math.round(e.height/2),d+=+e.width,g.x=(s.x+e.width+r.x)/2,g.y=h,C=r.y>s.y?1:-1):u?(d+=Math.round(e.width/2),h+=+e.height,g.x=d,g.y=(s.y+e.height+r.y)/2,b=r.x>s.x?1:-1):f&&(h+=Math.round(e.height/2),g.x=(s.x+r.x+n.width)/2,g.y=h,C=r.y>s.y?1:-1);const D=[d,h].join("-"),V=this.filledPoints.get(D)||0;return this.filledPoints.set(D,V+1),{point:{x:d,y:h},breakPoint:g,shift:{x:b*V*10,y:C*V*10}}}}class hi{constructor(e,s){this.objectsSource=e,this.objectsMapSource=s}value(e){const s=new Ce;return this.objectsSource.value(new O(e,s.receiveKey("objects"))),this.objectsMapSource.value(new O(e,s.receiveKey("objectsMap"))),s.result(new O(e,({objects:n,objectsMap:r})=>{const o=[];n.forEach(a=>{a.arrows.forEach(l=>{const c=r[l.id];c&&o.push({fromObject:a,toObject:c})})}),I(o,e)})),this}}class pi{constructor(e){this.arrowDeps=e}value(e){return this.arrowDeps.value(new O(e,s=>{if(s.type!=="threeBreaks")return;const n=this.points(s.fromObject,s.toObject),r=this.points(s.toObject,s.fromObject);I({key:s.fromObject.id+"-"+s.toObject.id,points:[+n.point.x+n.shift.x,+n.point.y+n.shift.y,+n.breakPoint.x+n.shift.x,+n.breakPoint.y+n.shift.y,+r.breakPoint.x+r.shift.x,+r.breakPoint.y+r.shift.y,+r.point.x+r.shift.x,+r.point.y+r.shift.y]},e)})),this}points(e,s){const n={x:+s.position[0]+Math.round(s.width/2),y:+s.position[1]+Math.round(s.height/2)},r={x:+e.position[0]+Math.round(e.width/2),y:+e.position[1]+Math.round(e.height/2)},o=r.x-n.x,a=r.y-n.y,l=Math.abs(a)>Math.abs(o);let c=+e.position[0],p=+e.position[1];const d=l&&a>=0,h=!l&&o>=0,m=l&&a<0,f=!l&&o<0,u={x:0,y:0};return d?(c+=Math.round(e.width/2),u.x=c,u.y=(e.position[1]+s.position[1]+s.height)/2,s.position[0]>e.position[0]):f?(p+=Math.round(e.height/2),c+=+e.width,u.x=(e.position[0]+e.width+s.position[0])/2,u.y=p,s.position[1]>e.position[1]):m?(c+=Math.round(e.width/2),p+=+e.height,u.x=c,u.y=(e.position[1]+e.height+s.position[1])/2,s.position[1]>e.position[1]):h&&(p+=Math.round(e.height/2),u.x=(e.position[0]+s.position[0]+s.width)/2,u.y=p,s.position[1]>e.position[1]),{point:{x:c,y:p},breakPoint:u,shift:{x:0,y:0}}}}class mi{constructor(e){this.arrowDeps=e}value(e){return this.arrowDeps.value(new O(e,s=>{s.type==="twoBreaks"&&I({key:s.fromObject.id+"-"+s.toObject.id,points:this.points(s.fromObject,s.toObject)},e)})),this}points(e,s){const n={startHeight:e.position[1],startWidth:e.position[0],midHeight:e.position[1]+Math.round(e.height/2),midWidth:e.position[0]+Math.round(e.width/2),fullHeight:e.position[1]+e.height,fullWidth:e.position[0]+e.width},r={startHeight:s.position[1],startWidth:s.position[0],midHeight:s.position[1]+Math.round(s.height/2),midWidth:s.position[0]+Math.round(s.width/2),fullHeight:s.position[1]+s.height,fullWidth:s.position[0]+s.width},o={"left-top":()=>n.fullWidth<r.startWidth&&n.fullHeight<r.startHeight,"right-top":()=>r.fullWidth<n.startWidth&&n.fullHeight<r.startHeight,"left-bottom":()=>n.fullWidth<r.startWidth&&r.fullHeight<n.startHeight,"right-bottom":()=>r.fullWidth<n.startWidth&&r.fullHeight<n.startHeight},a={"left-top":()=>[n.fullWidth,n.midHeight,r.midWidth,n.midHeight,r.midWidth,r.startHeight],"right-top":()=>[n.startWidth,n.midHeight,r.midWidth,n.midHeight,r.midWidth,r.startHeight],"left-bottom":()=>[n.fullWidth,n.midHeight,r.midWidth,n.midHeight,r.midWidth,r.fullHeight],"right-bottom":()=>[n.startWidth,n.midHeight,r.midWidth,n.midHeight,r.midWidth,r.fullHeight]},l=Object.entries(o).reduce((c,[p,d])=>(d()&&(c=p),c),"left-top");return a[l]()}}class ui{constructor(e,s=10){this.arrowDepsSource=e,this.centerGap=s}value(e){return this.arrowDepsSource.value(new O(e,({fromObject:s,toObject:n})=>{const r={width:s.width,height:s.height},o={x:s.position[0],y:s.position[1]},a={width:n.width,height:n.height},l={x:n.position[0],y:n.position[1]},c={x:+l.x+Math.round(a.width/2),y:+l.y+Math.round(a.height/2)},p={x:+o.x+Math.round(r.width/2),y:+o.y+Math.round(r.height/2)},d=Math.abs(c.x-p.x)-(a.width+this.centerGap),h=Math.abs(c.y-p.y)-(a.height+this.centerGap);I({fromObject:s,toObject:n,type:d<0||h<0?"threeBreaks":"twoBreaks"},e)})),this}}class fi{constructor(e){this.basePoints=e}value(e){return this.basePoints.value(new O(e,s=>{const n={};s.forEach((r,o)=>{const a=""+r.points.at(0)+r.points.at(1);n[a]||(n[a]=[]),n[a].push({arrowIndex:o,pointStartIndex:0,breakPointStartIndex:2,pointEndIndex:r.points.length-2});const l=""+r.points.at(-2)+r.points.at(-1);n[l]||(n[l]=[]),n[l].push({arrowIndex:o,pointStartIndex:r.points.length-2,breakPointStartIndex:r.points.length-4,pointEndIndex:0})}),I(n,e)})),this}}const Be=15;class gi{constructor(e){w(this,"pointGroups");this.basePoints=e,this.pointGroups=new fi(e)}value(e){const s=new Ce;return this.pointGroups.value(new O(e,s.receiveKey("pointGroups"))),this.basePoints.value(new O(e,s.receiveKey("basePoints"))),s.result(new O(e,({pointGroups:n,basePoints:r})=>{Object.values(n).forEach(o=>{if(o.length<=1)return;o.sort((c,p)=>r[p.arrowIndex].points[p.pointEndIndex]-r[c.arrowIndex].points[c.pointEndIndex]);let a=0,l=0;o.forEach((c,p)=>{const d=r[c.arrowIndex].points[c.pointStartIndex],h=r[c.arrowIndex].points[c.pointStartIndex+1],m=r[c.arrowIndex].points[c.pointEndIndex],f=r[c.arrowIndex].points[c.pointEndIndex+1],u=r[c.arrowIndex].points[c.breakPointStartIndex],A=r[c.arrowIndex].points[c.breakPointStartIndex+1],g=d>u?-1:d<u?1:0,b=h>A?-1:h<A?1:0,C=d>m?-1:d<m?1:0,D=h>f?-1:h<f?1:0;if(g!==0){let V=0;p!==0&&(D>0?(l+=1,V=l):(a+=1,V=a)),D&&(r[c.arrowIndex].points[c.pointStartIndex+1]=r[c.arrowIndex].points[c.pointStartIndex+1]+V*D*Be),r[c.arrowIndex].points[c.breakPointStartIndex+1]=r[c.arrowIndex].points[c.breakPointStartIndex+1]+V*D*Be}if(b!==0){let V=0;p!==0&&(C>0?(l+=1,V=l):(a+=1,V=a)),r[c.arrowIndex].points[c.pointStartIndex]=r[c.arrowIndex].points[c.pointStartIndex]+V*C*Be,r[c.arrowIndex].points[c.breakPointStartIndex]=r[c.arrowIndex].points[c.breakPointStartIndex]+V*C*Be}})}),I(r,e)})),this}}class yi{constructor(e){this.guestAwares=e}value(e){let s=null;return this.guestAwares.forEach(n=>{n.value(new O(e,r=>{(!s||s===n)&&(I(r,e),s=n)}))}),this}}class wi{constructor(e,s){this.baseSource=e,this.targetSourceFactory=s}value(e){const s=new Ce,n=new se,r=this.targetSourceFactory.create(n);return this.baseSource.value(new O(e,o=>{let a=0;const l=()=>{o[a+1]!==void 0?(a=a+1,c()):s.resultArray(e)};function c(){n.give(o[a]),r.value(s.receiveKey(""+a)),r.value(l)}o[a]!==void 0?c():I([],e)})),this}}class Ai{constructor(e){this.buildingFn=e}create(...e){return this.buildingFn(...e)}}var bi=_t,Ci=Qe,xi="Expected a function";function ki(i,e,s){var n=!0,r=!0;if(typeof i!="function")throw new TypeError(xi);return Ci(s)&&(n="leading"in s?!!s.leading:n,r="trailing"in s?!!s.trailing:r),bi(i,e,{leading:n,maxWait:e,trailing:r})}var _i=ki;const Bi=je(_i),{Arrow:Ni}=Z,Vi=B.debug("MapObjectsArrows");class $i{constructor(e,s,n,r,o){w(this,"previouslyRenderedArrows",new Map);this.konvaLayer=e,this.mapFile=s,this.mapDep=n,this.arrowPath=r,this.factories=o,Vi("draw arrows on canvas");const a=this.factories.chain.create();this.konvaLayer.layer(this.factories.patron.create(a.receiveKey("layer"))),this.mapFile.currentMap(this.factories.patron.create(a.receiveKey("map"))),this.mapDep.objects(this.factories.patron.create(a.receiveKey("objects"))),a.result(this.factories.patron.create(this.factories.guest.create(Bi(({layer:l,map:c,objects:p})=>{this.previouslyRenderedArrows.forEach(m=>{m.arrow.hide()});const d=p.reduce((m,f)=>(m[f.id]=f,m),{});new gi(new wi(new hi(new ae(m=>I(p,m)),new ae(m=>I(d,m))),new Ai(m=>{const f=new ui(m);return new yi([new mi(f),new pi(f)])}))).value(m=>{m.forEach(f=>{const u=f.key;if(this.previouslyRenderedArrows.has(u)){const g=this.previouslyRenderedArrows.get(u);g.arrow.show(),g.arrow.points(f.points);return}const A=new Ni({x:0,y:0,points:f.points,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2});this.previouslyRenderedArrows.set(u,{arrow:A}),l.add(A)})})},50))))}introduction(){return"patron"}}const{Arrow:Si}=Z,Ke=B.debug("NewArrow"),Ft={width:10,height:10};class Fi{constructor(e,s,n,r){w(this,"cursorGuest");w(this,"arrowCache");this.konvaLayer=e,this.cursorPosition=s,this.arrowPath=n,this.factories=r,this.cursorGuest=this.factories.sourceEmpty.create(),this.arrowCache=this.factories.sourceEmpty.create()}forObject(e){Ke("start watch cursor"),this.cursorGuest.value(this.factories.guest.create(r=>{ot(r)}));let s=null;const n=this.factories.patron.create(this.factories.guest.create(r=>{Ke("cursor moves"),this.konvaLayer.layer(this.factories.guest.create(o=>{Ke("cursor moves in layer"),this.arrowPath.breakPoints({shapeGeometry:{width:e.width,height:e.height},shapePosition:{x:e.position[0],y:e.position[1]},lookToGeometry:Ft,lookToPosition:r},{lookToGeometry:{width:e.width,height:e.height},lookToPosition:{x:e.position[0],y:e.position[1]},shapeGeometry:Ft,shapePosition:r},this.factories.guest.create(a=>{if(s){s.points(a);return}s=new Si({x:0,y:0,points:a,pointerLength:20,pointerWidth:10,fill:"#ccc",stroke:"#bbb",strokeWidth:2,zIndex:2}),o.add(s),this.arrowCache.give(s)}))})),this.arrowPath.clear()}));this.cursorPosition.value(n),this.cursorGuest.give(n)}dispose(){this.cursorGuest.value(this.factories.guest.create(e=>{ot(e)})),this.arrowCache.value(this.factories.guest.create(e=>{e.remove()}))}}const me=B.debug("MapObjectBackground"),Ei="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEBLAEsAAD//gATQ3JlYXRlZCB3aXRoIEdJTVD/4gKwSUNDX1BST0ZJTEUAAQEAAAKgbGNtcwQwAABtbnRyUkdCIFhZWiAH6AAMAAQADQAqAAthY3NwQVBQTAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1kZXNjAAABIAAAAEBjcHJ0AAABYAAAADZ3dHB0AAABmAAAABRjaGFkAAABrAAAACxyWFlaAAAB2AAAABRiWFlaAAAB7AAAABRnWFlaAAACAAAAABRyVFJDAAACFAAAACBnVFJDAAACFAAAACBiVFJDAAACFAAAACBjaHJtAAACNAAAACRkbW5kAAACWAAAACRkbWRkAAACfAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACQAAAAcAEcASQBNAFAAIABiAHUAaQBsAHQALQBpAG4AIABzAFIARwBCbWx1YwAAAAAAAAABAAAADGVuVVMAAAAaAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA9tYAAQAAAADTLXNmMzIAAAAAAAEMQgAABd7///MlAAAHkwAA/ZD///uh///9ogAAA9wAAMBuWFlaIAAAAAAAAG+gAAA49QAAA5BYWVogAAAAAAAAJJ8AAA+EAAC2xFhZWiAAAAAAAABilwAAt4cAABjZcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPXAABUfAAATM0AAJmaAAAmZwAAD1xtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFBtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEL/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wgARCAAeAB4DAREAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAwUEAAj/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAH1SCMTDaCMTiuCMTDgxDGf/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAMBAgQFExUyMxL/2gAIAQEAAQUCG9TUPHdga2PndgzrxZQ3qah48gsvnUtHILMrKq5f/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAwEBPwEH/8QAFBEBAAAAAAAAAAAAAAAAAAAAQP/aAAgBAgEBPwEH/8QAHhAAAgIBBQEAAAAAAAAAAAAAAAECMXIQQUKSsVH/2gAIAQEABj8CFkvdFkVLqzla4v6VLqxXe60WS90WRUipWipCSTvc/8QAIxAAAgADCAMAAAAAAAAAAAAAAAEQUfAhMUGhscHR8RFhcf/aAAgBAQABPyErMkMi0ZW2wylmzHorbYSSX3Vg5wrMkMi0Z0a5FVK8Llg05nRrkRmteVg//9oADAMBAAIAAwAAABCCQQSCSST/xAAUEQEAAAAAAAAAAAAAAAAAAABA/9oACAEDAQE/EAf/xAAUEQEAAAAAAAAAAAAAAAAAAABA/9oACAECAQE/EAf/xAAeEAEAAQQCAwAAAAAAAAAAAAABIRARIDEAQVFxkf/aAAgBAQABPxDEMgTA4U0lpO6EwKiFh/YAyDIEAZSTdCnwUQAma0AtZOl88//Z";class Ti{constructor(e,s,n,r){w(this,"mapNameCache");this.konvaLayer=e,this.mapFile=s,this.zIndex=n,this.factories=r,this.mapNameCache=r.cache.create(""),this.mapFile.currentMap(r.patron.create(this))}give(e){return this.konvaLayer.layer(this.factories.patronOnce.create(s=>{me("map received in background",e),this.mapNameCache.value(this.factories.guest.create(n=>{if(n===e.url)return;me("background cache is not equals",n),this.mapNameCache.give(e.url);const r=new Image,o=document.querySelector(".grid-example");me("grid example",o),r.src=Ei,r.onload=()=>{me("canvas pattern loaded"),me("konva layer loaded");const a=new Z.Rect({width:3e3,height:3e3,x:0,y:0,fillPatternImage:r,zIndex:1});this.zIndex.give(()=>{a.zIndex(0)}),s.add(a)}}))})),this}}const Mi=B.debug("Breadcrumbs");class Ii{constructor(e,s,n){this.parentNames=e,this.mapFile=s,this.factories=n}list(e){const s=this.factories.chain.create();return this.parentNames.names(this.factories.guestCast.create(e,s.receiveKey("names"))),this.mapFile.mapFile(this.factories.guestCast.create(e,s.receiveKey("mapFile"))),s.result(this.factories.guestInTheMiddle.create(e,({names:n,mapFile:r})=>{Mi("map id",n,r),e.give(n.map(o=>{var a,l;return{title:((l=(a=r[o])==null?void 0:a.settings)==null?void 0:l.title)||"unknown",name:o}}))})),e}}const Et=B.debug("CursorWithObjects");class ji{constructor(e,s,n){this.objectsVisible=e,this.cursor=s,this.factories=n}value(e){const s=this.factories.chain.create();return this.cursor.value(this.factories.guestCast.create(e,s.receiveKey("cursor"))),this.objectsVisible.objects(this.factories.guestCast.create(e,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(e,({cursor:n,objects:r})=>{const o=r.find(a=>{const l=a.position[0],c=a.position[0]+a.width||100,p=a.position[1],d=a.position[1]+a.height||100;return n.x>=l&&n.x<=c&&n.y>=p&&n.y<=d});o?(Et("crossed with",o),e.give({x:o.position[0]+o.width/2,y:o.position[1]+o.height/2})):(Et("cursor pos",n),e.give(n))})),this}}class Di{constructor(e,s=768){this.windowWidth=e,this.mobileLimit=s}value(e){return this.windowWidth.value(new O(e,s=>{I({isMobile:s<=this.mobileLimit,isDesktop:s>this.mobileLimit},e)})),this}}const Tt=B.debug("Drawer");class Oi{constructor(e,s){w(this,"drawerNameCache");this.keyboard=e,this.factories=s,this.drawerNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(n=>{Tt("new key in drawer",n),n==="Escape"&&this.give("")})))}isOpenedByName(e,s){return this.drawerNameCache.value(this.factories.guestInTheMiddle.create(s,n=>{Tt("new drawer name",n),s.give(n===e)})),s}openedByName(e){return this.factories.guestAware.create(s=>{this.isOpenedByName(e,s)})}give(e){return this.drawerNameCache.give(e),this}}class Pi{value(e){typeof performance>"u"&&e.give(0);const s=10;let n=performance.now(),r=0;const o=()=>requestAnimationFrame(()=>{if(r+=1,r>=s){const a=performance.now(),l=a-n;e.give(Math.round(1e3/(l/r))),n=a,r=0}o()});return o(),e}}class Ri{constructor(e,s){this.mapFile=e,this.factories=s}menuObjects(e){return this.mapFile.currentMap(this.factories.guestInTheMiddle.create(e,s=>{const n=Object.values(s.objects).filter(r=>r.inMenu);e.give(n)})),e}}const Mt=B.debug("app:MiniMap"),It=130;class Hi{constructor(e,s,n,r){w(this,"theSize");w(this,"thePoints");w(this,"viewportSizeCache");this.map=e,this.layer=s,this.stageSize=n,this.factories=r,this.theSize=r.sourceEmpty.create(),this.thePoints=r.sourceEmpty.create(),this.viewportSizeCache=r.sourceEmpty.create();const o=r.chain.create();e.objects(r.patron.create(o.receiveKey("objects"))),s.layer(r.patron.create(o.receiveKey("layer"))),n.value(r.patron.create(o.receiveKey("size"))),o.result(r.patron.create(r.guest.create(({layer:a,size:l,objects:c})=>{const p=It/l.width,d={width:Math.round(a.width()*p),height:Math.round(a.height()*p)};this.viewportSizeCache.give(d);const h={width:Math.round(l.width*p),height:Math.round(l.height*p)};this.theSize.give(h);const m=c.map(f=>({id:f.id,x:Math.round(f.position[0]*p),y:Math.round(f.position[1]*p),width:Math.round(f.width*p),height:Math.round(f.height*p)}));Mt("minimap points",m),this.thePoints.give(m)})))}viewportPosition(e){const s=this.factories.chain.create();return this.stageSize.value(this.factories.guestCast.create(e,s.receiveKey("size"))),this.layer.position(this.factories.guestCast.create(e,s.receiveKey("position"))),s.result(this.factories.guestInTheMiddle.create(e,({size:n,position:r})=>{const o=It/n.width,a={x:r.x*o*-1,y:r.y*o*-1};Mt("scaled position is",a),e.give(a)})),e}viewportSize(e){return this.viewportSizeCache.value(e),e}size(e){return this.theSize.value(e),e}points(e){return this.thePoints.value(e),e}}const jt=B.debug("Modal");class zi{constructor(e,s){w(this,"modalNameCache");this.keyboard=e,this.factories=s,jt("modal created"),this.modalNameCache=s.cache.create(""),this.keyboard.pressed(this.factories.patron.create(this.factories.guest.create(n=>{jt("new key in modal",n),n==="Escape"&&this.give("")})))}isOpenedByName(e,s){return this.modalNameCache.value(this.factories.guestInTheMiddle.create(s,n=>{s.give(n===e)})),s}openedByName(e){return this.factories.guestAware.create(s=>{this.isOpenedByName(e,s)})}give(e){return this.modalNameCache.give(e),this}}class Li{constructor(e){w(this,"messageCache");w(this,"notificationLifetimeDelay",3500);w(this,"lastTimerHead",null);this.messageCache=e.sourceEmpty.create()}message(e){return this.messageCache.value(e),e}give(e){return this.messageCache.give(e),this.lastTimerHead&&clearTimeout(this.lastTimerHead),this.lastTimerHead=setTimeout(()=>{this.messageCache.give({type:"success",text:"hide"})},this.notificationLifetimeDelay),this}}const ue=B.debug("ObjectGeometryFix");class Ui{constructor(e,s,n,r){w(this,"innerReceive");this.mapFile=s,this.map=n,this.factories=r,e.objects(r.patron.create(this)),this.innerReceive=ne(o=>{this.mapFile.currentMap(this.factories.guest.create(a=>{ue("objects to fix",o);const l=document.querySelectorAll(".objects-container .rendered-object"),c=a.objects;let p=!1;l.forEach(d=>{const h=d.getAttribute("data-object-id");if(ue("i see id",h),!h)return;const m=c[h];if(m&&(ue("dom object geometry",d.clientWidth,d.clientHeight),ue("saved object geometry",m.width,m.height),(m.width!==d.clientWidth||m.height!==d.clientHeight)&&(p=!0,ue("update object geometry"),m.width=d.clientWidth,m.height=d.clientHeight),!m.width||!m.height)){const f=a.types[m.type];m.width=f.width,m.height=f.height}}),p&&this.map.give({...a,objects:c})}))},500)}give(e){return this.innerReceive(e),this}}const fe=B.debug("MapObjectsRectsPatron");class Qi{constructor(e,s,n,r,o,a,l,c,p){w(this,"previouslyRenderedRects",new Map);this.konvaLayer=e,this.mapFile=s,this.mapObject=n,this.mapObjectCurrent=o,this.mapObjectForRendering=a,this.objectPosition=l,this.settings=c,this.factories=p,r.objects(this)}give(e){return this.konvaLayer.layer(this.factories.patronOnce.create(this.factories.guest.create(s=>{const n=this.factories.chain.create();this.mapFile.currentMap(n.receiveKey("map")),this.settings.value(n.receiveKey("settings")),n.result(this.factories.guest.create(r=>{const{map:o,settings:a}=r;fe("rerender object rects"),this.previouslyRenderedRects.forEach(l=>{l.hide()}),e.forEach(l=>{const c=o.types[l.type],p=+l.width||+c.width||100,d=+l.height||+c.height||100;if(this.previouslyRenderedRects.has(l)){const f=this.previouslyRenderedRects.get(l);f.width(p),f.height(d),f.x(+l.position[0]),f.y(+l.position[1]),f.show();return}fe("rect object",l,c);const h=new Z.Rect({x:+l.position[0],y:+l.position[1],width:p,height:d,name:l.id,draggable:!a.readonly,objectId:l.id,zIndex:3});this.previouslyRenderedRects.set(l,h),s.add(h),h.on("mouseenter",()=>{s.getStage().container().style.cursor="pointer"}),h.on("mouseleave",()=>{s.getStage().container().style.cursor="default"}),h.on("dragend",()=>{fe("drag ended"),this.objectPosition.position(l,{x:h.x(),y:h.y()},this.factories.guest.create(f=>{this.mapObject.give({...l,position:[f.x,f.y]})}))}),h.on("dragmove",()=>{fe("dragmove works",h.x(),h.y()),s.getStage().container().style.cursor="move",this.objectPosition.position(l,{x:h.x(),y:h.y()},this.factories.guest.create(f=>{this.mapObjectForRendering.give({...l,position:[f.x,f.y]})}))});const m=()=>{fe("object clicked with id",l.id),this.mapObjectCurrent.give(l.id)};h.on("click",m),h.on("tap",m)})}))}))),this}introduction(){return"patron"}}class vi{constructor(e,s,n,r){this.canvas=s,this.konvaLayer=n,this.factories=r,e.currentMap(this)}give(){const e=new ResizeObserver(n=>{requestAnimationFrame(()=>{const[r]=n;this.canvas.canvas(this.factories.guest.create(o=>{const a=o.getBoundingClientRect();this.konvaLayer.layer(this.factories.guest.create(l=>{l.getStage().width(r.contentRect.width-a.left),l.getStage().height(r.contentRect.height-a.top),this.canvas.give(o),this.konvaLayer.give(l)}))}))})}),s=document.querySelector("body");return s&&e.observe(s),this}}const Wi=B.debug("StagePosition");class Gi{constructor(e){this.stageMove=e}give(e){return Wi("received position",e),this.stageMove.move(e),this}}class Ki{constructor(e,s){this.stageMove=e,this.factories=s}move(e,s){return e.value(this.factories.guest.create(n=>{this.stageMove.move(n.objects[s])})),this}}class qi{constructor(){w(this,"source",new X({height:window.innerHeight,width:window.innerWidth}));const e=new ResizeObserver(ne(n=>{requestAnimationFrame(()=>{this.source.give({height:window.innerHeight,width:window.innerWidth})})},50)),s=document.querySelector("body");s&&e.observe(s)}value(e){return this.source.value(e),this}}const Dt=B.debug("Zindex");class Ji{constructor(e){w(this,"fnsCache");this.factories=e,this.fnsCache=e.cache.create([]),this.fnsCache.value(e.patron.create(e.guest.create(ne(s=>{Dt("zindex fns run"),s.forEach(n=>n())},50))))}give(e){return Dt("zindex received value"),this.fnsCache.value(this.factories.guest.create(s=>{this.fnsCache.give(s.concat(e))})),this}}const Ot=B.debug("app:BrowserCanvas");class Yi{constructor(e){w(this,"canvasCache");this.factories=e,this.canvasCache=e.sourceEmpty.create()}canvas(e){return this.canvasCache.value(e),this}size(e){return this.canvasCache.value(this.factories.guestInTheMiddle.create(e,s=>{const n=s.width||s.clientWidth,r=s.height||s.clientHeight;Ot("canvas size",n,r),e.give({height:r,width:n})})),this}give(e){return Ot("receive new canvas",e),this.canvasCache.give(e),this}}const Zi=B.debug("Cursor");class Xi{constructor(e,s){w(this,"cursorPool");this.cursorPool=s.pool.create(this);const n={x:0,y:0};window==null||window.addEventListener("mousemove",r=>{const o={x:r.offsetX+-n.x,y:r.offsetY+-n.y};Zi("move cursor fired",o),this.cursorPool.give(o)}),e.position(s.patron.create(s.guest.create(r=>{n.x=r.x,n.y=r.y})))}value(e){return this.cursorPool.add(e),this}}class eo{constructor(e){this.el=e,e.value(this)}give(e){return e.addEventListener("dragstart",s=>{const n=s.target;if(!n)return;const r=n.cloneNode(!0);r.style.transform="translate(0,0)",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.zIndex="999",s.dataTransfer&&s.dataTransfer.setDragImage(r,0,0),document.body.append(r);const o=a=>{r.style.transform=`translate(${a.clientX}px, ${a.clientY}px)`};n.addEventListener("drag",o,{passive:!0}),n.addEventListener("dragend",()=>{r.removeEventListener("drag",o),r.remove()})}),this}introduction(){return"patron"}}const Ne=B.debug("ControlCombo");class to{constructor(e,s){this.keyboard=e,this.factories=s}happened(e,s){this.keyboard.event(this.factories.guestInTheMiddle.create(s,n=>{Ne("combo happened look for key",e,"received",n.code),n.ctrlKey&&n.code===e&&n.type==="keydown"&&(n.preventDefault(),s.give(n))}))}happenedConditional(e,s,n){Ne("combo control happened registration"),this.keyboard.event(this.factories.guestInTheMiddle.create(n,r=>{Ne("keyboard event come"),s.value(this.factories.guest.create(o=>{Ne("combo happened look for key",e,"received",r.code),o&&r.ctrlKey&&r.code===e&&r.type==="keydown"&&(r.preventDefault(),n.give(r))}))}))}}const ge=B.debug("Keyboard");class so{constructor(e){w(this,"pressedPool");w(this,"combinationsPool");ge("keyboard created"),this.pressedPool=e.pool.create(this),this.combinationsPool=e.pool.create(this),window==null||window.addEventListener("keyup",s=>{ge("keyboard pressed",s.key),this.pressedPool.give(s.key)}),L.useMagicKeys({passive:!1,onEventFired:s=>{ge("magic combination happens 11",s.ctrlKey,s.key),this.combinationsPool.give(s)}})}pressed(e){return ge("keyboard receive pressed subscriber"),this.pressedPool.add(e),this}event(e){return ge("keyboard receive combination subscriber"),this.combinationsPool.add(e),this}}const Pt=B.debug("app:konva:KonvaLayer");class no{constructor(e,s,n,r){w(this,"guestChain");w(this,"positionCache");w(this,"layerCache");this.canvasDep=e,this.stageMoveRestriction=n,this.factories=r,this.positionCache=r.cache.create({x:0,y:0}),this.guestChain=r.chain.create(),this.layerCache=r.sourceEmpty.create(),this.canvasDep.canvas(r.patron.create(this.guestChain.receiveKey("canvas"))),s.value(this.guestChain.receiveKey("stageSize")),this.guestChain.result(r.guest.create(({canvas:o})=>{Pt("create new konva stage");const a=new Z.Stage({width:o.clientWidth,height:o.clientHeight,container:o,fill:"#ffeeee",draggable:!0}),l=new Z.Layer;a.add(l),l.draw(),this.layerCache.give(l),a.on("dragend",p=>{if(!(p.target instanceof Z.Stage))return;const d={x:a.x(),y:a.y()};Pt("new position",d),this.positionCache.give(d)}),a.on("dragmove",p=>{if(!(p.target instanceof Z.Stage))return;const d={x:a.x(),y:a.y()};this.positionCache.give(d)});const c=this.factories.guestSync.create({x:0,y:0});a.dragBoundFunc(p=>(n.position(p,c),c.value()))}))}layer(e){return this.layerCache.value(e),e}position(e){return this.positionCache.value(e),e}give(e){this.layerCache.give(e);const s=e.getStage();return this.positionCache.give({x:s.x(),y:s.y()}),this}}class ro{constructor(e,s){this.konvaLayer=e,this.factories=s}position(e){return this.konvaLayer.position(this.factories.guestInTheMiddle.create(e,s=>{e.give({x:s.x*-1,y:s.y*-1})})),e}}const io=B.debug("position");class oo{constructor(e,s,n,r,o){this.layer=e,this.canvas=s,this.stageSize=n,this.stageMoveRestriction=r,this.factories=o}move(e){io("move stage to new point",e.position),this.stageSize.value(this.factories.guest.create(()=>{this.canvas.size(this.factories.guest.create(s=>{this.layer.layer(this.factories.guest.create(n=>{const[r,o]=e.position,a={x:-r-Math.round(e.width/2)+Math.round(s.width/2),y:-o-Math.round(e.height/2)+Math.round(s.height/2)};this.stageMoveRestriction.position(a,this.factories.guest.create(l=>{n.getStage().position(l),setTimeout(()=>{this.layer.give(n)})}))}))}))}))}}const y=H(),Ve=new so(y),Rt=new X({readonly:!1,presets:{}}),ao=new zi(Ve,y),Ht=new Oi(Ve,y),$e=new Li(y),J=new Bn(y),zt=y.sourceEmpty.create(),T=new Sn(zt,J,y),co=new Nn(T),lo=new Ps(co),qe=new En(T,J,y),Je=new ht(qe,J,y),ho=new mt(Je,qe,y),U=new ht(T,J,y),po=new ae(i=>{T.currentMap(new Ae(i))}),Se=new Tn(Ht,y),mo=new Kr(y),uo=new Gr(T,U,y),re=new Yi(y),ie=new ri,Lt=new ii(re,ie,y),Q=new no(re,ie,Lt,y),fo=new Ji(y),go=new Ti(Q,T,fo,y),ce=new mt(U,T,y),yo=new On(U,T,[new ze($e,new Mn(T,y),y)],y),wo=new ro(Q,y),Ao=new In(U,ce,re,wo,y),Ut=new Xr(T,y),Qt=new Yr(U,T,[new ze($e,new ei(Ut,y),y)],y),bo=new Jr(U,T,[new ze($e,Ut,y)],y),Co=new qr(Qt),Fe=new oi(Q,re,qe,y),xo=new Ui(Fe,T,U,y),ko=new Qi(Q,T,ce,Fe,Se,ho,new Qr(new Ur(ie,y),y),Rt,y),_o=new Xi(Q,y),Bo=new ji(Fe,_o,y),vt=new di,Wt=new Fi(Q,Bo,vt,y),No=new $i(Q,T,Je,vt,y),Vo=new Hi(Je,Q,ie,y),$o=new Rn(Se,U,ce,Wt,y),So=new vi(T,re,Q,y),Fo=new li(Se,T,ce,y),Eo=new $n(T,J,y),To=new Dn(ce),Mo=new Pi,Ye=new jn(J,y),Io=new Ii(Ye,T,y),jo=new Hr(J,y),Do=new ti(Ye,T,y),Oo=new to(Ve,y),Po=new Ri(T,y),Gt=new oo(Q,re,ie,Lt,y),Ro=new Gi(Gt),Ho=new Ki(Gt,y),zo=new si(U,y),Lo=new Vn(T,U,J,y),Uo=new Wr(U,ie,Q,y),Kt=new se;new eo(Kt);const Qo=new qi,vo=new ae(i=>{Qo.value(new O(i,e=>{I(e.width,i)}))}),Wo=new Di(vo),Go={mapCurrentID:J,mapFile:T,mapCurrent:U,mapCurrentSource:po,mapRemoved:Eo,mapSettings:uo,mapObject:ce,mapObjectRemoved:yo,mapType:Qt,mapTypeRemoved:bo,mapTypeNew:Co,mapObjectsVisible:Fe,mapObjectCurrent:Se,mapObjectNew:Ao,mapObjectsLink:$o,mapTypeCurrent:mo,mapRects:ko,mapBackground:go,mapObjectArrows:No,mapObjectsGeometryFix:xo,canvas:re,miniMap:Vo,notification:$e,modal:ao,drawer:Ht,konvaLayer:Q,resizing:So,objectAdditionalFieldsFix:Fo,mapObjectRelationRemoved:To,fps:Mo,breadcrumbs:Io,mapObjectUrl:jo,keyboard:Ve,parentNames:Ye,parentTypes:Do,controlCombo:Oo,menu:Po,stagePosition:Ro,stagePositionByObjectId:Ho,objectsMatchedToQuery:zo,stageSize:ie,mapHistory:Lo,fileContent:zt,newArrow:Wt,objectsOutsideScreen:Uo,settings:Rt,documentTitle:lo,sidebarDraggable:Kt,device:Wo},j=()=>Go;class x{constructor(e=void 0){w(this,"innerRef");this.innerRef=t.ref(e)}get value(){return this.innerRef.value}ref(){return this.innerRef}give(e){return this.innerRef.value=e,this}introduction(){return"patron"}}const Ko={key:0},qo={class:"flex-grow overflow-y-auto"},Jo={key:1,class:"flex gap-1"},Ze=t.defineComponent({__name:"BaseDrawer",props:{name:{type:String,required:!0},direction:{type:String,default:"ltr",validator:i=>["ltr","rtl","ttb","btt"].includes(i)}},emits:["close"],setup(i,{emit:e}){const s=i,n=e,r=t.computed(()=>["e2e-drawer-back absolute z-10 top-0 left-0 w-full h-full bg-black/50"]),o={ltr:"top-0 left-0 w-[50%] max-w-[900px] ",rtl:"top-0 right-0 w-[50%] max-w-[900px] ",ttb:"top-0 right-0 left-0",btt:"top-auto h-[900px] max-h-[50%] bottom-0 right-0 left-0"},{drawer:a,device:l}=j(),c=()=>{a.give(""),n("close")},p=a.isOpenedByName(s.name,new x).ref();return l.value(new Re(d=>{d.isMobile?(o.ltr=o.ltr.replace("[50%]","[100%]"),o.rtl=o.rtl.replace("[50%]","[100%]")):(o.ltr=o.ltr.replace("[100%]","[50%]"),o.rtl=o.rtl.replace("[100%]","[50%]"))})),(d,h)=>(t.openBlock(),t.createBlock(t.Transition,{name:"fade"},{default:t.withCtx(()=>[t.unref(p)?(t.openBlock(),t.createElementBlock("div",{key:0,class:t.normalizeClass(r.value),onClick:c},[t.createElementVNode("div",{class:t.normalizeClass(["absolute bg-white h-full p-3 flex flex-col overflow-hidden",o[i.direction]]),onClick:h[0]||(h[0]=t.withModifiers(()=>{},["stop"]))},[d.$slots.header?(t.openBlock(),t.createElementBlock("div",Ko,[t.renderSlot(d.$slots,"header",{class:"BaseDrawer-Header"})])):t.createCommentVNode("",!0),t.createElementVNode("div",qo,[t.renderSlot(d.$slots,"default")]),d.$slots.footer?(t.openBlock(),t.createElementBlock("div",Jo,[t.renderSlot(d.$slots,"footer")])):t.createCommentVNode("",!0)],2)],2)):t.createCommentVNode("",!0)]),_:3}))}}),R=t.defineComponent({__name:"BaseIcon",props:{icon:{type:String}},setup(i){const e={"fa-bars":P.faBars,"fa-bars-staggered":P.faBarsStaggered,"fa-text-width":P.faTextWidth,"fa-search":P.faSearch,"fa-history":P.faHistory,"fa-plus-square":P.faPlusSquare,"fa-cog":P.faCog,"fa-file-text":P.faFileText,"fa-rotate-left":P.faRotateLeft,"fa-rotate-right":P.faRotateRight,"fa-map":P.faMap,"fa-close":P.faClose,"fa-arrow-left":P.faArrowLeft,"fa-arrow-right":P.faArrowRight,"fa-arrow-down":P.faArrowDown,"fa-arrow-up":P.faArrowUp,"fa-share-nodes":P.faShareNodes};return(s,n)=>(t.openBlock(),t.createBlock(t.unref(hs.FontAwesomeIcon),{icon:e[i.icon]},null,8,["icon"]))}}),Yo=t.createElementVNode("h2",{class:"text-lg font-bold"}," Карты в файле ",-1),Zo=["onClick"],Xo=t.defineComponent({__name:"AppFileMaps",setup(i){const{mapFile:e,mapCurrentID:s,drawer:n,mapRemoved:r}=j(),o=e.mapFile(new x).ref(),a=s.id(new x).ref(),l=c=>{confirm("Вы уверены?")&&r.give(c)};return(c,p)=>(t.openBlock(),t.createBlock(Ze,{direction:"rtl",name:"fileMaps"},{header:t.withCtx(()=>[Yo]),default:t.withCtx(()=>[t.createElementVNode("div",null,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(o),(d,h)=>(t.openBlock(),t.createElementBlock("div",{key:h,class:"flex items-center gap-2"},[t.createElementVNode("a",{href:"#",class:t.normalizeClass({"font-bold":t.unref(a)===h}),onClick:t.withModifiers(m=>{t.unref(s).give(h),t.unref(n).give("")},["prevent"])},t.toDisplayString(d.settings.title),11,Zo),t.createVNode(R,{onClick:m=>l(h),class:"text-danger-second cursor-pointer",title:"Удалить карту",icon:"fa-close"},null,8,["onClick"])]))),128))])]),_:1}))}}),ea={class:"AppMenuObject"},ta={key:0,class:"AppMenuObject-Empty"},sa={key:1,class:"flex flex-col gap-1"},na=["onClick"],ra=["innerHTML"],ia=t.defineComponent({__name:"AppMenuObject",setup(i){const{controlCombo:e,drawer:s,menu:n,stagePosition:r}=j(),{guest:o,patron:a}=H(),l=n.menuObjects(new x).ref();return e.happened("KeyM",a.create(o.create(()=>{s.give("menu")}))),(c,p)=>(t.openBlock(),t.createBlock(Ze,{direction:"rtl",name:"menu"},{default:t.withCtx(()=>[t.createElementVNode("div",ea,[t.unref(l).length?(t.openBlock(),t.createElementBlock("div",sa,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(l),d=>(t.openBlock(),t.createElementBlock("a",{key:d.id,class:"AppMenuObject-Item",href:"#",onClick:t.withModifiers(h=>{t.unref(r).give(d),t.unref(s).give("")},["prevent"])},[t.createElementVNode("span",{innerHTML:d.additionalName?d.additionalName:d.name},null,8,ra)],8,na))),128))])):(t.openBlock(),t.createElementBlock("div",ta,t.toDisplayString(c.$t("appMenuObject.noItems")),1))])]),_:1}))}}),S=t.defineComponent({__name:"BaseButton",props:{size:{type:String,default:"md",validator:i=>["sm","md","lg"].includes(i)},type:{type:String,default:"standard"}},setup(i){const e=i,s=["rounded-main",`text-${e.size}`,`p-${e.size}`,`bg-${e.type} hover:bg-${e.type}-second`];return s.push(""),(n,r)=>(t.openBlock(),t.createElementBlock("button",{type:"button",class:t.normalizeClass(s)},[t.renderSlot(n.$slots,"default")]))}}),oa={key:0,title:"Назад",class:"absolute text-white left-0 top-0 -ml-5 flex justify-center items-center bg-primary/70 hover:bg-primary-second/70 cursor-pointer w-5"},aa={key:1,class:"BaseModal-Header"},ca={class:"overflow-y-auto flex-grow"},la={key:2,class:"BaseModal-Footer"},oe=t.defineComponent({__name:"BaseModal",props:{name:{type:String,required:!0}},setup(i){const{modal:e}=j(),s=i,n=e.isOpenedByName(s.name,new x).ref(),r=[],o=()=>{e.give("")};return(a,l)=>(t.openBlock(),t.createBlock(t.Transition,{name:"fade"},{default:t.withCtx(()=>[t.unref(n)?(t.openBlock(),t.createElementBlock("div",{key:0,class:"absolute rounded-main overflow-y-auto flex justify-center items-center top-0 left-0 bg-black/10 z-20 h-full w-full",onClick:o},[t.createElementVNode("div",{class:"w-full relative flex flex-col max-w-[800px] max-h-[90%] bg-white p-3",onClick:l[0]||(l[0]=t.withModifiers(()=>{},["stop"]))},[r.length>1?(t.openBlock(),t.createElementBlock("div",oa," < ")):t.createCommentVNode("",!0),t.createElementVNode("div",{title:"Закрыть",class:"e2e-modal-close absolute text-white right-0 top-0 -mr-5 flex justify-center items-center bg-danger/70 hover:bg-danger-second/70 cursor-pointer w-5",onClick:o}," × "),a.$slots.header?(t.openBlock(),t.createElementBlock("div",aa,[t.renderSlot(a.$slots,"header")])):t.createCommentVNode("",!0),t.createElementVNode("div",ca,[t.renderSlot(a.$slots,"default")]),a.$slots.footer?(t.openBlock(),t.createElementBlock("div",la,[t.renderSlot(a.$slots,"footer")])):t.createCommentVNode("",!0)])])):t.createCommentVNode("",!0)]),_:3}))}}),da={class:"AppPresets"},ha=t.createElementVNode("div",{class:"text-md font-bold mb-2"},"Общие",-1),pa={class:"flex flex-col gap-2"},ma={class:"text-md font-bold mb-1"},ua={class:"flex gap-2 flex-wrap items-end"},fa={class:"AppTypesParent-ItemTitle"},ga=["innerHTML"],ya=t.defineComponent({__name:"AppPresets",setup(i){const{svgMapTypeImage:e}=H(),{mapType:s,settings:n}=j(),r=new x;n.value(r);const o=t.computed(()=>Object.fromEntries(Object.entries(r.value.presets).map(([a,l])=>[a,l.map(c=>({preset:c,image:e.create(c).markup()}))])));return(a,l)=>(t.openBlock(),t.createBlock(oe,{name:"presets"},{default:t.withCtx(()=>[t.createElementVNode("div",da,[ha,t.createElementVNode("div",pa,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(o.value,(c,p)=>(t.openBlock(),t.createElementBlock("div",{key:p},[t.createElementVNode("h3",ma,t.toDisplayString(p),1),t.createElementVNode("div",ua,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(c,d=>(t.openBlock(),t.createElementBlock("div",{key:d.preset.name,class:"flex flex-col gap-2"},[t.createElementVNode("div",fa,t.toDisplayString(d.preset.name),1),t.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:d.image,style:t.normalizeStyle(`width:${d.preset.width}px;height:${d.preset.height}px`)},null,12,ga),t.createVNode(S,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:h=>t.unref(s).give({name:d.preset.name,type:d.preset})},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])]))),128))])])]),_:1}))}}),G=t.defineComponent({__name:"BaseInput",props:{modelValue:{type:[String,Number],default:""},autofocus:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,r=t.ref(null);t.watch(r,ne(()=>{s.autofocus&&r.value.focus()},500));const o=L.useVModel(s,"modelValue",n);return(a,l)=>t.withDirectives((t.openBlock(),t.createElementBlock("input",{ref_key:"input",ref:r,"onUpdate:modelValue":l[0]||(l[0]=c=>t.isRef(o)?o.value=c:null),class:"block rounded-main w-full p-2 border border-solid border-body-dark",type:"text"},null,512)),[[t.vModelText,t.unref(o)]])}});class Xe{constructor(e){w(this,"pool",new we(this));this.refSource=e,t.watch(e,s=>{s!==void 0&&this.pool.give(s)},{deep:!0})}value(e){return this.refSource.value&&e.give(this.refSource.value),this.pool.add(e),this}}const wa={class:"AppSearch"},Aa={key:0,class:"AppSearch-Items"},ba=["onClick"],Ca=["innerHTML"],xa=["innerHTML"],ka=["innerHTML"],_a={key:1},Ba={key:2},Na=t.defineComponent({__name:"AppSearch",setup(i){const{objectsMatchedToQuery:e,controlCombo:s,modal:n,stagePosition:r}=j(),{guest:o,patron:a}=H(),l=t.ref(),c=B.debug("app:AppSearch");n.isOpenedByName("search",a.create(o.create(h=>{setTimeout(()=>{h&&l.value&&(c("search is opened",h),l.value.$el.focus())},500)})));const p=t.ref(""),d=e.objects(new Xe(p),new x([])).ref();return s.happened("KeyF",a.create(o.create(()=>{n.give("search")}))),(h,m)=>(t.openBlock(),t.createBlock(oe,{name:"search"},{default:t.withCtx(()=>[t.createElementVNode("div",wa,[t.createVNode(G,{ref_key:"inputRef",ref:l,modelValue:p.value,"onUpdate:modelValue":m[0]||(m[0]=f=>p.value=f),class:"mb-2 e2e-query-input",placeholder:h.$t("general.specifyQuery")},null,8,["modelValue","placeholder"]),t.unref(d).length?(t.openBlock(),t.createElementBlock("div",Aa,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(d),f=>(t.openBlock(),t.createElementBlock("div",{key:f.name,class:"cursor-pointer",onClick:t.withModifiers(u=>{t.unref(r).give(f),t.unref(n).give("")},["prevent"])},[t.createElementVNode("b",{class:"AppSearch-ItemName",innerHTML:f.name},null,8,Ca),f.additionalName?(t.openBlock(),t.createElementBlock("b",{key:0,class:"AppSearch-ItemName",innerHTML:f.additionalName},null,8,xa)):t.createCommentVNode("",!0),f.additionalFields?(t.openBlock(),t.createElementBlock("div",{key:1,innerHTML:Object.values(f.additionalFields).join(" ")},null,8,ka)):t.createCommentVNode("",!0)],8,ba))),128))])):p.value?(t.openBlock(),t.createElementBlock("div",_a,t.toDisplayString(h.$t("general.noResults")),1)):(t.openBlock(),t.createElementBlock("div",Ba,t.toDisplayString(h.$t("general.resultsWillBeHere")),1))])]),_:1}))}}),Va={class:"AppTypes"},$a=t.createElementVNode("div",{class:"text-md font-bold mb-2"},"Родительские типы",-1),Sa={class:"flex gap-2 items-end"},Fa={class:"AppTypesParent-ItemTitle"},Ea=["innerHTML"],Ta=t.defineComponent({__name:"AppTypesParent",setup(i){const{parentTypes:e,mapType:s}=j(),{svgMapTypeImage:n}=H(),r=e.types(new x).ref(),o=t.computed(()=>{var a;return(a=r.value)==null?void 0:a.map(l=>({type:l,image:n.create(l).markup()})).sort((l,c)=>+(l.type.name>=c.type.name))});return(a,l)=>(t.openBlock(),t.createBlock(oe,{name:"parentTypes"},{default:t.withCtx(()=>[t.createElementVNode("div",Va,[$a,t.createElementVNode("div",Sa,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(o.value,c=>(t.openBlock(),t.createElementBlock("div",{key:c.type.name,class:"flex flex-col gap-2"},[t.createElementVNode("div",Fa,t.toDisplayString(c.type.name),1),t.createElementVNode("div",{class:"AppTypesParent-ItemImage",innerHTML:c.image,style:t.normalizeStyle(`width:${c.type.width}px;height:${c.type.height}px`)},null,12,Ea),t.createVNode(S,{class:"AppTypesParent-ItemButton e2e-add-preset-type",type:"success",size:"sm",onClick:p=>t.unref(s).give({name:c.type.name,type:c.type})},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(a.$t("general.addToMap")),1)]),_:2},1032,["onClick"])]))),128))])])]),_:1}))}});class qt{constructor(e,s=void 0){w(this,"innerRef");this.executor=e,this.innerRef=t.ref(s)}ref(){return this.executor(this.innerRef),this.innerRef}}const Ma={class:"flex gap-2"},et=t.defineComponent({__name:"BaseCheckbox",props:{modelValue:{type:Boolean},label:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,r=L.useVModel(s,"modelValue",n);return(o,a)=>(t.openBlock(),t.createElementBlock("label",Ma,[t.withDirectives(t.createElementVNode("input",{"onUpdate:modelValue":a[0]||(a[0]=l=>t.isRef(r)?r.value=l:null),type:"checkbox"},null,512),[[t.vModelCheckbox,t.unref(r)]]),o.$slots.default?t.renderSlot(o.$slots,"default",{key:0}):(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createTextVNode(t.toDisplayString(i.label),1)],64))]))}}),Ee=(i,e)=>{const s=i.__vccOpts||i;for(const[n,r]of e)s[n]=r;return s},Ia={},ja={class:"text-sm font-bold"};function Da(i,e){return t.openBlock(),t.createElementBlock("div",ja,[t.renderSlot(i.$slots,"default")])}const z=Ee(Ia,[["render",Da]]),Oa={},Pa={class:"mb-2"};function Ra(i,e){return t.openBlock(),t.createElementBlock("div",Pa,[t.renderSlot(i.$slots,"default")])}const v=Ee(Oa,[["render",Ra]]),Ha={class:"rounded-main p-2 border border-solid border-body-dark"},za={class:"flex gap-2 p-2 bg-white border border-solid border-body-dark rounded-main"},Te=t.defineComponent({__name:"BaseEditor",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,r=Ie.useEditor({content:s.modelValue,extensions:[ps],onUpdate:()=>{r.value&&n("update:modelValue",r.value.getHTML())}});return t.onBeforeUnmount(()=>{var o;(o=r.value)==null||o.destroy()}),t.watch(()=>s.modelValue,o=>{!r.value||r.value.getHTML()===o||r.value.commands.setContent(o,!1)}),(o,a)=>(t.openBlock(),t.createElementBlock("div",Ha,[t.createVNode(t.unref(Ie.EditorContent),{editor:t.unref(r)},null,8,["editor"]),t.unref(r)?(t.openBlock(),t.createBlock(t.unref(Ie.BubbleMenu),{key:0,editor:t.unref(r),"tippy-options":{duration:100}},{default:t.withCtx(()=>[t.createElementVNode("div",za,[t.createElementVNode("button",{onClick:a[0]||(a[0]=l=>t.unref(r).chain().focus().toggleBold().run()),class:t.normalizeClass({"font-bold":t.unref(r).isActive("bold")})}," bold ",2),t.createElementVNode("button",{onClick:a[1]||(a[1]=l=>t.unref(r).chain().focus().toggleItalic().run()),class:t.normalizeClass({"font-bold":t.unref(r).isActive("italic")})}," italic ",2),t.createElementVNode("button",{onClick:a[2]||(a[2]=l=>t.unref(r).chain().focus().toggleStrike().run()),class:t.normalizeClass({"font-bold":t.unref(r).isActive("strike")})}," strike ",2)])]),_:1},8,["editor"])):t.createCommentVNode("",!0)]))}}),La=["value"],Ua=t.defineComponent({__name:"BaseSelect",props:{modelValue:{type:[String,Number],default:""},items:{type:Array,required:!0},optionId:{type:String,required:!0},optionLabel:{type:String,required:!0}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,r=L.useVModel(s,"modelValue",n);return(o,a)=>t.withDirectives((t.openBlock(),t.createElementBlock("select",{label:"select","onUpdate:modelValue":a[0]||(a[0]=l=>t.isRef(r)?r.value=l:null),class:"block bg-white rounded-main w-full p-2 border border-solid border-body-dark"},[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(s.items,l=>(t.openBlock(),t.createElementBlock("option",{key:l[s.optionId],value:l[s.optionId]},t.toDisplayString(l[s.optionLabel]),9,La))),128))],512)),[[t.vModelSelect,t.unref(r)]])}}),Qa={class:"text-lg font-bold"},va={key:0,class:"flex gap-2 items-center"},Wa={key:1,class:"flex gap-2 mt-2"},Ga={key:0},Ka={key:1},qa={key:0,class:"flex flex-col gap-2"},Ja={class:"FormObject-Inner"},Ya={class:"FormObject-Row"},Za={class:"FormObject-Row"},Xa={class:"FormObject-Row"},ec={class:"my-2"},tc={class:"FormObject-Title"},sc={class:"FormObject-Row"},nc={class:"FormObject-Title"},rc={class:"FormObject-Row"},ic={key:0,class:"FormObject-ArrowName"},oc={class:"py-3 flex gap-1"},ac=t.defineComponent({__name:"FormObject",setup(i){const e=Pe("FormObject"),{mapObjectCurrent:s,mapFile:n,mapObject:r,mapCurrent:o,drawer:a,mapObjectRemoved:l,mapObjectRelationRemoved:c,mapObjectUrl:p,controlCombo:d}=j(),{patron:h,chain:m,guest:f}=H(),u=new qt(()=>{const N=m.create();s.objectId(h.create(N.receiveKey("objectId"))),n.currentMap(h.create(N.receiveKey("map"))),N.result(h.create(f.create(({map:_,objectId:k})=>{e("object opened",k),u.value=_.objects[k]})))}).ref(),A=o.types(new x).ref(),g=n.currentMap(new x).ref(),b=new Xe(u),C=p.url(b,new x).ref(),D=()=>{s.give(""),a.give("")},V=()=>{l.give(u.value),D()},K=()=>{r.give({...u.value,outlink:u.value.outlink||C.value}),D()},F=N=>{c.give({index:N,object:u.value})};return d.happenedConditional("KeyS",a.openedByName("object"),h.create(f.create(K))),(N,_)=>(t.openBlock(),t.createBlock(Ze,{name:"object",onClose:D},{header:t.withCtx(()=>[t.createElementVNode("h2",Qa,t.toDisplayString(N.$t("general.mapObject")),1),t.unref(u)?(t.openBlock(),t.createElementBlock("small",va,[t.createElementVNode("span",null," ID #"+t.toDisplayString(t.unref(u).id),1)])):t.createCommentVNode("",!0),t.unref(u)?(t.openBlock(),t.createElementBlock("div",Wa,[t.unref(u).createTimestamp?(t.openBlock(),t.createElementBlock("div",Ga," Создан: "+t.toDisplayString(new Date(t.unref(u).createTimestamp).toLocaleString()),1)):t.createCommentVNode("",!0),t.unref(u).changeTimestamp?(t.openBlock(),t.createElementBlock("div",Ka," Изменен: "+t.toDisplayString(new Date(t.unref(u).changeTimestamp).toLocaleString()),1)):t.createCommentVNode("",!0)])):t.createCommentVNode("",!0)]),footer:t.withCtx(()=>[t.createElementVNode("div",oc,[t.createVNode(S,{type:"success",onClick:K},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.save")),1)]),_:1}),t.createVNode(S,{type:"danger",onClick:V},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.delete")),1)]),_:1}),t.createVNode(S,{onClick:D},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.cancel")),1)]),_:1})])]),default:t.withCtx(()=>[t.unref(u)?(t.openBlock(),t.createElementBlock("div",qa,[t.createElementVNode("div",Ja,[t.createElementVNode("div",Ya,[t.createVNode(et,{modelValue:t.unref(u).linked,"onUpdate:modelValue":_[0]||(_[0]=k=>t.unref(u).linked=k),label:N.$t("general.nameAsLink")},null,8,["modelValue","label"])]),t.unref(u).linked?(t.openBlock(),t.createElementBlock(t.Fragment,{key:0},[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.outerLink")),1)]),_:1}),t.createElementVNode("div",Za,[t.createVNode(G,{"model-value":t.unref(u).outlink||t.unref(C),"onUpdate:modelValue":_[1]||(_[1]=k=>t.unref(u).outlink=k)},null,8,["model-value"])]),t.createElementVNode("div",Xa,[t.createVNode(et,{modelValue:t.unref(u).targetBlank,"onUpdate:modelValue":_[2]||(_[2]=k=>t.unref(u).targetBlank=k),label:N.$t("general.inNewTab")},null,8,["modelValue","label"])])],64)):t.createCommentVNode("",!0),(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(u).additionalFields,(k,W)=>(t.openBlock(),t.createBlock(v,{class:"mb-2",key:W},{default:t.withCtx(()=>[t.createVNode(z,{class:"mb-1"},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(W),1)]),_:2},1024),t.createVNode(Te,{modelValue:t.unref(u).additionalFields[W],"onUpdate:modelValue":Y=>t.unref(u).additionalFields[W]=Y},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128)),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.topName")),1)]),_:1}),t.createVNode(Te,{modelValue:t.unref(u).additionalName,"onUpdate:modelValue":_[3]||(_[3]=k=>t.unref(u).additionalName=k)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.bottomName")),1)]),_:1}),t.createVNode(Te,{modelValue:t.unref(u).name,"onUpdate:modelValue":_[4]||(_[4]=k=>t.unref(u).name=k)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.description")),1)]),_:1}),t.createVNode(Te,{modelValue:t.unref(u).description,"onUpdate:modelValue":_[5]||(_[5]=k=>t.unref(u).description=k)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Z-Index ")]),_:1}),t.createVNode(G,{modelValue:t.unref(u).zindex,"onUpdate:modelValue":_[6]||(_[6]=k=>t.unref(u).zindex=k),type:"number"},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Width ")]),_:1}),t.createVNode(G,{modelValue:t.unref(u).width,"onUpdate:modelValue":_[7]||(_[7]=k=>t.unref(u).width=k),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Height ")]),_:1}),t.createVNode(G,{modelValue:t.unref(u).height,"onUpdate:modelValue":_[8]||(_[8]=k=>t.unref(u).height=k),step:"20",type:"number"},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.objectType")),1)]),_:1}),t.createVNode(Ua,{modelValue:t.unref(u).type,"onUpdate:modelValue":_[9]||(_[9]=k=>t.unref(u).type=k),items:t.unref(A),"option-id":"id","option-label":"name"},null,8,["modelValue","items"])]),_:1}),t.createElementVNode("div",ec,[t.createVNode(et,{modelValue:t.unref(u).inMenu,"onUpdate:modelValue":_[10]||(_[10]=k=>t.unref(u).inMenu=k),label:N.$t("general.useInMenu")},null,8,["modelValue","label"])]),t.unref(u).inMenu?(t.openBlock(),t.createElementBlock(t.Fragment,{key:1},[t.createElementVNode("div",tc,t.toDisplayString(N.$t("general.menuOrder")),1),t.createElementVNode("div",sc,[t.createVNode(G,{modelValue:t.unref(u).menuOrder,"onUpdate:modelValue":_[11]||(_[11]=k=>t.unref(u).menuOrder=k),type:"number"},null,8,["modelValue"])])],64)):t.createCommentVNode("",!0),t.unref(u).arrows&&t.unref(u).arrows.length?(t.openBlock(),t.createElementBlock(t.Fragment,{key:2},[t.createElementVNode("div",nc,t.toDisplayString(N.$t("general.relations")),1),t.createElementVNode("div",rc,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(u).arrows,(k,W)=>{var Y;return t.openBlock(),t.createElementBlock("div",{key:k.id,class:"FormObject-Arrow"},[(Y=t.unref(g))!=null&&Y.objects[k.id]?(t.openBlock(),t.createElementBlock("span",ic," #"+t.toDisplayString(W+1)+" "+t.toDisplayString(t.unref(g).objects[k.id].name),1)):t.createCommentVNode("",!0),t.createVNode(S,{class:"FormObject-ArrowButton",type:"danger",size:"sm",onClick:le=>F(W)},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(N.$t("general.delete")),1)]),_:2},1032,["onClick"])])}),128))])],64)):t.createCommentVNode("",!0)])])):t.createCommentVNode("",!0)]),_:1}))}}),cc={class:"BaseTextarea"},lc=["v-bind"],Jt=t.defineComponent({inheritAttrs:!1,__name:"BaseTextarea",props:{modelValue:{type:String,default:""}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,r=L.useVModel(s,"modelValue",n);return(o,a)=>(t.openBlock(),t.createElementBlock("div",cc,[t.withDirectives(t.createElementVNode("textarea",{ref:"textarea","v-bind":o.$attrs,"onUpdate:modelValue":a[0]||(a[0]=l=>t.isRef(r)?r.value=l:null),class:"rounded-main block w-full p-2 border min-h-[200px] border-solid border-body-dark"},null,8,lc),[[t.vModelText,t.unref(r)]])]))}}),dc={class:"text-lg font-bold"},hc={key:0,class:"flex flex-col"},pc={class:"flex justify-end pt-4 gap-2"},mc=t.defineComponent({__name:"FormType",setup(i){const{mapTypeCurrent:e,mapFile:s,mapType:n,modal:r,controlCombo:o}=j(),{patron:a,chain:l,guest:c}=H();e.typeId(a.create(c.create(u=>{u&&r.give("type")})));const p=t.ref(""),d=l.create(),h=new qt(()=>{e.typeId(a.create(d.receiveKey("typeId"))),s.currentMap(a.create(d.receiveKey("map"))),d.result(a.create(c.create(({map:u,typeId:A})=>{var g;h.value=u.types[A],p.value=(g=h.value)==null?void 0:g.name})))}).ref(),m=()=>{e.give(""),r.give(""),d.receiveKey("typeId").give("")},f=()=>{n.give({name:p.value,type:h.value}),m()};return o.happenedConditional("KeyS",r.openedByName("type"),a.create(c.create(f))),(u,A)=>(t.openBlock(),t.createBlock(oe,{name:"type"},{header:t.withCtx(()=>[t.createElementVNode("h2",dc,t.toDisplayString(u.$t("general.mapType")),1)]),footer:t.withCtx(()=>[t.createElementVNode("div",pc,[t.createVNode(S,{type:"success",onClick:f},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(u.$t("general.save")),1)]),_:1}),t.createVNode(S,{onClick:m},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(u.$t("general.cancel")),1)]),_:1})])]),default:t.withCtx(()=>[t.unref(h)?(t.openBlock(),t.createElementBlock("div",hc,[t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Название типа ")]),_:1}),t.createVNode(G,{modelValue:t.unref(h).name,"onUpdate:modelValue":A[0]||(A[0]=g=>t.unref(h).name=g)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" SVG ")]),_:1}),t.createVNode(Jt,{modelValue:t.unref(h).svg,"onUpdate:modelValue":A[1]||(A[1]=g=>t.unref(h).svg=g)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Ширина ")]),_:1}),t.createVNode(G,{modelValue:t.unref(h).width,"onUpdate:modelValue":A[2]||(A[2]=g=>t.unref(h).width=g)},null,8,["modelValue"])]),_:1}),t.createVNode(v,null,{default:t.withCtx(()=>[t.createVNode(z,null,{default:t.withCtx(()=>[t.createTextVNode(" Высота ")]),_:1}),t.createVNode(G,{modelValue:t.unref(h).height,"onUpdate:modelValue":A[3]||(A[3]=g=>t.unref(h).height=g)},null,8,["modelValue"])]),_:1})])):t.createCommentVNode("",!0)]),_:1}))}}),tt=B.debug("MapObjectsWithTemplates");class uc{constructor(e,s,n){this.mapObjects=e,this.map=s,this.factories=n}objects(e){const s=this.factories.chain.create();return this.map.types(this.factories.guestCast.create(e,s.receiveKey("types"))),this.mapObjects.objects(this.factories.guestCast.create(e,s.receiveKey("objects"))),s.result(this.factories.guestInTheMiddle.create(e,({types:n,objects:r})=>{tt("visible objects",r);const o=r.map(a=>{const l=n.find(p=>String(p.id)===String(a.type));if(tt("check type existed",l),!l)return{obj:a,template:""};let{svg:c}=l;return tt("type svg",c),a.additionalFields&&Object.entries(a.additionalFields).forEach(([p,d])=>{c=c.replaceAll(`\${${p}}`,d)}),["width","height"].forEach(p=>{c=c.replaceAll(`\${${p}}`,a[p])}),{obj:a,template:c}});e.give(o)})),e}}const fc=t.defineComponent({__name:"BaseNotify",setup(i){const{notification:e}=j(),s=e.message(new x).ref();return(n,r)=>t.unref(s)&&t.unref(s).text!=="hide"?(t.openBlock(),t.createElementBlock("div",{key:0,class:t.normalizeClass(["inline font-bold",`text-${t.unref(s).type}-second`])},t.toDisplayString(t.unref(s).text),3)):t.createCommentVNode("",!0)}}),gc={class:"relative"},yc={class:"absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-1"},wc={class:"text-sm z-10 p-2 absolute bottom-0 left-5"},Ac=t.createStaticVNode('<div class="absolute bottom-3 shadow-standard-second shadow-md drop-shadow right-3 z-10"><div class="grid-example grid grid-rows-2 grid-cols-2 bg-standard-second border border-standard-second gap-[1px] border-t-0 border-l-0"><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div><div class="w-[14px] h-[14px] bg-white"></div></div></div><div class="absolute z-30 top-0 left-0 h-[18px] w-[22px] bg-white"></div>',2),bc=["title"],Cc={class:"font-bold"},xc=["title"],kc={class:"font-bold"},_c=["title"],Bc={class:"font-bold"},Nc=["title"],Vc={class:"font-bold"},$c=["data-object-id"],Sc={class:"absolute bottom-[100%] left-[50%] translate-x-[-50%] text-center pb-2 pointer-events-auto text-sm w-[300px]"},Fc=["innerHTML","onClick"],Ec=["innerHTML"],Tc=["data-object-id","innerHTML"],Mc=t.defineComponent({__name:"TheEditor",setup(i){const{canvas:e,mapObjectsVisible:s,mapCurrent:n,konvaLayer:r,fps:o,mapCurrentID:a,mapObjectUrl:l,stageSize:c,objectsOutsideScreen:p,stagePositionByObjectId:d,mapCurrentSource:h}=j(),m=H(),f=o.value(new x).ref(),A=new uc(s,n,m).objects(new x([])).ref(),g=c.value(new x).ref(),b=r.position(new x).ref(),C=t.computed(()=>{var le;return(le=g.value)==null?void 0:le.width}),D=new Xe(C),V=m.numberChunks.create(10,D).chunks(new x).ref(),K=t.ref();t.onMounted(()=>{e.give(K.value)});const F=le=>{l.open(le,m.guest.create(q=>{a.give(q)}))},N=p.count({axis:"x",direction:"negative"},new x).ref(),_=p.count({axis:"x",direction:"positive"},new x).ref(),k=p.count({axis:"y",direction:"negative"},new x).ref(),W=p.count({axis:"y",direction:"positive"},new x).ref(),Y=d.move.bind(d,h);return(le,q)=>{var Xt,es,ts,ss,ns,rs,is,os,as,cs,ls,ds;return t.openBlock(),t.createElementBlock("div",gc,[t.createElementVNode("div",yc,[t.createElementVNode("div",wc,[t.createTextVNode(" Видимых объектов: "+t.toDisplayString(t.unref(A).length)+", FPS: "+t.toDisplayString(t.unref(f))+", ",1),t.createVNode(fc)]),Ac,((Xt=t.unref(N))==null?void 0:Xt.count)>0?(t.openBlock(),t.createElementBlock("div",{key:0,class:"pointer-events-auto absolute z-30 top-0 left-4 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(es=t.unref(N))==null?void 0:es.count} шт. объектов левее`,onClick:q[0]||(q[0]=M=>t.unref(Y)(t.unref(N).nearestObjectId))},[t.createVNode(R,{icon:"fa-arrow-left"}),t.createElementVNode("span",Cc,t.toDisplayString((ts=t.unref(N))==null?void 0:ts.count),1)],8,bc)):t.createCommentVNode("",!0),((ss=t.unref(_))==null?void 0:ss.count)>0?(t.openBlock(),t.createElementBlock("div",{key:1,class:"pointer-events-auto absolute z-30 p-1 top-0 right-0 h-[18px] bg-white flex items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ns=t.unref(_))==null?void 0:ns.count} шт. объектов правее`,onClick:q[1]||(q[1]=M=>t.unref(Y)(t.unref(_).nearestObjectId))},[t.createElementVNode("span",kc,t.toDisplayString((rs=t.unref(_))==null?void 0:rs.count),1),t.createVNode(R,{icon:"fa-arrow-right"})],8,xc)):t.createCommentVNode("",!0),((is=t.unref(k))==null?void 0:is.count)>0?(t.openBlock(),t.createElementBlock("div",{key:2,class:"pointer-events-auto absolute z-30 top-[18px] left-0 w-[18px] bg-white flex flex-col leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(os=t.unref(k))==null?void 0:os.count} шт. объектов выше`,onClick:q[2]||(q[2]=M=>t.unref(Y)(t.unref(k).nearestObjectId))},[t.createVNode(R,{icon:"fa-arrow-up"}),t.createElementVNode("span",Bc,t.toDisplayString((as=t.unref(k))==null?void 0:as.count),1)],8,_c)):t.createCommentVNode("",!0),((cs=t.unref(W))==null?void 0:cs.count)>0?(t.openBlock(),t.createElementBlock("div",{key:3,class:"pointer-events-auto absolute z-30 p-1 bottom-0 left-0 w-[18px] bg-white flex flex-col-reverse leading-4 items-center gap-1 text-body-dark text-sm cursor-pointer",title:`${(ls=t.unref(W))==null?void 0:ls.count} шт. объектов ниже`,onClick:q[3]||(q[3]=M=>t.unref(Y)(t.unref(W).nearestObjectId))},[t.createVNode(R,{icon:"fa-arrow-down"}),t.createElementVNode("span",Vc,t.toDisplayString((ds=t.unref(W))==null?void 0:ds.count),1)],8,Nc)):t.createCommentVNode("",!0),t.createElementVNode("div",{class:t.normalizeClass({"objects-container absolute top-0 left-0":!0}),style:t.normalizeStyle({width:`${t.unref(g).width}px`,height:`${t.unref(g).height}px`,transform:`translate(${t.unref(b).x}px, ${t.unref(b).y}px)`})},[t.createElementVNode("div",{class:"absolute flex top-0 left-0 w-full z-20 h-[20px] bg-default border-b-2 border-border text-right text-sm px-2",style:t.normalizeStyle({transform:`translate(0, ${-t.unref(b).y}px)`})},[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(V),M=>(t.openBlock(),t.createElementBlock("span",{class:"flex-1 text-body-dark",key:`horiz_${M}`},t.toDisplayString(M)+"px",1))),128))],4),t.createElementVNode("div",{class:"absolute flex [writing-mode:vertical-lr] top-0 left-0 h-full z-20 w-[20px] bg-default border-r-2 border-border text-left text-sm py-2",style:t.normalizeStyle({transform:`translate(${-t.unref(b).x}px, 0)`})},[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(V),M=>(t.openBlock(),t.createElementBlock("span",{class:"flex-1 rotate-180 text-body-dark",key:`vert_${M}`},t.toDisplayString(M)+"px",1))),128))],4),(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(A),M=>(t.openBlock(),t.createElementBlock("div",{key:M.obj.id,class:"absolute z-10","data-object-id":M.obj.id,style:t.normalizeStyle(`width:${M.obj.width}px;height: ${M.obj.height}px;top: ${M.obj.position[1]}px;left:${M.obj.position[0]}px;z-index:${M.obj.zindex}`)},[t.createElementVNode("div",Sc,[t.createElementVNode("span",{innerHTML:M.obj.additionalName,class:t.normalizeClass([M.obj.linked&&"cursor-pointer underline"]),onClick:Rl=>F(M.obj)},null,10,Fc)]),t.createElementVNode("div",{class:"absolute top-[100%] left-[50%] translate-x-[-50%] text-center pt-2 text-sm w-[300px]",innerHTML:M.obj.name},null,8,Ec),t.createElementVNode("div",{"data-object-id":M.obj.id,class:"rendered-object",innerHTML:M.template},null,8,Tc)],12,$c))),128))],4)]),t.createElementVNode("div",{class:"h-full",ref_key:"canvasWrapper",ref:K},null,512)])}}}),Ic={class:"flex flex-wrap gap-2"},jc={key:0},Dc={key:1},Oc=["onClick"],Pc=t.defineComponent({__name:"BaseBreadcrumbs",setup(i){const{breadcrumbs:e,mapCurrentID:s}=j(),n=e.list(new x).ref();return(r,o)=>(t.openBlock(),t.createElementBlock("div",Ic,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(n),(a,l)=>(t.openBlock(),t.createElementBlock("span",{class:"flex gap-2",key:a.name},[l!==0?(t.openBlock(),t.createElementBlock("span",jc,"/")):t.createCommentVNode("",!0),l===t.unref(n).length-1?(t.openBlock(),t.createElementBlock("b",Dc,"Открыто: "+t.toDisplayString(a.title),1)):(t.openBlock(),t.createElementBlock("a",{key:2,href:"#",onClick:t.withModifiers(c=>t.unref(s).give(a.name),["prevent"])},t.toDisplayString(a.title),9,Oc))]))),128))]))}}),Rc={class:"flex items-center p-3 gap-3"},Hc={class:"ml-auto gap-1 flex"},zc=t.defineComponent({__name:"TheHeader",setup(i){const{drawer:e,modal:s,mapHistory:n,controlCombo:r,settings:o}=j(),{patron:a,guest:l}=H(),c=n.isNextPossible(new x).ref(),p=n.isPrevPossible(new x).ref();r.happened("KeyZ",a.create(l.create(()=>{p.value&&n.prev()}))),r.happened("KeyP",a.create(l.create(()=>{c.value&&n.next()})));const d=new x;return o.value(d),(h,m)=>(t.openBlock(),t.createElementBlock("div",Rc,[t.createVNode(Pc,{class:"TheHeader-Breadcrumbs"}),t.createElementVNode("div",Hc,[t.unref(c)&&!t.unref(d).value.readonly?(t.openBlock(),t.createBlock(S,{key:0,size:"sm",title:"Отменить последнее действие",class:"w-7 block",onClick:m[0]||(m[0]=f=>t.unref(n).next())},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-rotate-left"})]),_:1})):t.createCommentVNode("",!0),t.unref(p)&&!t.unref(d).value.readonly?(t.openBlock(),t.createBlock(S,{key:1,size:"sm",title:"Вернуть отмененное действие",class:"w-7 block",onClick:m[1]||(m[1]=f=>t.unref(n).prev())},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-rotate-right"})]),_:1})):t.createCommentVNode("",!0),t.createVNode(S,{type:"success",size:"sm",class:"w-7 block e2e-open-menu",title:h.$t("general.menu"),onClick:m[2]||(m[2]=f=>t.unref(e).give("menu"))},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-bars"})]),_:1},8,["title"]),t.createVNode(S,{title:h.$t("general.byText"),type:"primary",size:"sm",class:"w-7 block",onClick:m[3]||(m[3]=f=>t.unref(s).give("mapAsText"))},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-text-width"})]),_:1},8,["title"]),t.createVNode(S,{class:"w-7 block e2e-search",size:"sm",onClick:m[4]||(m[4]=f=>t.unref(s).give("search"))},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-search"})]),_:1}),t.createVNode(S,{size:"sm",title:"Все карты файла",class:"w-7 block",onClick:m[5]||(m[5]=f=>t.unref(e).give("fileMaps"))},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-map"})]),_:1})])]))}}),Lc={},Uc={class:"text-lg font-bold"};function Qc(i,e){return t.openBlock(),t.createElementBlock("span",Uc,[t.renderSlot(i.$slots,"default")])}const vc=Ee(Lc,[["render",Qc]]),Wc={class:"flex gap-1"},Gc={key:0,class:"TheMapAsText select-auto"},Kc=["innerHTML"],qc=t.defineComponent({__name:"TheMapAsText",setup(i){const{mapFile:e,mapCurrent:s}=j(),{guest:n,patron:r,textOf:o,textNlAsBr:a,textWithoutHTML:l}=H(),c=e.currentMap(new x).ref(),p=t.ref(""),d=t.ref([]);s.objects(r.create(n.create(ne(g=>{d.value=g,a.create(o.create(g.map(b=>`<div class="TheMapAsText-Item">
                <h3>${b.name}</h3><p>${b.additionalName||""}</p><p>${b.description||""}</p><p>${b.additionalFields&&Object.values(b.additionalFields).join("</p><p>")}</p></div>`).join(""))).asString(n.create(b=>{p.value=b}))},500))));const{share:h,isSupported:m}=L.useShare(),f=()=>{m.value||alert("Sharing is not supported"),l.create(o.create(p.value)).asString(n.create(g=>{h({text:g})}))},u=t.ref(),A=()=>{var g,b;if(c.value){const C=new Range;C.setStart(u.value,0),C.setEnd(u.value,Object.values(d.value).length),(g=document.getSelection())==null||g.removeAllRanges(),(b=document.getSelection())==null||b.addRange(C)}};return(g,b)=>(t.openBlock(),t.createBlock(oe,{name:"mapAsText"},{header:t.withCtx(()=>[t.createVNode(vc,{class:"block mb-3"},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(g.$t("general.mapAsText"))+" ",1),t.createElementVNode("div",Wc,[t.createVNode(S,{size:"sm",type:"success",class:"font-normal",onClick:f},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(g.$t("general.share")),1)]),_:1}),t.createVNode(S,{size:"sm",type:"primary",class:"font-normal",onClick:A},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(g.$t("general.selectAll")),1)]),_:1})])]),_:1})]),default:t.withCtx(()=>[t.unref(c)?(t.openBlock(),t.createElementBlock("article",Gc,[t.createElementVNode("div",{ref_key:"textRef",ref:u,innerHTML:p.value},null,8,Kc)])):t.createCommentVNode("",!0)]),_:1}))}}),Jc={key:1},Yc=t.defineComponent({__name:"TheMiniMap",setup(i){const{miniMap:e}=j(),s=e.points(new x).ref(),n=e.size(new x).ref(),r=e.viewportSize(new x).ref(),o=e.viewportPosition(new x).ref();return(a,l)=>t.unref(n)?(t.openBlock(),t.createElementBlock("div",{key:0,style:t.normalizeStyle({width:`${t.unref(n).width}px`,height:`${t.unref(n).height}px`}),class:"absolute pointer-events-none block bg-white bottom-[10px] mt-3 right-3 z-1 border border-solid border-body-dark"},[t.unref(o)?(t.openBlock(),t.createElementBlock("div",{key:0,style:t.normalizeStyle({width:`${t.unref(r).width}px`,height:`${t.unref(r).height}px`,top:`${t.unref(o).y}px`,left:`${t.unref(o).x}px`}),class:"absolute bg-primary/50"},null,4)):t.createCommentVNode("",!0),t.unref(s)?(t.openBlock(),t.createElementBlock("div",Jc,[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(t.unref(s),c=>(t.openBlock(),t.createElementBlock("div",{key:c.id,class:"absolute w-1 h-1 block bg-danger",style:t.normalizeStyle({top:`${c.y}px`,left:`${c.x}px`,width:`${c.width}px`,height:`${c.height}px`})},null,4))),128))])):t.createCommentVNode("",!0)],4)):t.createCommentVNode("",!0)}}),Zc={class:"text-lg font-bold"},Xc={key:0,class:"TheSettings"},el={class:"mb-2"},tl={class:"TheSettings-Row"},sl={class:"flex gap-2 mb-2"},nl={class:"mb-2"},rl={class:"mb-2"},il={href:"https://github.com/kosukhin/mind-map-creator",target:"_blank"},ol={class:"flex gap-2"},al=t.defineComponent({__name:"FormSettings",setup(i){const{modal:e,mapFile:s,mapRemoved:n,mapSettings:r,controlCombo:o,parentNames:a,mapCurrentID:l}=j(),{patron:c,guest:p}=H(),d=a.names(new x).ref(),h=s.currentMap(new x).ref(),m=l.id(new x).ref(),f=()=>{e.give("")},u=()=>{r.give(h.value.settings),f()};o.happenedConditional("KeyS",e.openedByName("settings"),c.create(p.create(u)));const{sharedStorageRecord:A}=He(),g=new x;return A.value(g),(b,C)=>(t.openBlock(),t.createBlock(oe,{name:"settings"},{header:t.withCtx(()=>[t.createElementVNode("h2",Zc,t.toDisplayString(b.$t("general.mapSettings")),1)]),default:t.withCtx(()=>{var D;return[(D=t.unref(h))!=null&&D.settings?(t.openBlock(),t.createElementBlock("div",Xc,[t.createElementVNode("div",el,[t.createElementVNode("div",tl,[t.createElementVNode("div",sl,[t.unref(g).value?(t.openBlock(),t.createBlock(S,{key:0,type:"primary",class:"text-white",onClick:C[0]||(C[0]=V=>t.unref(A).give(null))},{default:t.withCtx(()=>[t.createTextVNode(" Очистить Sharing ")]),_:1})):t.createCommentVNode("",!0),t.unref(d).length>1?(t.openBlock(),t.createBlock(S,{key:1,type:"primary",class:"text-white",onClick:C[1]||(C[1]=V=>t.unref(e).give("parentTypes"))},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(b.$t("general.parentTypes")),1)]),_:1})):t.createCommentVNode("",!0),t.createVNode(S,{type:"primary",class:"text-white",onClick:C[2]||(C[2]=V=>t.unref(e).give("export"))},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(b.$t("general.exportOrImport")),1)]),_:1}),t.createVNode(S,{type:"primary",class:"text-white e2e-open-presets",onClick:C[3]||(C[3]=V=>t.unref(e).give("presets"))},{default:t.withCtx(()=>[t.createTextVNode(" Пресеты ")]),_:1})])]),t.createElementVNode("div",nl,[t.createElementVNode("label",null,[t.createElementVNode("b",null,t.toDisplayString(b.$t("general.mapName")),1),t.createVNode(G,{modelValue:t.unref(h).settings.title,"onUpdate:modelValue":C[4]||(C[4]=V=>t.unref(h).settings.title=V)},null,8,["modelValue"])])]),t.createElementVNode("div",rl,[t.createElementVNode("a",il,t.toDisplayString(b.$t("general.githubRepo")),1)])]),t.createElementVNode("div",ol,[t.createVNode(S,{class:"TheSettings-Button",type:"success",onClick:C[5]||(C[5]=V=>u())},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(b.$t("general.save")),1)]),_:1}),t.createVNode(S,{class:"TheSettings-Button",onClick:f},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(b.$t("general.cancel")),1)]),_:1}),t.createVNode(S,{class:"TheSettings-Button",type:"danger",onClick:C[6]||(C[6]=V=>{t.unref(n).give(t.unref(m)),f()})},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(b.$t("general.removeMap")),1)]),_:1})])])):t.createCommentVNode("",!0)]}),_:1}))}}),cl={},ll={class:"BaseGroup"};function dl(i,e){return t.openBlock(),t.createElementBlock("div",ll,[t.renderSlot(i.$slots,"default")])}const hl=Ee(cl,[["render",dl]]),pl="default",ml=t.defineComponent({__name:"TheLinker",setup(i){const{mapObjectsLink:e}=j(),s=e.objectIds(new x([])).ref();return(n,r)=>(t.openBlock(),t.createBlock(S,{type:pl,onClick:r[0]||(r[0]=o=>t.unref(e).startLink())},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(t.unref(s).length===1?"Выбиретие объект":t.unref(s).length===2?"Второй объект":"Связать объекты"),1)]),_:1}))}}),ul={class:"flex e2e-sidebar flex-col items-center gap-3 max-h-[100%] overflow-hidden"},fl={class:"TheSideBar-ItemName"},gl=["innerHTML","draggable","title","onDragend","onDblclick"],yl={key:0,class:"flex gap-1"},wl={key:0,class:"mt-auto w-full p-3 pt-0"},Al=t.defineComponent({__name:"TheSideBar",setup(i){const{mapObjectNew:e,mapCurrent:s,mapTypeCurrent:n,mapTypeRemoved:r,mapTypeNew:o,modal:a,settings:l,sidebarDraggable:c}=j(),p=s.types(new x).ref(),d=t.ref();t.onMounted(()=>{c.give(d.value)});const{svgMapTypeImage:h}=H(),m=t.computed(()=>{var u;return(u=p.value)==null?void 0:u.map(A=>({type:A,image:h.create(A).markup()})).sort((A,g)=>+(A.type.name>=g.type.name))}),f=new x;return l.value(f),(u,A)=>(t.openBlock(),t.createElementBlock("div",ul,[t.createElementVNode("div",{ref_key:"dragWrapperRef",ref:d,class:"flex flex-col gap-3 flex-grow w-full overflow-y-auto"},[(t.openBlock(!0),t.createElementBlock(t.Fragment,null,t.renderList(m.value,(g,b)=>(t.openBlock(),t.createElementBlock("div",{key:b,class:"flex flex-col items-center justify-center gap-2"},[t.createElementVNode("div",fl,t.toDisplayString(g.type.name),1),t.createElementVNode("div",{innerHTML:g.image,class:"TheSideBar-ItemImage",draggable:t.unref(f).value.readonly?"false":"true",style:t.normalizeStyle(`width:${g.type.width}px;height:${g.type.height}px`),title:u.$t("general.notifications.dragToCanvasToAdd"),onDragend:C=>t.unref(e).byTypeName(g.type.id,C),onDblclick:C=>{t.unref(e).byTypeName(g.type.id,C),u.$emit("close")}},null,44,gl),t.unref(f).value.readonly?t.createCommentVNode("",!0):(t.openBlock(),t.createElementBlock("div",yl,[t.createVNode(S,{class:"text-white",size:"sm",type:"primary",onClick:C=>t.unref(n).give(g.type.id)},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(u.$t("general.change")),1)]),_:2},1032,["onClick"]),t.createVNode(S,{class:"text-white",size:"sm",type:"danger",onClick:C=>t.unref(r).give(g.type)},{default:t.withCtx(()=>[t.createTextVNode(t.toDisplayString(u.$t("general.delete")),1)]),_:2},1032,["onClick"])]))]))),128))],512),t.unref(f).value.readonly?t.createCommentVNode("",!0):(t.openBlock(),t.createElementBlock("div",wl,[t.createVNode(hl,{class:"mb-1 grid gap-1 grid-cols-2"},{default:t.withCtx(()=>[t.createVNode(S,{title:u.$t("general.addType"),type:"success",onClick:A[0]||(A[0]=g=>t.unref(o).byName())},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-plus-square"})]),_:1},8,["title"]),t.createVNode(S,{class:"e2e-show-settings",title:u.$t("general.settings"),type:"primary",onClick:A[1]||(A[1]=g=>t.unref(a).give("settings"))},{default:t.withCtx(()=>[t.createVNode(R,{icon:"fa-cog"})]),_:1},8,["title"])]),_:1}),t.createVNode(ml,{class:"w-[100%] block mb-1"})]))]))}});class bl{constructor(e,s,n=!1){this.basePatron=e,this.guest=s,this.refWatcherCreated=n}ref(){return this.basePatron.ref()}get value(){return this.basePatron.value}introduction(){return this.basePatron.introduction()}give(e){return this.basePatron.give(e),this.refWatcherCreated||(this.refWatcherCreated=!0,t.watch(this.basePatron.ref(),s=>{s&&this.guest.give(s)},{deep:!0})),this}}class Cl{constructor(e){this.baseSource=e}value(e){return this.baseSource.value(new O(e,s=>{I(JSON.stringify(s),e)})),this}give(e){return this.value(s=>{e!==s&&this.baseSource.give(JSON.parse(e))}),this}pool(){return this.baseSource.pool()}}class xl{constructor(e,s){this.baseGuest=e,this.baseGuestAware=s}value(e){return this.baseGuestAware.value(e),this}give(e){return I(e,this.baseGuest),this}pool(){throw Error("No pool in SourceDynamic")}}const kl={class:"AppPresets"},_l=t.createElementVNode("div",{class:"text-md font-bold mb-2"},"Экспорт\\Импорт текущей карты",-1),Bl={class:"flex flex-col gap-2"},Nl=t.defineComponent({__name:"AppExport",setup(i){const{mapFile:e,mapCurrent:s}=j(),n=new xl(s,new ae(l=>{e.currentMap(new Ae(l))})),r=new Cl(n),o=new bl(new x,r);r.value(o);const a=o.ref();return(l,c)=>(t.openBlock(),t.createBlock(oe,{name:"export"},{default:t.withCtx(()=>[t.createElementVNode("div",kl,[_l,t.createElementVNode("div",Bl,[t.createVNode(Jt,{modelValue:t.unref(a),"onUpdate:modelValue":c[0]||(c[0]=p=>t.isRef(a)?a.value=p:null)},null,8,["modelValue"])])])]),_:1}))}}),Vl={class:"absolute bg-body hover:bg-border cursor-pointer border-solid border-border bottom-[150px] right-3 p-3 w-15 h-15"},$l=t.defineComponent({__name:"TheSidebarButton",setup(i){return(e,s)=>(t.openBlock(),t.createElementBlock("div",Vl,[t.createVNode(R,{icon:"fa-bars-staggered"})]))}}),Sl=t.defineComponent({__name:"TheSharingButton",setup(i){const{sharedFile:e}=He();return(s,n)=>(t.openBlock(),t.createElementBlock("div",{class:"absolute bg-body hover:bg-border cursor-pointer border-solid border-border bottom-[150px] right-[60px] p-3 w-15 h-15",onClick:n[0]||(n[0]=r=>t.unref(e).do())},[t.createVNode(R,{icon:"fa-share-nodes"})]))}});class Fl{value(e){if(!navigator.share||!navigator.canShare)return I(!1,e),this;const n={files:[new File(["foo"],"foo.txt",{type:"text/plain"})]};return I(navigator.canShare(n),e),this}}const El={class:"bg-body absolute top-0 left-0 w-full h-full"},Tl=t.defineComponent({__name:"PatronSchemeEditor",props:{modelValue:{type:String,required:!0},readonly:{type:Boolean,default:!1},presets:{type:Object,default:()=>({})}},emits:["update:modelValue"],setup(i,{emit:e}){const s=i,n=e,{fileContent:r,settings:o,device:a}=j(),{guest:l,patron:c}=H();o.value(f=>{o.give({...f,readonly:s.readonly,presets:s.presets})}),t.watch(()=>s.modelValue,f=>{r.value(l.create(u=>{f!==u&&r.give(f)}))},{immediate:!0}),r.value(c.create(f=>{n("update:modelValue",f)}));const p=t.ref(!0),d=new x;a.value(d),a.value(new Re(f=>{p.value=f.isDesktop}));const h=new Fl,m=new x;return h.value(m),(f,u)=>(t.openBlock(),t.createElementBlock("div",El,[t.createElementVNode("div",{class:t.normalizeClass(["grid grid-rows-[50px_1fr] h-dvh relative",{"grid-cols-[200px_1fr]":!t.unref(d).value.isMobile,"grid-cols-[1fr]":t.unref(d).value.isMobile}])},[t.createVNode(zc,{class:"col-span-2"}),p.value?(t.openBlock(),t.createBlock(Al,{key:0,class:t.normalizeClass({"bg-[#f3f4f6] w-[200px] absolute top-[50px] left-0 z-10 bottom-0":t.unref(d).value.isMobile}),onClose:u[0]||(u[0]=A=>p.value=!1)},null,8,["class"])):t.createCommentVNode("",!0),t.createVNode(Mc,{class:"w-auto col-auto h-full"}),t.createVNode(Yc),t.unref(m).value?(t.openBlock(),t.createBlock(Sl,{key:1})):t.createCommentVNode("",!0),t.unref(d).value.isMobile?(t.openBlock(),t.createBlock($l,{key:2,onClick:u[1]||(u[1]=A=>p.value=!p.value)})):t.createCommentVNode("",!0)],2),t.createVNode(ac),t.createVNode(mc),t.createVNode(al),t.createVNode(ya),t.createVNode(Ta),t.createVNode(Nl),t.createVNode(ia),t.createVNode(qc),t.createVNode(Na),t.createVNode(Xo)]))}}),Yt=B.debug("FileSystemContent");class Ml{constructor(e,s,n){w(this,"contentPatrons");w(this,"fileHandler",null);w(this,"contentSource");this.launchQueue=e,this.notification=s,this.factories=n,this.contentPatrons=n.pool.create(this),this.contentSource=n.sourceEmpty.create()}content(e){const s=this.factories.guest.create(n=>{this.fileHandler=n,this.factories.fileHandlerContent.create(n).content(this.factories.guest.create(r=>{this.contentPatrons.distribute(r,e),this.contentSource.give(r)}))});return this.fileHandler||this.launchQueue.fileHandler(s),this.contentSource.value(e),this}give(e){if(Yt("save file as content string",e),!this.fileHandler)throw new de("Cant save file because no fileHandler");try{return this.contentSource.give(e),this.factories.browserFileSaved.create(this.fileHandler).save(e),this.contentPatrons.give(e),this}catch(s){throw new de("Cant handle receive for map file FS",{cause:s})}finally{this.notification.give({type:"success",text:"Успешно сохранен файл карты!"})}}canBeUsed(e){const s="launchQueue"in window;Yt("can be used",s);const n=window&&window.matchMedia("(display-mode: standalone)");return e.give(s&&n.matches),e}}const Me=B.debug("FirstPossibleFileContent");class Il{constructor(e,s){w(this,"firstPossibleFileContent",null);w(this,"contentSource",new se);w(this,"canBeUsedSource",new se);Me("length",e.length),e.forEach(n=>{n.canBeUsed(s.patronOnce.create(s.guest.create(r=>{Me("canbeused result",n,r),r&&!this.firstPossibleFileContent&&(this.firstPossibleFileContent=n,n.canBeUsed(s.patron.create(this.canBeUsedSource)),n.content(s.patron.create(this.contentSource)),this.contentSource.value(s.patron.create(o=>{n.content(s.guest.create(a=>{o!==a&&n.give(o)}))})))})))})}canBeUsed(e){return Me("can be used to",this.firstPossibleFileContent),this.canBeUsedSource.value(e),e}content(e){return Me("content to",this.firstPossibleFileContent),this.contentSource.value(e),this}give(e){return this.contentSource.give(e),this}}const st=B.debug("UrlContent");class jl{constructor(e,s){w(this,"contentCache");this.notification=e,this.factories=s,this.contentCache=s.sourceEmpty.create()}canBeUsed(e){if(!window)return e.give(!1),this;const s=window.location.search.indexOf("?view=")>-1;if(st("can be used",s),e.give(window.location.search.indexOf("?view=")>-1),s){const n=window.location.search.split("=")[1]??"";fetch(n,{redirect:"follow"}).then(r=>r.text()).then(r=>{st("received text",r),this.contentCache.give(r)})}return e}content(e){if(!window)return this;const s=window.location.search.split("=")[1]??"";return st("visit url",s),this.contentCache.value(this.factories.patronOnce.create(e)),this}give(){return this.notification.give({type:"error",text:"Невозможно сохранить карту, открытую по ссылке!"}),this}}const Zt=new se;class Dl{constructor(e=window.launchQueue,s="launchQueue"in window){w(this,"isCalculated",!1);this.launchQueue=e,this.isLaunchQueueSupported=s}fileHandler(e){return this.isLaunchQueueSupported&&!this.isCalculated&&(this.isCalculated=!0,this.launchQueue.setConsumer(s=>{if(s.files&&s.files.length){const[n]=s.files;Zt.give(n)}})),Zt.value(e),this}}$.BrowserLaunchQueue=Dl,$.FileSystemContent=Ml,$.FirstPossibleFileContent=Il,$.PatronSchemeEditor=Tl,$.StorageRecord=ct,$.UrlContent=jl,$.VueRefPatron=x,$.useApplication=j,$.useFactories=H,$.useSharing=He,Object.defineProperty($,Symbol.toStringTag,{value:"Module"})});
